<html>

<head>
    <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>
    Activiti学习笔记 | F嘉阳
</title>
<link rel="shortcut icon" href="https://fjiayang.github.io//favicon.ico?v=1579680076209">
<!-- <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous"> -->
<link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://fjiayang.github.io//styles/main.css">
<!-- js -->
<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
<script src="https://fjiayang.github.io//media/js/jquery.sticky-sidebar.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/moment.js/2.23.0/moment.min.js"></script>


        
</head>

<body>
    <div class="main">
        <div class="header">
    <div class="nav">
        <div class="logo">
            <a href="https://fjiayang.github.io/">
                <img class="avatar" src="https://fjiayang.github.io//images/avatar.png?v=1579680076209" alt="">
            </a>
            <div class="site-title">
                <h1>
                    F嘉阳
                </h1>
            </div>
        </div>
        <span class="menu-btn fa fa-align-justify"></span>
        <div class="menu-container">
            <ul>
                
                    
                            <li>
                                <a href="/" class="menu">
                                    首页
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/archives" class="menu">
                                    归档
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/tags" class="menu">
                                    标签
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/post/about" class="menu">
                                    关于
                                </a>
                            </li>
                            
                                
            </ul>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        $(".menu-btn").click(function() {
            $(".menu-container").slideToggle();
        });
        $(window).resize(function() {

            if (window.matchMedia('(min-width: 960px)').matches) {
                $(".menu-container").css('display', 'block')
            } else {
                $(".menu-container").css('display', 'none')
            }

        });
    });
</script>

            <div id="main-content" class="post-detail main-container">
                <!-- left -->
                <div id="content" class="main-container-left">
                    <article class="post i-card">
                        <h2 class="post-title">
                            Activiti学习笔记
                        </h2>
                        <div class="post-info">
                            <time class="post-time">2019-08-10</time>
                            
                                <a href="https://fjiayang.github.io//tag/Mow53-pMY" class="post-tag i-tag
                            i-tag-error">
                            #工作流
                        </a>
                                
                                <a href="https://fjiayang.github.io//tag/VwGnvPo1M" class="post-tag i-tag
                            i-tag-other_2">
                            #学习
                        </a>
                                
                        </div>
                        
                                <div class="post-content">
                                    <h2 id="概览">概览</h2>
<h3 id="流程引擎配置">流程引擎配置</h3>
<p>配置核心为<code>ProcessEnigne</code>，可获取各种<code>Service</code></p>
<!-- more -->
<pre><code class="language-mermaid">graph LR
    A[activiti.cfg.xml] --&gt; B[ProcessEnigneConfiguration] 
    B --&gt; C[ProcessEnigne]
    C --&gt; D[RepositoryService]
    C --&gt; E[RuntimeService]
    C --&gt; F[xxxService]
</code></pre>
<h3 id="核心api">核心<code>API</code></h3>
<ol>
<li><code>RepositoryService</code> 负责对流程定义文件管理，操作静态文件<code>xml</code>、图片等。其中涉及两个实体对象：部署对象和资源对象，两者关系为一对多，即一次部署可以有多个资源对象</li>
<li><code>RuntimeService</code>实现对流程的控制，如启动、暂停、挂起等，可以查询进行中的流程实例和对象以及操作流程中的上下文数据</li>
<li><code>TaskService</code>操作人工任务，增删改查等</li>
<li><code>IdentityService</code>操作用户和用户组并维护用户组的关系</li>
<li><code>FormServcie</code>操作和渲染输入表单数据</li>
<li><code>HistoryService</code>查询运行结束的流程实例</li>
<li><code>ManagemenetService</code>对流程引擎进行基础管理，如定时任务Job等</li>
<li><code>DynamicBpmServcie</code>可以动态的对流程进行修改，<strong>侵入性较高</strong></li>
</ol>
<h3 id="数据模型设计">数据模型设计</h3>
<p><a href="https://www.activiti.org/userguide/">官方文档</a></p>
<table>
<thead>
<tr>
<th>数据表分类</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ACT_RE_*</code></td>
<td>RE代表repository。具有此前缀的表包含静态信息，例如<strong>流程定义</strong>和流程资源（图像，规则等）。</td>
</tr>
<tr>
<td><code>ACT_RU_*</code></td>
<td>RU代表runtime。这些是包含流程实例，用户任务，变量，作业等的<strong>运行时</strong>数据的运行时表.<code>Activiti</code>仅在流程实例执行期间存储运行时数据，并在流程实例结束时删除记录。这使运行时表保持小而快。</td>
</tr>
<tr>
<td><code>ACT_ID_*</code></td>
<td>ID代表identity。这些表包含<strong>身份信息</strong>，例如用户，组等。</td>
</tr>
<tr>
<td><code>ACT_HI_*</code></td>
<td>HI代表history。这些是包含<strong>历史数据</strong>的表，例如过去的流程实例，变量，任务等。</td>
</tr>
<tr>
<td><code>ACT_GE_*</code></td>
<td>general数据，<strong>通用</strong>数据表，用于各种用例。</td>
</tr>
</tbody>
</table>
<h3 id="bpmn-20"><code>BPMN</code> 2.0</h3>
<h4 id="简介">简介</h4>
<p><code>BPMN2.0</code>（Business Process Model and Notation）</p>
<ul>
<li>是一套<strong>业务流程模型与符号</strong>建模标准</li>
<li>精准的执行语义来描述元素的操作</li>
<li>以XML为载体，以符号可视化业务</li>
</ul>
<h4 id="符号">符号</h4>
<figure data-type="image" tabindex="1"><img src="https://fjy8018.gitee.io/images/img/1564993787289.png" alt="1564993787289"></figure>
<figure data-type="image" tabindex="2"><img src="https://fjy8018.gitee.io/images/img/20190108153521118.png" alt="img"></figure>
<h3 id="快速部署">快速部署</h3>
<ol>
<li>
<p>从官方仓库下载<code>Activiti6.0</code></p>
<p><a href="https://github.com/Activiti/Activiti/releases/tag/activiti-6.0.0">官方仓库</a></p>
</li>
<li>
<p>下载Tomcat</p>
</li>
<li>
<p>安装<code>JDK 8</code></p>
</li>
<li>
<p>将<code>activiti</code>压缩包内的<code>activiti-app.war</code>和<code>activiti-admin.war</code>放入Tomcat的<code>webapps</code>路径下</p>
</li>
<li>
<p>启动Tomcat</p>
</li>
<li>
<p>访问 http://localhost:8080/activiti-app 即可</p>
</li>
</ol>
<p>默认用户名：<code>admin</code> 密码：<code>test</code></p>
<figure data-type="image" tabindex="3"><img src="https://fjy8018.gitee.io/images/img/1565161128933.png" alt="1565161128933"></figure>
<p>主页</p>
<figure data-type="image" tabindex="4"><img src="https://fjy8018.gitee.io/images/img/1565161278519.png" alt="1565161278519"></figure>
<h3 id="简单流程设计">简单流程设计</h3>
<h4 id="创建用户">创建用户</h4>
<figure data-type="image" tabindex="5"><img src="https://fjy8018.gitee.io/images/img/1565161481147.png" alt="1565161481147"></figure>
<figure data-type="image" tabindex="6"><img src="https://fjy8018.gitee.io/images/img/1565161503948.png" alt="1565161503948"></figure>
<figure data-type="image" tabindex="7"><img src="https://fjy8018.gitee.io/images/img/1565161546804.png" alt="1565161546804"></figure>
<figure data-type="image" tabindex="8"><img src="https://fjy8018.gitee.io/images/img/1565161604311.png" alt="1565161604311"></figure>
<h4 id="创建流程">创建流程</h4>
<figure data-type="image" tabindex="9"><img src="https://fjy8018.gitee.io/images/img/1565161632651.png" alt="1565161632651"></figure>
<figure data-type="image" tabindex="10"><img src="https://fjy8018.gitee.io/images/img/1565161651762.png" alt="1565161651762"></figure>
<figure data-type="image" tabindex="11"><img src="https://fjy8018.gitee.io/images/img/1565161697571.png" alt="1565161697571"></figure>
<p>自动进入流程绘制页面</p>
<figure data-type="image" tabindex="12"><img src="https://fjy8018.gitee.io/images/img/1565161758126.png" alt="1565161758126"></figure>
<figure data-type="image" tabindex="13"><img src="https://fjy8018.gitee.io/images/img/1565162083720.png" alt="1565162083720"></figure>
<h4 id="配置用户状态">配置用户状态</h4>
<figure data-type="image" tabindex="14"><img src="https://fjy8018.gitee.io/images/img/1565162104371.png" alt="1565162104371"></figure>
<figure data-type="image" tabindex="15"><img src="https://fjy8018.gitee.io/images/img/1565162142668.png" alt="1565162142668"></figure>
<p>第二级同理</p>
<figure data-type="image" tabindex="16"><img src="https://fjy8018.gitee.io/images/img/1565162183277.png" alt="1565162183277"></figure>
<h4 id="保存模型">保存模型</h4>
<figure data-type="image" tabindex="17"><img src="https://fjy8018.gitee.io/images/img/1565162285114.png" alt="1565162285114"></figure>
<p>选择保存并关闭</p>
<figure data-type="image" tabindex="18"><img src="https://fjy8018.gitee.io/images/img/1565162309465.png" alt="1565162309465"></figure>
<p>结果</p>
<figure data-type="image" tabindex="19"><img src="https://fjy8018.gitee.io/images/img/1565162323634.png" alt="1565162323634"></figure>
<h4 id="创建应用">创建应用</h4>
<figure data-type="image" tabindex="20"><img src="https://fjy8018.gitee.io/images/img/1565162363859.png" alt="1565162363859"></figure>
<figure data-type="image" tabindex="21"><img src="https://fjy8018.gitee.io/images/img/1565162441386.png" alt="1565162441386"></figure>
<p>选择包含的流程</p>
<figure data-type="image" tabindex="22"><img src="https://fjy8018.gitee.io/images/img/1565162487324.png" alt="1565162487324"></figure>
<figure data-type="image" tabindex="23"><img src="https://fjy8018.gitee.io/images/img/1565162523332.png" alt="1565162523332"></figure>
<figure data-type="image" tabindex="24"><img src="https://fjy8018.gitee.io/images/img/1565162578195.png" alt="1565162578195"></figure>
<figure data-type="image" tabindex="25"><img src="https://fjy8018.gitee.io/images/img/1565162594807.png" alt="1565162594807"></figure>
<p>选择保存并发布</p>
<figure data-type="image" tabindex="26"><img src="https://fjy8018.gitee.io/images/img/1565162685610.png" alt="1565162685610"></figure>
<p>结果</p>
<figure data-type="image" tabindex="27"><img src="https://fjy8018.gitee.io/images/img/1565162646248.png" alt="1565162646248"></figure>
<p>首页已经包含新的模块</p>
<figure data-type="image" tabindex="28"><img src="https://fjy8018.gitee.io/images/img/1565162723645.png" alt="1565162723645"></figure>
<h3 id="简单流程执行">简单流程执行</h3>
<h4 id="发起流程">发起流程</h4>
<p>登出并使用普通用户登陆</p>
<figure data-type="image" tabindex="29"><img src="https://fjy8018.gitee.io/images/img/1565162880619.png" alt="1565162880619"></figure>
<h4 id="启动流程">启动流程</h4>
<figure data-type="image" tabindex="30"><img src="https://fjy8018.gitee.io/images/img/1565163030609.png" alt="1565163030609"></figure>
<p>流程启动成功，可以添加描述</p>
<figure data-type="image" tabindex="31"><img src="https://fjy8018.gitee.io/images/img/1565163171316.png" alt="1565163171316"></figure>
<h4 id="审批">审批</h4>
<p>切换用户TL查看代办任务，点击<code>Claim</code>获取</p>
<figure data-type="image" tabindex="32"><img src="https://fjy8018.gitee.io/images/img/1565163259651.png" alt="1565163259651"></figure>
<p>添加备注</p>
<figure data-type="image" tabindex="33"><img src="https://fjy8018.gitee.io/images/img/1565163317427.png" alt="1565163317427"></figure>
<p>此时用户登陆可以看到当前的流程进度</p>
<figure data-type="image" tabindex="34"><img src="https://fjy8018.gitee.io/images/img/1565163401003.png" alt="1565163401003"></figure>
<p>切换用户HR执行相同操作即可</p>
<h4 id="流程结束">流程结束</h4>
<p>流程结束后所有用户都无法查看到该流程，可以通过访问http://localhost:8080/activiti-admin 查看</p>
<p>用户名：<code>admin</code>，密码：<code>admin</code></p>
<figure data-type="image" tabindex="35"><img src="https://fjy8018.gitee.io/images/img/1565163574150.png" alt="1565163574150"></figure>
<figure data-type="image" tabindex="36"><img src="https://fjy8018.gitee.io/images/img/1565163674835.png" alt="1565163674835"></figure>
<p>如果端口号识别有误可以手动修改并检测</p>
<figure data-type="image" tabindex="37"><img src="https://fjy8018.gitee.io/images/img/1565163729089.png" alt="1565163729089"></figure>
<p>管理端可以查看历史流程执行信息</p>
<h2 id="核心模块分析">核心模块分析</h2>
<p>克隆官方源码</p>
<p><a href="https://github.com/Activiti/Activiti.git">源码地址</a></p>
<p>切换为<code>6.0.0</code>分支</p>
<pre><code class="language-bash">$ git checkout -b study6 activiti-6.0.0
Checking out files: 100% (13850/13850), done.
Switched to a new branch 'study6'
</code></pre>
<p>编译</p>
<pre><code class="language-bash">$ mvn clean test-compile
</code></pre>
<figure data-type="image" tabindex="38"><img src="https://fjy8018.gitee.io/images/img/1565165182015.png" alt="1565165182015"></figure>
<h3 id="核心模块">核心模块</h3>
<ul>
<li><code>modules/activiti-engine</code> 核心引擎</li>
<li><code>modules/activiti-spring</code> Spring集成模块</li>
<li><code>modules/activiti-spring-boot</code> <code>SpringBoot</code>集成模块</li>
<li><code>modules/activiti-rest</code> 对外提供<code>rest api</code>模块</li>
<li><code>modules/activiti-form-engine</code> 表单引擎模块</li>
<li><code>modules/activiti-ldap</code> 集成<code>LDAP</code>用户的模块</li>
</ul>
<p><code>activiti-engine</code>模块依赖图</p>
<figure data-type="image" tabindex="39"><img src="https://fjy8018.gitee.io/images/img/activiti-engine.png" alt="activiti-engine"></figure>
<h3 id="基于源码运行activiti-app">基于源码运行<code>Activiti App</code></h3>
<h4 id="模块结构图">模块结构图</h4>
<figure data-type="image" tabindex="40"><img src="https://fjy8018.gitee.io/images/img/activiti-ui-root.png" alt="activiti-ui-root"></figure>
<h4 id="模块功能">模块功能</h4>
<ul>
<li><code>activiti-app-logic</code> UI的业务逻辑</li>
<li><code>activiti-app-rest</code> 提供接口的Rest Api</li>
<li><code>activiti-app-conf</code> UI独立于业务外的配置</li>
<li><code>activiti-app</code> 集成发布的WAR工程（无Java代码）</li>
</ul>
<h4 id="启动">启动</h4>
<p>进入App模块</p>
<pre><code class="language-bash">$ cd modules/activiti-ui/activiti-app
</code></pre>
<p>启动</p>
<pre><code class="language-bash">$ mvn clean tomcat7:run
</code></pre>
<p>这种方式启动默认端口为<code>9999</code></p>
<figure data-type="image" tabindex="41"><img src="https://fjy8018.gitee.io/images/img/1565169212659.png" alt="1565169212659"></figure>
<p>或者执行<code>start-jrebel.sh</code>可以支持热部署</p>
<h2 id="源码分析">源码分析</h2>
<h3 id="webconfigurer源码"><code>WebConfigurer</code>源码</h3>
<p>在<code>\modules\activiti-ui\activiti-app\src\main\webapp\WEB-INF\web.xml</code>中包含<code>Servlet</code>配置类<code>WebConfigurer</code>，其实现了<code>Servlet</code>监听器<code>ServletContextListener</code></p>
<pre><code class="language-java">package org.activiti.app.servlet;

public class WebConfigurer implements ServletContextListener {
	
    private final Logger log = LoggerFactory.getLogger(WebConfigurer.class);

    public AnnotationConfigWebApplicationContext context;
    
    public void setContext(AnnotationConfigWebApplicationContext context) {
        this.context = context;
    }
    
    @Override
    public void contextInitialized(ServletContextEvent sce) {
        log.debug(&quot;Configuring Spring root application context&quot;);
		// Servlet容器初始化
        ServletContext servletContext = sce.getServletContext();
		// Spring容器初始化
        AnnotationConfigWebApplicationContext rootContext = null;
        
        if (context == null) {
            rootContext = new AnnotationConfigWebApplicationContext();
            // 注册根容器应用配置
            rootContext.register(ApplicationConfiguration.class);
            // 将Spring容器于Servlet容器进行双向绑定
            if (rootContext.getServletContext() == null) {
              // Spring 容器注入Servlet容器
              rootContext.setServletContext(servletContext);
            }
            
            rootContext.refresh();
            context = rootContext;
            
        } else {
            rootContext = context;
            if (rootContext.getServletContext() == null) {
              rootContext.setServletContext(servletContext);
            }
        }
        // Servlet 容器作为属性注入 Spring容器
 servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, rootContext);

        EnumSet&lt;DispatcherType&gt; disps = EnumSet.of(DispatcherType.REQUEST, DispatcherType.FORWARD, DispatcherType.ASYNC);
		// Spring初始化
        initSpring(servletContext, rootContext);
        // 安全相关初始化
        initSpringSecurity(servletContext, disps);

        log.debug(&quot;Web application fully configured&quot;);
    }

    /**
     * 基于Servlet 3.0规范 通过编码方式注入Servlet配置
     */
    private void initSpring(ServletContext servletContext, AnnotationConfigWebApplicationContext rootContext) {
        log.debug(&quot;Configuring Spring Web application context&quot;);
        // 注册子容器1 AppDispatcherServlet
        AnnotationConfigWebApplicationContext appDispatcherServletConfiguration = new AnnotationConfigWebApplicationContext();
        // 绑定父容器
        appDispatcherServletConfiguration.setParent(rootContext);
        appDispatcherServletConfiguration.register(AppDispatcherServletConfiguration.class);

        log.debug(&quot;Registering Spring MVC Servlet&quot;);
        // 绑定配置
        ServletRegistration.Dynamic appDispatcherServlet = servletContext.addServlet(&quot;appDispatcher&quot;, 
                new DispatcherServlet(appDispatcherServletConfiguration));
        // 设置映射
        appDispatcherServlet.addMapping(&quot;/app/*&quot;);
        appDispatcherServlet.setLoadOnStartup(1);
        // 开启异步支持
        appDispatcherServlet.setAsyncSupported(true);

        log.debug(&quot;Registering Activiti public REST API&quot;);
        
        // 注册子容器2 ApiDispatcherServlet
        AnnotationConfigWebApplicationContext apiDispatcherServletConfiguration = new AnnotationConfigWebApplicationContext();
        // 绑定父容器
        apiDispatcherServletConfiguration.setParent(rootContext);
        apiDispatcherServletConfiguration.register(ApiDispatcherServletConfiguration.class);
		// 绑定配置
        ServletRegistration.Dynamic apiDispatcherServlet = servletContext.addServlet(&quot;apiDispatcher&quot;,
                new DispatcherServlet(apiDispatcherServletConfiguration));
        // 设置映射
        apiDispatcherServlet.addMapping(&quot;/api/*&quot;);
        apiDispatcherServlet.setLoadOnStartup(1);
        // 开启异步支持
        apiDispatcherServlet.setAsyncSupported(true);
    }
    
    private void initSpringSecurity(ServletContext servletContext, EnumSet&lt;DispatcherType&gt; disps) {...}

    @Override
    public void contextDestroyed(ServletContextEvent sce) {...}
}
</code></pre>
<p>容器结构图</p>
<pre><code class="language-mermaid">graph TD
    A[rootContext] --&gt; B[AppDispatcherServlet] 
    A --&gt; C[ApiDispatcherServlet]
</code></pre>
<h3 id="applicationconfiguration源码"><code>ApplicationConfiguration</code>源码</h3>
<p>该类为应用配置类，注册为Spring配置类，并指定了配置资源文件和包扫描路径，其中源码中标明了<code>activiti-app.properties</code>允许不存在，说明<code>Activiti</code>包含了规约配置也允许用户覆盖默认配置</p>
<pre><code class="language-java">package org.activiti.app.conf;

import org.springframework.context.annotation.*;
import org.springframework.context.support.PropertySourcesPlaceholderConfigurer;

@Configuration
@PropertySources({
	
	@PropertySource(&quot;classpath:/META-INF/activiti-app/activiti-app.properties&quot;),
	@PropertySource(value = &quot;classpath:activiti-app.properties&quot;, ignoreResourceNotFound = true),
	@PropertySource(value = &quot;file:activiti-app.properties&quot;, ignoreResourceNotFound = true),

})
@ComponentScan(basePackages = {
        &quot;org.activiti.app.conf&quot;,
        &quot;org.activiti.app.repository&quot;,
        &quot;org.activiti.app.service&quot;,
        &quot;org.activiti.app.security&quot;,
        &quot;org.activiti.app.model.component&quot;})
public class ApplicationConfiguration {
	@Bean
    public static PropertySourcesPlaceholderConfigurer propertySourcesPlaceholderConfigurer() {
        return new PropertySourcesPlaceholderConfigurer();
    }
}
</code></pre>
<h3 id="appdispatcherservletconfiguration源码"><code>AppDispatcherServletConfiguration</code>源码</h3>
<p>该类为根容器<code>Servlet</code>配置Bean，该类仅扫描<code>Rest</code>包，主要实现请求数据处理</p>
<pre><code class="language-java">package org.activiti.app.servlet;

@Configuration
@ComponentScan(value = {&quot;org.activiti.app.rest&quot;})
@EnableAsync
public class AppDispatcherServletConfiguration extends WebMvcConfigurationSupport {

    private final Logger log = LoggerFactory.getLogger(AppDispatcherServletConfiguration.class);

    @Inject
    private ObjectMapper objectMapper;
    
    @Inject
    private Environment environment;

    @Bean
    public SessionLocaleResolver localeResolver() {
        return new SessionLocaleResolver();
    }

    @Bean
    public LocaleChangeInterceptor localeChangeInterceptor() {
        // 配置本地化
        log.debug(&quot;Configuring localeChangeInterceptor&quot;);
        LocaleChangeInterceptor localeChangeInterceptor = new LocaleChangeInterceptor();
        localeChangeInterceptor.setParamName(&quot;language&quot;);
        return localeChangeInterceptor;
    }

    @Bean
    public MultipartResolver multipartResolver() {
        // 文件上传配置
        CommonsMultipartResolver multipartResolver = new CommonsMultipartResolver();
        multipartResolver.setMaxUploadSize(environment.getProperty(&quot;file.upload.max.size&quot;, Long.class));
        return multipartResolver;
    }

    @Bean
    public RequestMappingHandlerMapping requestMappingHandlerMapping() {
        // Spring 请求处理器
        log.debug(&quot;Creating requestMappingHandlerMapping&quot;);
        RequestMappingHandlerMapping requestMappingHandlerMapping = new RequestMappingHandlerMapping();
        // 禁用后缀匹配
        requestMappingHandlerMapping.setUseSuffixPatternMatch(false);
        // 保留原本的URL
        requestMappingHandlerMapping.setRemoveSemicolonContent(false);
        Object[] interceptors = {localeChangeInterceptor()};
        requestMappingHandlerMapping.setInterceptors(interceptors);
        return requestMappingHandlerMapping;
    }
    
    @Override
    public void configureMessageConverters(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters) {
        addDefaultHttpMessageConverters(converters);
        for (HttpMessageConverter&lt;?&gt; converter: converters) {
            // 序列化
            if (converter instanceof MappingJackson2HttpMessageConverter) {
                MappingJackson2HttpMessageConverter jackson2HttpMessageConverter = (MappingJackson2HttpMessageConverter) converter;
                jackson2HttpMessageConverter.setObjectMapper(objectMapper);
                break;
            }
        }
    }
}
</code></pre>
<h3 id="利用源码工具创建maven脚手架">利用源码工具创建Maven脚手架</h3>
<p>路径<code>\tooling\archetypes\activiti-archetype-unittest</code></p>
<p>目录结构</p>
<figure data-type="image" tabindex="42"><img src="https://fjy8018.gitee.io/images/img/1565256033481.png" alt="1565256033481"></figure>
<p>进入<code>archetypes</code>目录通过命令安装即可</p>
<pre><code class="language-bash">$ mvn clean install
</code></pre>
<p>默认不会在新建工程中显示，需要手动添加</p>
<figure data-type="image" tabindex="43"><img src="https://fjy8018.gitee.io/images/img/1565269010981.png" alt="1565269010981"></figure>
<p>填写版本信息</p>
<figure data-type="image" tabindex="44"><img src="https://fjy8018.gitee.io/images/img/1565269086172.png" alt="1565269086172"></figure>
<p>创建成功</p>
<figure data-type="image" tabindex="45"><img src="https://fjy8018.gitee.io/images/img/1565269108050.png" alt="1565269108050"></figure>
<p>通过脚手架创建工程</p>
<figure data-type="image" tabindex="46"><img src="https://fjy8018.gitee.io/images/img/1565269233697.png" alt="1565269233697"></figure>
<h2 id="通过编码方式设计流程">通过编码方式设计流程</h2>
<p>通过编码设计二级审批流程，基于命令行交互</p>
<h3 id="设计流程图">设计流程图</h3>
<p>使用在线BPMN绘图工具快速绘制</p>
<p><a href="https://demo.bpmn.io/">在线绘制地址</a></p>
<figure data-type="image" tabindex="47"><img src="https://fjy8018.gitee.io/images/img/1565186419979.png" alt="1565186419979"></figure>
<p>下载为<code>.bpmn</code>文件放入工程<code>resources</code>目录即可</p>
<p>推荐使用activiti 官方eclipse插件绘制</p>
<p><a href="https://www.activiti.org/designer/archived/activiti-designer-5.18.0.zip">Activiti-Designer下载地址</a></p>
<p>使用离线安装即可</p>
<p>创建流程图工程</p>
<figure data-type="image" tabindex="48"><img src="https://fjy8018.gitee.io/images/img/1565233095465.png" alt="1565233095465"></figure>
<p>绘制结果</p>
<figure data-type="image" tabindex="49"><img src="https://fjy8018.gitee.io/images/img/1565233256323.png" alt="1565233256323"></figure>
<h3 id="配置流程图">配置流程图</h3>
<p>配置需要填写的表单</p>
<figure data-type="image" tabindex="50"><img src="https://fjy8018.gitee.io/images/img/1565233931051.png" alt="1565233931051"></figure>
<figure data-type="image" tabindex="51"><img src="https://fjy8018.gitee.io/images/img/1565234119707.png" alt="1565234119707"></figure>
<p>配置判断表达式，语法为EL表达式</p>
<figure data-type="image" tabindex="52"><img src="https://fjy8018.gitee.io/images/img/1565234385214.png" alt="1565234385214"></figure>
<figure data-type="image" tabindex="53"><img src="https://fjy8018.gitee.io/images/img/1565234449742.png" alt="1565234449742"></figure>
<h3 id="创建工程">创建工程</h3>
<p>使用maven创建空工程</p>
<p>加入依赖配置</p>
<pre><code class="language-xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;!-- 流程引擎 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.activiti&lt;/groupId&gt;
        &lt;artifactId&gt;activiti-engine&lt;/artifactId&gt;
        &lt;version&gt;6.0.0&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;!-- 单元测试 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;junit&lt;/groupId&gt;
        &lt;artifactId&gt;junit&lt;/artifactId&gt;
        &lt;version&gt;4.11&lt;/version&gt;
        &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;!-- 日志 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;
        &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;
        &lt;version&gt;1.2.3&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;!-- 日志、实体类插件 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
        &lt;artifactId&gt;lombok&lt;/artifactId&gt;
        &lt;version&gt;1.18.2&lt;/version&gt;
        &lt;scope&gt;provided&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;!-- 工具类 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.google.guava&lt;/groupId&gt;
        &lt;artifactId&gt;guava&lt;/artifactId&gt;
        &lt;version&gt;23.0&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;!-- 内存数据库 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.h2database&lt;/groupId&gt;
        &lt;artifactId&gt;h2&lt;/artifactId&gt;
        &lt;version&gt;1.4.196&lt;/version&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>
<p>配置日志文件<code>logback.xml</code></p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;configuration scan=&quot;true&quot; scanPeriod=&quot;60 seconds&quot; debug=&quot;false&quot;&gt;
    &lt;!-- ConsoleAppender 控制台输出日志 --&gt;
    &lt;appender name=&quot;STDOUT&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;
        &lt;!-- 对日志进行格式化 --&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;%msg%n&lt;/pattern&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;logger name=&quot;top.fjy8018.activiti&quot; level=&quot;DEBUG&quot;/&gt;
    &lt;logger name=&quot;ch.qos.logback&quot; level=&quot;OFF&quot;/&gt;
    &lt;logger name=&quot;root&quot; level=&quot;ERROR&quot;/&gt;

    &lt;!-- root级别   WARN --&gt;
    &lt;root&gt;
        &lt;!-- 控制台输出 --&gt;
        &lt;appender-ref ref=&quot;STDOUT&quot;/&gt;
    &lt;/root&gt;
&lt;/configuration&gt;
</code></pre>
<p>拷贝写好的<code>.bpmn</code>文件到资源目录</p>
<figure data-type="image" tabindex="54"><img src="https://fjy8018.gitee.io/images/img/1565235724793.png" alt="1565235724793"></figure>
<h3 id="工程源码">工程源码</h3>
<p>启动类</p>
<pre><code class="language-java">package top.fjy8018.activiti.helloworld;

import com.google.common.collect.Maps;
import lombok.extern.slf4j.Slf4j;
import org.activiti.engine.*;
import org.activiti.engine.form.FormProperty;
import org.activiti.engine.form.TaskFormData;
import org.activiti.engine.impl.form.DateFormType;
import org.activiti.engine.impl.form.StringFormType;
import org.activiti.engine.repository.Deployment;
import org.activiti.engine.repository.DeploymentBuilder;
import org.activiti.engine.repository.ProcessDefinition;
import org.activiti.engine.runtime.ProcessInstance;
import org.activiti.engine.task.Task;

import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;
import java.util.Map;
import java.util.Scanner;

/**
 * 启动类
 *
 * @author F嘉阳
 * @date 2018/8/29 20:19
 */
@Slf4j
public class Main {

    public static void main(String[] args) throws ParseException {
        log.info(&quot;主程序启动&quot;);
        // 创建流程引擎
        ProcessEngine processEngine = getProcessEngine();

        // 部署流程定义文件
        ProcessDefinition processDefinition = getProcessDefinition(processEngine);

        // 启动流程
        ProcessInstance processInstance = getProcessInstance(processEngine, processDefinition);

        // 处理流程任务
        processTask(processEngine, processInstance);
        log.info(&quot;主程序结束&quot;);
    }

    /**
     * 处理流程任务
     *
     * @param processEngine
     * @param processInstance
     * @throws ParseException
     */
    private static void processTask(ProcessEngine processEngine, ProcessInstance processInstance) throws ParseException {
        // 处理控制台输入
        Scanner scanner = new Scanner(System.in);
        // 流程不为空且流程未结束
        while (processInstance != null &amp;&amp; !processInstance.isEnded()) {
            TaskService taskService = processEngine.getTaskService();
            // 列出所有任务
            List&lt;Task&gt; taskList = taskService.createTaskQuery().list();
            log.info(&quot;待处理任务数量 [{}]&quot;, taskList.size());
            for (Task task : taskList) {
                log.info(&quot;待处理任务 [{}]&quot;, task.getName());
                // 处理表单输入
                FormService formService = processEngine.getFormService();
                // 取出当前任务的表单信息
                TaskFormData taskFormData = formService.getTaskFormData(task.getId());
                // 取出属性值
                List&lt;FormProperty&gt; formProperties = taskFormData.getFormProperties();
                formProperties.forEach(e -&gt; log.info(&quot;属性值 {},类型 {}&quot;, e.getName(), e.getType()));
                Map&lt;String, Object&gt; variables = getMap(scanner, formProperties);
                // 提交工作
                taskService.complete(task.getId(), variables);
                // 同步最新流程状态
                processInstance = processEngine
                        .getRuntimeService()
                        .createProcessInstanceQuery()
                        .processInstanceId(processInstance.getId())
                        .singleResult();
            }
        }
        scanner.close();
    }

    /**
     * 读取参数
     *
     * @param scanner        标准输入
     * @param formProperties 表单参数集合
     * @return Map
     * @throws ParseException
     */
    private static Map&lt;String, Object&gt; getMap(Scanner scanner, List&lt;FormProperty&gt; formProperties) throws ParseException {
        Map&lt;String, Object&gt; variables = Maps.newHashMap();
        // 支持多参数输入
        for (FormProperty formProperty : formProperties) {
            String line = &quot;&quot;;
            // 对输入类型判断
            if (StringFormType.class.isInstance(formProperty.getType())) {
                log.info(&quot;请输入 {} ?&quot;, formProperty.getName());
                line = scanner.nextLine();
                // 存储输入
                variables.put(formProperty.getId(), line);
            } else {
                if (DateFormType.class.isInstance(formProperty.getType())) {
                    log.info(&quot;请输入 {} ? 格式 (yyyy-MM-dd HH:mm:ss)&quot;, formProperty.getName());
                    line = scanner.nextLine();
                    // 日期格式化
                    SimpleDateFormat dateFormat = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);
                    Date date = dateFormat.parse(line);
                    variables.put(formProperty.getId(), line);
                    log.info(&quot;输入的内容为 [{}]&quot;, line);
                } else {
                    // 其余类型
                    log.info(&quot;{} 类型暂不支持&quot;, formProperty.getType());
                }
            }
            log.info(&quot;输入的内容给 [{}]&quot;, line);
        }
        return variables;
    }

    /**
     * 启动流程
     *
     * @param processEngine
     * @param processDefinition
     * @return ProcessInstance
     */
    private static ProcessInstance getProcessInstance(ProcessEngine processEngine, ProcessDefinition processDefinition) {
        // 新建运行时对象
        RuntimeService runtimeService = processEngine.getRuntimeService();
        // 通过ID启动
        ProcessInstance processInstance = runtimeService.startProcessInstanceById(processDefinition.getId());
        log.info(&quot;启动流程 [{}]&quot;, processInstance.getProcessDefinitionKey());
        return processInstance;
    }

    /**
     * 部署流程定义文件
     *
     * @param processEngine
     * @return ProcessDefinition
     */
    private static ProcessDefinition getProcessDefinition(ProcessEngine processEngine) {
        // 创建对二进制文件操作的service
        RepositoryService repositoryService = processEngine.getRepositoryService();
        DeploymentBuilder deploymentBuilder = repositoryService.createDeployment();
        // 指定路径
        deploymentBuilder.addClasspathResource(&quot;second_approve.bpmn&quot;);
        // 部署
        Deployment deploy = deploymentBuilder.deploy();
        String deployId = deploy.getId();
        // 获得流程定义对象
        ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().deploymentId(deployId).singleResult();

        // 输出=&gt;流程定义文件二级审批流程，流程IDsecond_approve:1:4，:1:4为部署ID与流程ID组装的结果
        log.info(&quot;流程定义文件 [{}]，流程ID [{}]&quot;, processDefinition.getName(), processDefinition.getId());
        return processDefinition;
    }

    /**
     * 创建流程引擎
     *
     * @return ProcessEngine
     */
    private static ProcessEngine getProcessEngine() {
        // 创建基于内存的流程引擎
        ProcessEngineConfiguration cfg = ProcessEngineConfiguration.createStandaloneInMemProcessEngineConfiguration();
        // 构造流程引擎
        ProcessEngine processEngine = cfg.buildProcessEngine();
        // 获取流程引擎信息
        String name = processEngine.getName();
        String version = ProcessEngine.VERSION;
        log.info(&quot;流程引擎名称[{}],版本[{}]&quot;, name, version);
        return processEngine;
    }
}
</code></pre>
<h3 id="maven打包">maven打包</h3>
<p>直接打包</p>
<pre><code class="language-bash">$ mvn clean package
</code></pre>
<p>或者打包同时运行</p>
<pre><code class="language-bash">$ mvn clean spring-boot:run
</code></pre>
<h3 id="执行">执行</h3>
<p>结果</p>
<pre><code class="language-bash">主程序启动
流程引擎名称[default],版本[6.0.0.4]
流程定义文件 [二级审批流程]，流程ID [second_approve:1:4]
启动流程 [second_approve]
待处理任务数量 [1]
待处理任务 [填写审批信息]
属性值 申请信息,类型 org.activiti.engine.impl.form.StringFormType@5bfa8cc5
属性值 申请人姓名,类型 org.activiti.engine.impl.form.StringFormType@5bfa8cc5
属性值 提交时间,类型 org.activiti.engine.impl.form.DateFormType@666b83a4
属性值 确认申请,类型 org.activiti.engine.impl.form.StringFormType@5bfa8cc5
请输入 申请信息 ?
TEST
输入的内容给 [TEST]
请输入 申请人姓名 ?
FJY
输入的内容给 [FJY]
请输入 提交时间 ? 格式 (yyyy-MM-dd)
2019-01-01
输入的内容为 [Tue Jan 01 00:00:00 CST 2019]
输入的内容给 [2019-01-01]
请输入 确认申请 ?
Y
输入的内容给 [Y]
待处理任务数量 [1]
待处理任务 [主管审批]
属性值 主管审批结果,类型 org.activiti.engine.impl.form.StringFormType@5bfa8cc5
属性值 主管备注,类型 org.activiti.engine.impl.form.StringFormType@5bfa8cc5
请输入 主管审批结果 ?
Y
输入的内容给 [Y]
请输入 主管备注 ?
YES
输入的内容给 [YES]
待处理任务数量 [1]
待处理任务 [HR审批]
属性值 人事审批结果,类型 org.activiti.engine.impl.form.StringFormType@5bfa8cc5
属性值 人事审批备注,类型 org.activiti.engine.impl.form.StringFormType@5bfa8cc5
请输入 人事审批结果 ?
Y
输入的内容给 [Y]
请输入 人事审批备注 ?
YES
输入的内容给 [YES]
主程序结束
</code></pre>
<h2 id="流程创建引擎配置">流程创建引擎配置</h2>
<h3 id="引擎配置结构图">引擎配置结构图</h3>
<pre><code class="language-mermaid">graph TD
    A[activiti.cfg.xml] --&gt; B[ProcessEnigneConfiguration] 
    B --&gt; C[ProcessEnigne]
    C --&gt; D[RepositoryService]
    C --&gt; E[RuntimeService]
    C --&gt; F[xxxService]
</code></pre>
<p><code>ProcessEnigneConfiguration</code>核心功能</p>
<ul>
<li>查找并解析<code>xml</code>配置文件<code>activiti.cfg.xml</code></li>
<li>提供多个静态方法创建配置对象</li>
<li>实现几个基于<strong>不同场景的子类</strong>，配置方式非常灵活</li>
</ul>
<h3 id="processengineconfiguration源码"><code>ProcessEngineConfiguration</code>源码</h3>
<p>其提供了7个静态方法创建流程引擎对象</p>
<pre><code class="language-java">package org.activiti.engine;

public abstract class ProcessEngineConfiguration {
    ...
    // 默认配置创建
	public static ProcessEngineConfiguration createProcessEngineConfigurationFromResourceDefault() {
    return createProcessEngineConfigurationFromResource(&quot;activiti.cfg.xml&quot;, &quot;processEngineConfiguration&quot;);
  }

  public static ProcessEngineConfiguration createProcessEngineConfigurationFromResource(String resource) {
    return createProcessEngineConfigurationFromResource(resource, &quot;processEngineConfiguration&quot;);
  }
  // 指定配置创建
  public static ProcessEngineConfiguration createProcessEngineConfigurationFromResource(String resource, String beanName) {
    return BeansConfigurationHelper.parseProcessEngineConfigurationFromResource(resource, beanName);
  }

  public static ProcessEngineConfiguration createProcessEngineConfigurationFromInputStream(InputStream inputStream) {
    return createProcessEngineConfigurationFromInputStream(inputStream, &quot;processEngineConfiguration&quot;);
  }

  public static ProcessEngineConfiguration createProcessEngineConfigurationFromInputStream(InputStream inputStream, String beanName) {
    return BeansConfigurationHelper.parseProcessEngineConfigurationFromInputStream(inputStream, beanName);
  }
  // 独立引擎对象
  public static ProcessEngineConfiguration createStandaloneProcessEngineConfiguration() {
    return new StandaloneProcessEngineConfiguration();
  }
  // 独立的内存引擎对象
  public static ProcessEngineConfiguration createStandaloneInMemProcessEngineConfiguration() {
    return new StandaloneInMemProcessEngineConfiguration();
  }
    ...
}
</code></pre>
<p>其实现类关系图，通过多个子类适配不同场景</p>
<figure data-type="image" tabindex="55"><img src="https://fjy8018.gitee.io/images/img/ProcessEngineConfiguration.png" alt="ProcessEngineConfiguration"></figure>
<p>实现类主要功能</p>
<ul>
<li><code>ProcessEngineConfigurationImpl</code>非真正的实现类，实现了大部分引擎配置</li>
<li><code>StandaloneProcessEngineConfiguration</code> 用于支持独立部署运行</li>
<li><code>SpringProcessEngineConfiguration</code> 实现Spring集成，包括数据源、事务、外部化配置等</li>
</ul>
<h3 id="不同配置差异">不同配置差异</h3>
<h4 id="创建默认配置">创建默认配置</h4>
<p>工程下创建配置文件<code>activiti.cfg.xml</code>，从源码工程中获取并修改如下</p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;
       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans   http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;

  &lt;bean id=&quot;processEngineConfiguration&quot; class=&quot;org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration&quot;&gt;
    &lt;property name=&quot;jdbcUrl&quot; value=&quot;jdbc:h2:mem:activiti;DB_CLOSE_DELAY=1000;MVCC=TRUE&quot; /&gt;
    &lt;property name=&quot;jdbcDriver&quot; value=&quot;org.h2.Driver&quot; /&gt;
    &lt;property name=&quot;jdbcUsername&quot; value=&quot;sa&quot; /&gt;
    &lt;property name=&quot;jdbcPassword&quot; value=&quot;&quot; /&gt;
  &lt;/bean&gt;
&lt;/beans&gt;
</code></pre>
<p>创建测试类</p>
<pre><code class="language-java">package top.fjy8018.activiti.sample.config;

/**
 * @author ：F嘉阳
 * @date ：2019/8/8 15:54
 */
@Slf4j
public class DefaultConfigTest {
    @Test
    public void defalutConfig(){
        ProcessEngineConfiguration configuration = ProcessEngineConfiguration
                .createProcessEngineConfigurationFromResourceDefault();
        log.info(&quot;config = {}&quot;,configuration);
    }
}

</code></pre>
<p>输出为</p>
<pre><code class="language-bash">16:10:46.965 [main] DEBUG org.springframework.core.env.StandardEnvironment - Adding PropertySource 'systemProperties' with lowest search precedence
16:10:46.969 [main] DEBUG org.springframework.core.env.StandardEnvironment - Adding PropertySource 'systemEnvironment' with lowest search precedence
16:10:46.970 [main] DEBUG org.springframework.core.env.StandardEnvironment - Initialized StandardEnvironment with PropertySources [MapPropertySource@85777802 {name='systemProperties', properties={java.runtime.name=Java(TM) SE Runtime Environment, sun.boot.library.path=...
16:10:46.975 [main] INFO org.springframework.beans.factory.xml.XmlBeanDefinitionReader - Loading XML bean definitions from class path resource [activiti.cfg.xml]
16:10:46.993 [main] DEBUG org.springframework.beans.factory.xml.DefaultDocumentLoader - Using JAXP provider [com.sun.org.apache.xerces.internal.jaxp.DocumentBuilderFactoryImpl]
16:10:47.039 [main] DEBUG org.springframework.beans.factory.xml.PluggableSchemaResolver - Loading schema mappings from [META-INF/spring.schemas]
16:10:47.042 [main] DEBUG org.springframework.beans.factory.xml.PluggableSchemaResolver - Loaded schema mappings: ...
16:10:47.043 [main] DEBUG org.springframework.beans.factory.xml.PluggableSchemaResolver - Found XML schema [http://www.springframework.org/schema/beans/spring-beans.xsd] in classpath: org/springframework/beans/factory/xml/spring-beans.xsd
16:10:47.087 [main] DEBUG org.springframework.beans.factory.xml.DefaultBeanDefinitionDocumentReader - Loading bean definitions
16:10:47.101 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Creating shared instance of singleton bean 'processEngineConfiguration'
16:10:47.101 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Creating instance of bean 'processEngineConfiguration'
16:10:47.377 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Eagerly caching bean 'processEngineConfiguration' to allow for resolving potential circular references
16:10:47.572 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Finished creating instance of bean 'processEngineConfiguration'
16:10:47.573 [main] INFO top.fjy8018.activiti.sample.config.DefaultConfigTest - config = org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration@3bd82cf5
</code></pre>
<h4 id="创建独立引擎对象">创建独立引擎对象</h4>
<p>增加单元测试</p>
<pre><code class="language-java">package top.fjy8018.activiti.sample.config;

/**
 * @author ：F嘉阳
 * @date ：2019/8/8 15:54
 */
@Slf4j
public class DefaultConfigTest {
    @Test
    public void standaloneConfig() {
        ProcessEngineConfiguration configuration = ProcessEngineConfiguration
                .createStandaloneProcessEngineConfiguration();
        log.info(&quot;config = {}&quot;, configuration);
    }
}
</code></pre>
<p>输出结果</p>
<pre><code class="language-bash">16:10:13.328 [main] INFO top.fjy8018.activiti.sample.config.DefaultConfigTest - config = org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration@70a9f84e
</code></pre>
<h4 id="结果分析">结果分析</h4>
<p>两种方式均创建了<code>StandaloneProcessEngineConfiguration</code>对象，但默认配置是通过解析Spring Bean配置文件创建，而手动创建不需要解析Spring Bean配置</p>
<p>创建过程<code>ProcessEngineConfiguration</code>源码分析</p>
<pre><code class="language-java">package org.activiti.engine;

public abstract class ProcessEngineConfiguration {

	// 默认配置
	public static ProcessEngineConfiguration createProcessEngineConfigurationFromResourceDefault() {
	  return createProcessEngineConfigurationFromResource(&quot;activiti.cfg.xml&quot;, &quot;processEngineConfiguration&quot;);
	}
	// 读取资源
	public static ProcessEngineConfiguration createProcessEngineConfigurationFromResource(String resource, String beanName) {
	  return BeansConfigurationHelper.parseProcessEngineConfigurationFromResource(resource, beanName);
	}
}
</code></pre>
<p>资源解析<code>BeansConfigurationHelper</code></p>
<pre><code class="language-java">package org.activiti.engine.impl.cfg;

public class BeansConfigurationHelper {

	// 解析Spring配置
	public static ProcessEngineConfiguration parseProcessEngineConfigurationFromResource(String resource, String beanName) {
	  Resource springResource = new ClassPathResource(resource);
	  return parseProcessEngineConfiguration(springResource, beanName);
	}

	public static ProcessEngineConfiguration parseProcessEngineConfiguration(Resource springResource, String beanName) {
	  DefaultListableBeanFactory beanFactory = new DefaultListableBeanFactory();
	  XmlBeanDefinitionReader xmlBeanDefinitionReader = new XmlBeanDefinitionReader(beanFactory);
	  xmlBeanDefinitionReader.setValidationMode(XmlBeanDefinitionReader.VALIDATION_XSD);
	  xmlBeanDefinitionReader.loadBeanDefinitions(springResource);
	  ProcessEngineConfigurationImpl processEngineConfiguration = (ProcessEngineConfigurationImpl) beanFactory.getBean(beanName);
	  processEngineConfiguration.setBeans(new SpringBeanFactoryProxyMap(beanFactory));
	  return processEngineConfiguration;
	}
}
</code></pre>
<p>而指定创建独立流程引擎对象则是直接返回一个对象</p>
<pre><code class="language-java">package org.activiti.engine;

public abstract class ProcessEngineConfiguration {

	public static ProcessEngineConfiguration createStandaloneInMemProcessEngineConfiguration() {
      // 直接创建对象并返回
	  return new StandaloneInMemProcessEngineConfiguration();
	}
}
</code></pre>
<h3 id="配置引擎源码分析">配置引擎源码分析</h3>
<h4 id="顶级抽象配置类processengineconfiguration">顶级抽象配置类<code>ProcessEngineConfiguration</code></h4>
<p><code>ProcessEngineConfiguration</code>内也指定了大量规约配置，例如默认数据库为<code>H2</code>等</p>
<p>但其默认使用的是<code>Mybatis</code>提供的连接池，生产上<strong>不推荐</strong>使用</p>
<pre><code class="language-java">package org.activiti.engine;

public abstract class ProcessEngineConfiguration {

	/**
	 * 默认不对数据库做修改
	 */
	public static final String DB_SCHEMA_UPDATE_FALSE = &quot;false&quot;;
	public static final String DB_SCHEMA_UPDATE_CREATE_DROP = &quot;create-drop&quot;;

	/**
	 * 自动对表结构进行更新
	 */
	public static final String DB_SCHEMA_UPDATE_TRUE = &quot;true&quot;;

	public static final String NO_TENANT_ID = &quot;&quot;;

	protected String processEngineName = ProcessEngines.NAME_DEFAULT;
	protected int idBlockSize = 2500;
	protected String history = HistoryLevel.AUDIT.getKey();
	protected boolean asyncExecutorActivate;

	protected String mailServerHost = &quot;localhost&quot;;
	protected String mailServerUsername; // 默认继承了邮件配置
	protected String mailServerPassword;
	protected int mailServerPort = 25;
	protected boolean useSSL;
	protected boolean useTLS;
	protected String mailServerDefaultFrom = &quot;activiti@localhost&quot;;
	protected String mailSessionJndi;
	protected Map&lt;String, MailServerInfo&gt; mailServers = new HashMap&lt;String, MailServerInfo&gt;();
	protected Map&lt;String, String&gt; mailSessionsJndi = new HashMap&lt;String, String&gt;();

	protected String databaseType;
	protected String databaseSchemaUpdate = DB_SCHEMA_UPDATE_FALSE;
	protected String jdbcDriver = &quot;org.h2.Driver&quot;;
	protected String jdbcUrl = &quot;jdbc:h2:tcp://localhost/~/activiti&quot;;
	protected String jdbcUsername = &quot;sa&quot;;
	protected String jdbcPassword = &quot;&quot;;
    protected String xmlEncoding = &quot;UTF-8&quot;;

	protected String defaultCamelContext = &quot;camelContext&quot;;

	protected String activityFontName = &quot;Arial&quot;;
	protected String labelFontName = &quot;Arial&quot;;
	protected String annotationFontName = &quot;Arial&quot;;
}
</code></pre>
<p>其创建流程引擎方法作为抽象供子类实现</p>
<figure data-type="image" tabindex="56"><img src="https://fjy8018.gitee.io/images/img/1565253941486.png" alt="1565253941486"></figure>
<h4 id="默认实现抽象类processengineconfigurationimpl">默认实现抽象类<code>ProcessEngineConfigurationImpl</code></h4>
<p><code>ProcessEngineConfigurationImpl</code>默认实现如下，执行大量初始化流程</p>
<pre><code class="language-java">public abstract class ProcessEngineConfigurationImpl extends ProcessEngineConfiguration {
	
	@Override
	public ProcessEngine buildProcessEngine() {
	  init();
	  ProcessEngineImpl processEngine = new ProcessEngineImpl(this);

	  // trigger build of Activiti 5 Engine
	  if (isActiviti5CompatibilityEnabled &amp;&amp; activiti5CompatibilityHandler != null) {
	    Context.setProcessEngineConfiguration(processEngine.getProcessEngineConfiguration());
	    activiti5CompatibilityHandler.getRawProcessEngine();
	  }

	  postProcessEngineInitialisation();

	  return processEngine;
	}
	
	public void init() {
	    initConfigurators();
	    configuratorsBeforeInit();
	    ...
}
</code></pre>
<h4 id="独立引擎配置类standaloneprocessengineconfiguration">独立引擎配置类<code>StandaloneProcessEngineConfiguration</code></h4>
<p><code>StandaloneProcessEngineConfiguration</code>实现较为简单，只返回空拦截器</p>
<pre><code class="language-java">package org.activiti.engine.impl.cfg;

public class StandaloneProcessEngineConfiguration extends ProcessEngineConfigurationImpl {
  // 返回空拦截器
  @Override
  public CommandInterceptor createTransactionInterceptor() {
    return null;
  }
}
</code></pre>
<h4 id="内存引擎配置类standaloneinmemprocessengineconfiguration">内存引擎配置类<code>StandaloneInMemProcessEngineConfiguration</code></h4>
<p>其子类实现了内存数据库拦截器</p>
<pre><code class="language-java">package org.activiti.engine.impl.cfg;

public class StandaloneInMemProcessEngineConfiguration extends StandaloneProcessEngineConfiguration {

  public StandaloneInMemProcessEngineConfiguration() {
    this.databaseSchemaUpdate = DB_SCHEMA_UPDATE_CREATE_DROP;
    this.jdbcUrl = &quot;jdbc:h2:mem:activiti&quot;;
  }
}
</code></pre>
<h4 id="spring集成配置类springprocessengineconfiguration">Spring集成配置类<code>SpringProcessEngineConfiguration</code></h4>
<p>实现事务、数据源、自动部署等配置，多用于生产环境</p>
<pre><code class="language-java">package org.activiti.spring;

public class SpringProcessEngineConfiguration extends ProcessEngineConfigurationImpl implements ApplicationContextAware {
	// 事务定义
	protected PlatformTransactionManager transactionManager;
	// 配置自动部署文件夹
	protected String deploymentName = &quot;SpringAutoDeployment&quot;;
	protected Resource[] deploymentResources = new Resource[0];
	protected String deploymentMode = &quot;default&quot;;
	protected ApplicationContext applicationContext;
	protected Integer transactionSynchronizationAdapterOrder = null;
	private Collection&lt;AutoDeploymentStrategy&gt; deploymentStrategies = new ArrayList&lt;AutoDeploymentStrategy&gt;();

	public SpringProcessEngineConfiguration() {
	  this.transactionsExternallyManaged = true;
	  deploymentStrategies.add(new DefaultAutoDeploymentStrategy());
	  deploymentStrategies.add(new SingleResourceAutoDeploymentStrategy());
	  deploymentStrategies.add(new ResourceParentFolderAutoDeploymentStrategy());
	}

	@Override
	public void initTransactionContextFactory() {
	  if (transactionContextFactory == null &amp;&amp; transactionManager != null) {
	    transactionContextFactory = new SpringTransactionContextFactory(transactionManager, transactionSynchronizationAdapterOrder);
	  }
	}

	// JPA 初始化
	@Override
	public void initJpa() {
	  super.initJpa();
	  if (jpaEntityManagerFactory != null) {
	    sessionFactories.put(EntityManagerSession.class, new SpringEntityManagerSessionFactory(jpaEntityManagerFactory, jpaHandleTransaction, jpaCloseEntityManager));
	  }
	}

	// 自动资源部署
	protected void autoDeployResources(ProcessEngine processEngine) {
	  if (deploymentResources != null &amp;&amp; deploymentResources.length &gt; 0) {
	    final AutoDeploymentStrategy strategy = getAutoDeploymentStrategy(deploymentMode);
	    strategy.deployResources(deploymentName, deploymentResources, processEngine.getRepositoryService());
	  }
	}

	// 数据源配置
	@Override
	public ProcessEngineConfiguration setDataSource(DataSource dataSource) {
	  if (dataSource instanceof TransactionAwareDataSourceProxy) {
	    return super.setDataSource(dataSource);
	  } else {
	    // Wrap datasource in Transaction-aware proxy
	    DataSource proxiedDataSource = new TransactionAwareDataSourceProxy(dataSource);
	    return super.setDataSource(proxiedDataSource);
	  }
	}
	
	public PlatformTransactionManager getTransactionManager() {
	  return transactionManager;
	}

	public void setTransactionManager(PlatformTransactionManager transactionManager) {
	  this.transactionManager = transactionManager;
	}
}
</code></pre>
<h2 id="数据库引擎配置">数据库引擎配置</h2>
<h3 id="可选配置">可选配置</h3>
<ul>
<li>缺省配置默认，使用<code>H2</code>内存数据库</li>
<li>配置<code>JDBC</code>属性，使用<code>mybatis</code>提供的连接池</li>
<li>配置<code>DataSource</code>，可自选第三方实现
<ul>
<li><code>Druid</code> 为监控而生的数据库连接池来自阿里</li>
<li><code>Dbcp</code>老牌数据源连接池，稳定可靠，Tomcat自带</li>
<li><code>HikariCP</code>来自日本的的极速数据源连接池，<code>Spring</code>默选</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th>基本配置</th>
<th>连接池配置</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>jdbcUrl</code></td>
<td><code>jdbcMaxActiveConnections</code></td>
<td>最大活跃连接数</td>
</tr>
<tr>
<td><code>jdbcUsername</code></td>
<td><code>jdbcMaxldleConnections</code></td>
<td>最大空闲连接</td>
</tr>
<tr>
<td><code>jdbcPassword</code></td>
<td><code>jdbcMaxCheckoutTime</code></td>
<td>最大检查时间</td>
</tr>
<tr>
<td><code>jdbcDriver</code></td>
<td><code>jdbcMaxWaitTime</code></td>
<td>最长等待时间</td>
</tr>
</tbody>
</table>
<p>用法和线程池相同，一般就设置最大连接数和最小连接数相同，减少连接创建和销毁的开销</p>
<h3 id="60数据库支持列表">6.0数据库支持列表</h3>
<p>官方文档支持列表如下</p>
<table>
<thead>
<tr>
<th style="text-align:left">数据库</th>
<th style="text-align:left"><code>JDBC</code> 连接URL样例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>h2</code></td>
<td style="text-align:left"><code>jdbc:h2:tcp://localhost/activiti</code></td>
</tr>
<tr>
<td style="text-align:left"><code>mysql</code></td>
<td style="text-align:left"><code>jdbc:mysql://localhost:3306/activiti?autoReconnect=true</code></td>
</tr>
<tr>
<td style="text-align:left"><code>oracle</code></td>
<td style="text-align:left"><code>jdbc:oracle:thin:@localhost:1521:xe</code></td>
</tr>
<tr>
<td style="text-align:left"><code>postgres</code></td>
<td style="text-align:left"><code>jdbc:postgresql://localhost:5432/activiti</code></td>
</tr>
<tr>
<td style="text-align:left"><code>db2</code></td>
<td style="text-align:left"><code>jdbc:db2://localhost:50000/activiti</code></td>
</tr>
<tr>
<td style="text-align:left"><code>mssql</code></td>
<td style="text-align:left"><code>jdbc:sqlserver://localhost:1433;databaseName=activiti</code>(<code>jdbc.driver=com.microsoft.sqlserver.jdbc.SQLServerDriver</code>) <strong>OR</strong> <code>jdbc:jtds:sqlserver://localhost:1433/activiti</code> (<code>jdbc.driver=net.sourceforge.jtds.jdbc.Driver</code>)</td>
</tr>
</tbody>
</table>
<h3 id="数据库更新策略">数据库更新策略</h3>
<p>原因：<code>Activiti</code> 版本更新后表结构可能发生变化</p>
<p>策略：</p>
<ul>
<li><code>false</code>: 启动时检查数据库版本,发生不匹配抛异常（生产环境对数据库无DDL权限时使用）</li>
<li><code>true</code>:  启动时自动检查并更新数据库表,不存在会创建</li>
<li><code>create-drop</code>：启动时创建数据库表结构，结束时删除表结构（测试时使用）</li>
</ul>
<p>默认内存引擎配置</p>
<pre><code class="language-java">package top.fjy8018.activiti.sample.config;

/**
 * @author ：F嘉阳
 * @date ：2019/8/9 8:28
 */
@Slf4j
public class DBConfigTest {

    @Test
    public void inMemProcessEngineConfig() {
        ProcessEngineConfiguration configuration = ProcessEngineConfiguration
                .createProcessEngineConfigurationFromResourceDefault();
        log.info(&quot;config = {}&quot;, configuration);
        ProcessEngine processEngine = configuration.buildProcessEngine();
        log.info(&quot;流程引擎 {}&quot;,processEngine.getName());
        processEngine.close();
    }
}
</code></pre>
<p>输出结果</p>
<pre><code class="language-bash">...
08:36:28.790 [main] INFO top.fjy8018.activiti.sample.config.DBConfigTest - config = org.activiti.engine.impl.cfg.StandaloneInMemProcessEngineConfiguration@158d2680
...
08:36:30.089 [main] INFO org.activiti.engine.impl.db.DbSqlSession - performing create on engine with resource org/activiti/db/create/activiti.h2.create.engine.sql
08:36:30.187 [main] INFO org.activiti.engine.impl.db.DbSqlSession - performing create on history with resource org/activiti/db/create/activiti.h2.create.history.sql
08:36:30.217 [main] INFO org.activiti.engine.impl.db.DbSqlSession - performing create on identity with resource org/activiti/db/create/activiti.h2.create.identity.sql
08:36:30.317 [main] INFO org.activiti.engine.impl.db.DbSqlSession - performing drop on engine with resource org/activiti/db/drop/activiti.h2.drop.engine.sql

...
08:36:30.316 [main] INFO top.fjy8018.activiti.sample.config.DBConfigTest - 流程引擎 default
...
</code></pre>
<p>由此看出使用内存引擎会自动调用创建数据库脚本语句，并在执行完毕后删除对应的脚本</p>
<h4 id="standaloneinmemprocessengineconfiguration内存数据库引擎源码"><code>StandaloneInMemProcessEngineConfiguration</code>内存数据库引擎源码</h4>
<p>从内存引擎的实现源码可看到相应的配置</p>
<pre><code class="language-java">package org.activiti.engine.impl.cfg;

public class StandaloneInMemProcessEngineConfiguration extends StandaloneProcessEngineConfiguration {

	public StandaloneInMemProcessEngineConfiguration() {
      // 创建后销毁策略
	  this.databaseSchemaUpdate = DB_SCHEMA_UPDATE_CREATE_DROP;
	  this.jdbcUrl = &quot;jdbc:h2:mem:activiti&quot;;
	}
}
</code></pre>
<h3 id="配置mysql数据库">配置<code>MySQL</code>数据库</h3>
<p><code>pom</code>文件中加入驱动依赖</p>
<pre><code class="language-xml">&lt;dependency&gt;
    &lt;groupId&gt;mysql&lt;/groupId&gt;
    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
    &lt;version&gt;8.0.16&lt;/version&gt;
    &lt;scope&gt;runtime&lt;/scope&gt;
&lt;/dependency&gt;
</code></pre>
<p>修改bean配置文件<code>activiti.cfg.xml</code></p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;
       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans   http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;

    &lt;bean id=&quot;processEngineConfiguration&quot;
          class=&quot;org.activiti.engine.impl.cfg.StandaloneInMemProcessEngineConfiguration&quot;&gt;
        &lt;property name=&quot;jdbcUrl&quot; value=&quot;jdbc:mysql://db:3306/activiti?useSSL=false&amp;amp;useUnicode=true&amp;amp;characterEncoding=UTF-8&amp;amp;serverTimezone=Asia/Shanghai&quot; /&gt;
        &lt;property name=&quot;jdbcDriver&quot; value=&quot;com.mysql.cj.jdbc.Driver&quot; /&gt;
        &lt;property name=&quot;jdbcUsername&quot; value=&quot;dbactiviti&quot; /&gt;
        &lt;property name=&quot;jdbcPassword&quot; value=&quot;pwactiviti&quot; /&gt;
    &lt;/bean&gt;
&lt;/beans&gt;
</code></pre>
<p>执行数据库、用户创建和授权</p>
<pre><code class="language-sql">DROP DATABASE IF EXISTS activiti;
CREATE DATABASE activiti
  DEFAULT CHARACTER SET utf8mb4
  COLLATE utf8mb4_general_ci;

GRANT ALL ON activiti.* TO dbactiviti@'%'
    IDENTIFIED BY 'pwactiviti';
FLUSH PRIVILEGES;
</code></pre>
<p>日志输出，同样会自动执行创建和销毁动作</p>
<pre><code class="language-bash">09:50:42.506 [main] DEBUG org.activiti.engine.impl.cfg.ProcessEngineConfigurationImpl - database product name: 'MySQL'
09:50:42.506 [main] DEBUG org.activiti.engine.impl.cfg.ProcessEngineConfigurationImpl - using database type: mysql
...
09:50:41.981 [main] INFO top.fjy8018.activiti.sample.config.DBConfigTest - config = org.activiti.engine.impl.cfg.StandaloneInMemProcessEngineConfiguration@5e5d171f
...
09:50:43.730 [main] INFO org.activiti.engine.impl.db.DbSqlSession - Found MySQL: majorVersion=5 minorVersion=7
09:50:43.730 [main] INFO org.activiti.engine.impl.db.DbSqlSession - performing create on engine with resource org/activiti/db/create/activiti.mysql.create.engine.sql
09:50:48.255 [main] INFO org.activiti.engine.impl.db.DbSqlSession - performing create on history with resource org/activiti/db/create/activiti.mysql.create.history.sql
09:50:49.315 [main] INFO org.activiti.engine.impl.db.DbSqlSession - performing create on identity with resource org/activiti/db/create/activiti.mysql.create.identity.sql
...
09:50:49.856 [main] INFO top.fjy8018.activiti.sample.config.DBConfigTest - 流程引擎 default
...
09:50:49.858 [main] INFO org.activiti.engine.impl.db.DbSqlSession - performing drop on engine with resource org/activiti/db/drop/activiti.mysql.drop.engine.sql
09:50:51.728 [main] INFO org.activiti.engine.impl.db.DbSqlSession - performing drop on history with resource org/activiti/db/drop/activiti.mysql.drop.history.sql
</code></pre>
<p>为了防止可能出现的维护问题，建议手动指明数据库策略</p>
<pre><code class="language-xml">&lt;bean id=&quot;processEngineConfiguration&quot;
      class=&quot;org.activiti.engine.impl.cfg.StandaloneInMemProcessEngineConfiguration&quot;&gt;
    &lt;property name=&quot;jdbcUrl&quot;
              value=&quot;jdbc:mysql://120.79.226.26:3306/activiti?useSSL=false&amp;amp;useUnicode=true&amp;amp;characterEncoding=UTF-8&amp;amp;serverTimezone=Asia/Shanghai&quot;/&gt;
    &lt;property name=&quot;jdbcDriver&quot; value=&quot;com.mysql.cj.jdbc.Driver&quot;/&gt;
    &lt;property name=&quot;jdbcUsername&quot; value=&quot;dbactiviti&quot;/&gt;
    &lt;property name=&quot;jdbcPassword&quot; value=&quot;pwactiviti&quot;/&gt;
    &lt;!-- 数据库策略 --&gt;
    &lt;property name=&quot;databaseSchemaUpdate&quot; value=&quot;create-drop&quot;/&gt;
&lt;/bean&gt;
</code></pre>
<h3 id="配置druid连接池">配置Druid连接池</h3>
<p>加入<code>Druid</code>依赖</p>
<pre><code class="language-xml">&lt;!-- https://mvnrepository.com/artifact/com.alibaba/druid --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
    &lt;artifactId&gt;druid&lt;/artifactId&gt;
    &lt;version&gt;1.1.19&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>增加bean配置文件<code>activiti_druid.cfg.xml</code></p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;
       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans   http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;

    &lt;bean id=&quot;processEngineConfiguration&quot;
          class=&quot;org.activiti.engine.impl.cfg.StandaloneInMemProcessEngineConfiguration&quot;&gt;
        &lt;!--数据源--&gt;
        &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot; /&gt;
        &lt;!-- 数据库策略 --&gt;
        &lt;property name=&quot;databaseSchemaUpdate&quot; value=&quot;create-drop&quot;/&gt;
    &lt;/bean&gt;

    &lt;bean id=&quot;dataSource&quot; class=&quot;com.alibaba.druid.pool.DruidDataSource&quot; &gt;
        &lt;property name=&quot;driverClassName&quot; value=&quot;com.mysql.cj.jdbc.Driver&quot; /&gt;
        &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://120.79.226.26:3306/activiti?useSSL=false&amp;amp;useUnicode=true&amp;amp;characterEncoding=UTF-8&amp;amp;serverTimezone=Asia/Shanghai&quot; /&gt;
        &lt;property name=&quot;username&quot; value=&quot;dbactiviti&quot; /&gt;
        &lt;property name=&quot;password&quot; value=&quot;pwactiviti&quot; /&gt;
        &lt;property name=&quot;defaultAutoCommit&quot; value=&quot;false&quot; /&gt;
        &lt;property name=&quot;initialSize&quot; value=&quot;1&quot;/&gt;
        &lt;property name=&quot;maxActive&quot; value=&quot;10&quot;/&gt;
        &lt;!--监控、日志过滤器--&gt;
        &lt;property name=&quot;filters&quot; value=&quot;stat,slf4j&quot; /&gt;
    &lt;/bean&gt;
&lt;/beans&gt;
</code></pre>
<p>创建测试类，加载<code>druid</code>配置文件</p>
<pre><code class="language-java">/**
 * druid数据库引擎测试
 */
@Test
public void druidProcessEngineConfig() {
    ProcessEngineConfiguration configuration = ProcessEngineConfiguration
            .createProcessEngineConfigurationFromResource(&quot;activiti_druid.cfg.xml&quot;);
    log.info(&quot;config = {}&quot;, configuration);
    ProcessEngine processEngine = configuration.buildProcessEngine();
    log.info(&quot;流程引擎 {}&quot;, processEngine.getName());
    processEngine.close();
}
</code></pre>
<p>输出结果</p>
<pre><code class="language-bash">2019-08-09 02:26:58  INFO [main]  at top.fjy8018.activiti.sample.config.DBConfigTest.druidProcessEngineConfig(DBConfigTest.java:35) - config = org.activiti.engine.impl.cfg.StandaloneInMemProcessEngineConfiguration@65c7a252
2019-08-09 02:26:58  INFO [main]  at com.alibaba.druid.pool.DruidDataSource.init(DruidDataSource.java:1003) - {dataSource-1} inited
2019-08-09 02:26:59  INFO [main]  at org.activiti.engine.impl.db.DbSqlSession.executeSchemaResource(DbSqlSession.java:1147) - performing create on engine with resource org/activiti/db/create/activiti.mysql.create.engine.sql
2019-08-09 02:26:59  INFO [main]  at org.activiti.engine.impl.db.DbSqlSession.executeSchemaResource(DbSqlSession.java:1162) - Found MySQL: majorVersion=5 minorVersion=7
2019-08-09 02:27:05  INFO [main]  at org.activiti.engine.impl.db.DbSqlSession.executeSchemaResource(DbSqlSession.java:1147) - performing create on history with resource org/activiti/db/create/activiti.mysql.create.history.sql
2019-08-09 02:27:06  INFO [main]  at org.activiti.engine.impl.db.DbSqlSession.executeSchemaResource(DbSqlSession.java:1147) - performing create on identity with resource org/activiti/db/create/activiti.mysql.create.identity.sql
2019-08-09 02:27:06  INFO [main]  at top.fjy8018.activiti.sample.config.DBConfigTest.druidProcessEngineConfig(DBConfigTest.java:37) - 流程引擎 default
2019-08-09 02:27:06  INFO [main]  at org.activiti.engine.impl.db.DbSqlSession.executeSchemaResource(DbSqlSession.java:1147) - performing drop on engine with resource org/activiti/db/drop/activiti.mysql.drop.engine.sql
2019-08-09 02:27:08  INFO [main]  at org.activiti.engine.impl.db.DbSqlSession.executeSchemaResource(DbSqlSession.java:1147) - performing drop on history with resource org/activiti/db/drop/activiti.mysql.drop.history.sql
2019-08-09 02:27:09  INFO [main]  at org.activiti.engine.impl.db.DbSqlSession.executeSchemaResource(DbSqlSession.java:1147) - performing drop on identity with resource org/activiti/db/drop/activiti.mysql.drop.identity.sql
</code></pre>
<h3 id="配置hikaricp连接池">配置<code>HikariCP</code>连接池</h3>
<p>加入<code>HikariCP</code>依赖</p>
<pre><code class="language-xml">&lt;!-- https://mvnrepository.com/artifact/com.zaxxer/HikariCP --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.zaxxer&lt;/groupId&gt;
    &lt;artifactId&gt;HikariCP&lt;/artifactId&gt;
    &lt;version&gt;3.3.1&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>增加bean配置文件<code>activiti_HikariCP.cfg.xml</code></p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;
       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans   http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;

    &lt;bean id=&quot;processEngineConfiguration&quot;
          class=&quot;org.activiti.engine.impl.cfg.StandaloneInMemProcessEngineConfiguration&quot;&gt;
        &lt;!--数据源--&gt;
        &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;/&gt;
        &lt;!-- 数据库策略 --&gt;
        &lt;property name=&quot;databaseSchemaUpdate&quot; value=&quot;create-drop&quot;/&gt;
    &lt;/bean&gt;

    &lt;bean id=&quot;dataSource&quot; class=&quot;com.zaxxer.hikari.HikariDataSource&quot;&gt;
        &lt;property name=&quot;driverClassName&quot; value=&quot;com.mysql.cj.jdbc.Driver&quot;/&gt;
        &lt;property name=&quot;jdbcUrl&quot;
                  value=&quot;jdbc:mysql://120.79.226.26:3306/activiti?useSSL=false&amp;amp;useUnicode=true&amp;amp;characterEncoding=UTF-8&amp;amp;serverTimezone=Asia/Shanghai&quot;/&gt;
        &lt;property name=&quot;username&quot; value=&quot;dbactiviti&quot;/&gt;
        &lt;property name=&quot;password&quot; value=&quot;pwactiviti&quot;/&gt;
        &lt;property name=&quot;maximumPoolSize&quot; value=&quot;20&quot;/&gt;
    &lt;/bean&gt;
&lt;/beans&gt;
</code></pre>
<p>只需要在装载时切换读取的配置文件即可</p>
<pre><code class="language-java">/**
 * HikariCP数据库引擎测试
 */
@Test
public void hikariProcessEngineConfig() {
    ProcessEngineConfiguration configuration = ProcessEngineConfiguration
            .createProcessEngineConfigurationFromResource(&quot;activiti_HikariCP.cfg.xml&quot;);
    log.info(&quot;config = {}&quot;, configuration);
    ProcessEngine processEngine = configuration.buildProcessEngine();
    log.info(&quot;流程引擎 {}&quot;, processEngine.getName());
    processEngine.close();
}
</code></pre>
<p>日志输出显示连接池切换成功</p>
<pre><code class="language-bash">2019-08-09 02:38:57  INFO [main]  at com.zaxxer.hikari.HikariDataSource.getConnection(HikariDataSource.java:110) - HikariPool-1 - Starting...
2019-08-09 02:38:58  INFO [main]  at com.zaxxer.hikari.HikariDataSource.getConnection(HikariDataSource.java:123) - HikariPool-1 - Start completed.
</code></pre>
<h3 id="初始化数据源连接池源码分析">初始化数据源连接池源码分析</h3>
<p>初始化工作在<code>ProcessEngineConfigurationImpl</code>中实现</p>
<pre><code class="language-java">package org.activiti.engine.impl.cfg;

public abstract class ProcessEngineConfigurationImpl extends ProcessEngineConfiguration {

    public void init() {
        initConfigurators();
        ...
        if (usingRelationalDatabase) {
            // 初始化数据源
            initDataSource();
        }

        initAgendaFactory();
        ...
    }

    // 初始化数据源
    public void initDataSource() {
        // 配置数据源为空则使用Jndi数据源
        if (dataSource == null) {
            if (dataSourceJndiName != null) {
                try {
                    dataSource = (DataSource) new InitialContext().lookup(dataSourceJndiName);
                } catch (Exception e) {
                    throw new ActivitiException(&quot;couldn't lookup datasource from &quot; + dataSourceJndiName + &quot;: &quot; + e.getMessage(), e);
                }
            } else if (jdbcUrl != null) {
                // 读取数据源配置信息
                if ((jdbcDriver == null) || (jdbcUsername == null)) {
                    throw new ActivitiException(&quot;DataSource or JDBC properties have to be specified in a process engine configuration&quot;);
                }
                log.debug(&quot;initializing datasource to db: {}&quot;, jdbcUrl);
                // 默认使用mybatis连接池 org.apache.ibatis.datasource.pooled.PooledDataSource
                PooledDataSource pooledDataSource = new PooledDataSource(ReflectUtil.getClassLoader(), jdbcDriver, jdbcUrl, jdbcUsername, jdbcPassword);
                if (jdbcMaxActiveConnections &gt; 0) {
                    pooledDataSource.setPoolMaximumActiveConnections(jdbcMaxActiveConnections);
                }
                if (jdbcMaxIdleConnections &gt; 0) {
                    pooledDataSource.setPoolMaximumIdleConnections(jdbcMaxIdleConnections);
                }
                if (jdbcMaxCheckoutTime &gt; 0) {
                    pooledDataSource.setPoolMaximumCheckoutTime(jdbcMaxCheckoutTime);
                }
                if (jdbcMaxWaitTime &gt; 0) {
                    pooledDataSource.setPoolTimeToWait(jdbcMaxWaitTime);
                }
                if (jdbcPingEnabled == true) {
                    pooledDataSource.setPoolPingEnabled(true);
                    if (jdbcPingQuery != null) {
                        pooledDataSource.setPoolPingQuery(jdbcPingQuery);
                    }
                    pooledDataSource.setPoolPingConnectionsNotUsedFor(jdbcPingConnectionNotUsedFor);
                }
                if (jdbcDefaultTransactionIsolationLevel &gt; 0) {
                    pooledDataSource.setDefaultTransactionIsolationLevel(jdbcDefaultTransactionIsolationLevel);
                }
                dataSource = pooledDataSource;
            }
            // 如果外部配置的数据源为mybatis数据源则强制关闭
            if (dataSource instanceof PooledDataSource) {
                ((PooledDataSource) dataSource).forceCloseAll();
            }
        }
        if (databaseType == null) {
            // 初始化数据库类型
            initDatabaseType();
        }
    }

    // 初始化数据库类型
    public void initDatabaseType() {
        Connection connection = null;
        try {
            connection = dataSource.getConnection();
            // 获取元信息
            DatabaseMetaData databaseMetaData = connection.getMetaData();
            // 查询元信息映射关系
            String databaseProductName = databaseMetaData.getDatabaseProductName();
            log.debug(&quot;database product name: '{}'&quot;, databaseProductName);
            databaseType = databaseTypeMappings.getProperty(databaseProductName);
            // 查询为空则不支持该数据库
            if (databaseType == null) {
                throw new ActivitiException(&quot;couldn't deduct database type from database product name '&quot; + databaseProductName + &quot;'&quot;);
            }
            log.debug(&quot;using database type: {}&quot;, databaseType);
            if (DATABASE_TYPE_MSSQL.equals(databaseType)) {
                maxNrOfStatementsInBulkInsert = DEFAULT_MAX_NR_OF_STATEMENTS_BULK_INSERT_SQL_SERVER;
            }

        } catch (SQLException e) {
            log.error(&quot;Exception while initializing Database connection&quot;, e);
        } finally {
            try {
                if (connection != null) {
                    connection.close();
                }
            } catch (SQLException e) {
                log.error(&quot;Exception while closing the Database connection&quot;, e);
            }
        }
    }

    // 数据库元信息映射关系
    protected static Properties databaseTypeMappings = getDefaultDatabaseTypeMappings();

    public static final String DATABASE_TYPE_H2 = &quot;h2&quot;;
    public static final String DATABASE_TYPE_HSQL = &quot;hsql&quot;;
    public static final String DATABASE_TYPE_MYSQL = &quot;mysql&quot;;
    public static final String DATABASE_TYPE_ORACLE = &quot;oracle&quot;;
    public static final String DATABASE_TYPE_POSTGRES = &quot;postgres&quot;;
    public static final String DATABASE_TYPE_MSSQL = &quot;mssql&quot;;
    public static final String DATABASE_TYPE_DB2 = &quot;db2&quot;;

    public static Properties getDefaultDatabaseTypeMappings() {
        Properties databaseTypeMappings = new Properties();
        databaseTypeMappings.setProperty(&quot;H2&quot;, DATABASE_TYPE_H2);
        databaseTypeMappings.setProperty(&quot;HSQL Database Engine&quot;, DATABASE_TYPE_HSQL);
        databaseTypeMappings.setProperty(&quot;MySQL&quot;, DATABASE_TYPE_MYSQL);
        databaseTypeMappings.setProperty(&quot;Oracle&quot;, DATABASE_TYPE_ORACLE);
        databaseTypeMappings.setProperty(&quot;PostgreSQL&quot;, DATABASE_TYPE_POSTGRES);
		...
        return databaseTypeMappings;
    }
}
</code></pre>
<h3 id="其余常用配置项">其余常用配置项</h3>
<p>数据库策略，建议为true，自动更新数据库表结构，由于<code>MySQL 5.6.4</code>之前<code>Timestamp</code>不支持毫秒精度，故官方建议使用 5.6.4+ 的版本</p>
<pre><code class="language-xml">&lt;property name=&quot;databaseSchemaUpdate&quot; value=&quot;true&quot;/&gt;
</code></pre>
<blockquote>
<p><strong>Note for MySQL users:</strong> MySQL version lower than 5.6.4 has no support for timestamps or dates with millisecond precision. To make things even worse, some version will throw an exception when trying to create such a column but other versions don’t. When doing auto-creation/upgrade, the engine will change the DDL when executing it. When using the DDL file approach, both a regular version and a special file with <em>mysql55</em> in it are available (this applies on anything lower than 5.6.4). This latter file will have column types with no millisecond precision in it.</p>
<p>Concretely, the following applies for MySQL version</p>
<ul>
<li><strong>&lt;5.6:</strong> No millisecond precision available. DDL files available (look for files containing <em>mysql55</em>). Auto creation/update will work out of the box.</li>
<li><strong>5.6.0 - 5.6.3:</strong> No millisecond precision available. Auto creation/update will NOT work. It is advised to upgrade to a newer database version anyway. DDL files for <em>mysql 5.5</em> could be used if really needed.</li>
<li><strong>5.6.4+:</strong> Millisecond precision available. DDL files available (default file containing <em>mysql</em>). Auto creation/update works out of the box.</li>
</ul>
<p>Do note that in the case of upgrading the MySQL database later on and the Activiti tables are already created/upgraded, the column type change will have to be done manually!</p>
</blockquote>
<p>是否使用历史数据，若为false则不保存流程历史数据</p>
<pre><code class="language-xml">&lt;property name=&quot;dbHistoryUsed&quot; value=&quot;true&quot; /&gt;
</code></pre>
<p>是否使用身份验证，即用户组、用户校验等，若有外部验证则可配置为false</p>
<pre><code class="language-xml">&lt;property name=&quot;dbIdentityUsed&quot; value=&quot;true&quot;/&gt;
</code></pre>
<p>支持自定义前缀</p>
<pre><code class="language-xml">&lt;property name=&quot;databaseTablePrefix&quot; value=&quot;t_&quot;/&gt;
</code></pre>
<p>支持手动指定数据库类型，不建议配置，源码表示其会自动识别数据库类型</p>
<pre><code class="language-xml">&lt;property name=&quot;databaseType&quot; value=&quot;mysql&quot;/&gt;
</code></pre>
<h2 id="日志和数据记录配置">日志和数据记录配置</h2>
<h3 id="日志组件的关系及mdc">日志组件的关系及<code>MDC</code></h3>
<h4 id="日志组件的关系">日志组件的关系</h4>
<figure data-type="image" tabindex="57"><img src="https://fjy8018.gitee.io/images/img/1565321220092.png" alt="1565321220092"></figure>
<h4 id="mdc"><code>MDC</code></h4>
<p>即流程上下文信息存储在线程变量<code>ThreadLocal</code>中</p>
<p>配置开启<code>MDC</code>(Mapped Diagnostic Contexts)</p>
<ul>
<li>默认没有开启，需要手动设置<code>LogMDC.setMDCEnable(true)</code></li>
<li>配置<code>logback.xml</code> 日志模板<code>%X{mdcProcessInstanceID}</code></li>
<li>流程只有在执行过程出现异常时才会记录<code>MDC</code>信息</li>
</ul>
<h3 id="配置历史记录级别historylevel">配置历史记录级别(<code>HistoryLevel</code>)</h3>
<p>配置<code>HistoryLevel</code></p>
<ul>
<li><code>none</code>: 不记录历史流程，性能高，流程结束后不可读取</li>
<li><code>activiti</code>: 归档流程实例和活动实例，流程变量不同步</li>
<li><code>audit</code>: 默认值，在<code>activiti</code>基础上同步变量值，保存表单属性</li>
<li><code>full</code>: 性能较差，记录所有实例和变量细节变化</li>
</ul>
<h3 id="配置基于db的事件日志event-logging">配置基于db的事件日志(<code>Event logging</code>)</h3>
<p>配置<code>Event Logging</code></p>
<ul>
<li>实验性的事件记录机制，性能影响较大</li>
<li>开启默认记录所有数据的变化过程，表记录快速增长</li>
<li>日志内容<code>json</code>格式，建议存入<code>mongoDB</code>、<code>Elastic Search</code></li>
</ul>
<h3 id="默认日志配置实例">默认日志配置实例</h3>
<p>通过脚手架创建的工程会自带一个单元测试</p>
<figure data-type="image" tabindex="58"><img src="https://fjy8018.gitee.io/images/img/1565331979854.png" alt="1565331979854"></figure>
<p><code>@Deployment</code>表示在测试前去<code>Activiti</code>中部署资源文件，该默认测试实现装载资源文件并启动流程引擎，仅需要加入执行流程语句即可</p>
<pre><code class="language-java">public class MyUnitTest {

	@Rule
	public ActivitiRule activitiRule = new ActivitiRule();

	@Test
	@Deployment(resources = {&quot;top/fjy8018/my-process.bpmn20.xml&quot;})
	public void test() {
		ProcessInstance processInstance = activitiRule.getRuntimeService().startProcessInstanceByKey(&quot;my-process&quot;);
		assertNotNull(processInstance);

		Task task = activitiRule.getTaskService().createTaskQuery().singleResult();
		assertEquals(&quot;Activiti is awesome!&quot;, task.getName());
	}
}
</code></pre>
<p>默认流程配置文件<code>my-process.bpmn20.xml</code>内容为</p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;definitions xmlns=&quot;http://www.omg.org/spec/BPMN/20100524/MODEL&quot;
             typeLanguage=&quot;http://www.w3.org/2001/XMLSchema&quot;
             expressionLanguage=&quot;http://www.w3.org/1999/XPath&quot; targetNamespace=&quot;http://www.activiti.org/test&quot;&gt;

    &lt;process id=&quot;my-process&quot;&gt;

        &lt;startEvent id=&quot;start&quot;/&gt;
        &lt;sequenceFlow id=&quot;flow1&quot; sourceRef=&quot;start&quot; targetRef=&quot;someTask&quot;/&gt;

        &lt;userTask id=&quot;someTask&quot; name=&quot;Activiti is awesome!&quot;/&gt;
        &lt;sequenceFlow id=&quot;flow2&quot; sourceRef=&quot;someTask&quot; targetRef=&quot;end&quot;/&gt;

        &lt;endEvent id=&quot;end&quot;/&gt;

    &lt;/process&gt;

&lt;/definitions&gt;
</code></pre>
<p>即一个开始一个结束一个处理的简单流程图</p>
<figure data-type="image" tabindex="59"><img src="https://fjy8018.gitee.io/images/img/1565359359827.png" alt="1565359359827"></figure>
<p>默认用例执行结果，从日志可知默认过程为加载<code>xml</code>配置并初始化数据库再销毁关闭引擎</p>
<pre><code class="language-bash">09:56:15,843 [main] INFO  org.springframework.beans.factory.xml.XmlBeanDefinitionReader  - Loading XML bean definitions from class path resource [activiti.cfg.xml]
09:56:17,628 [main] INFO  org.activiti.engine.compatibility.DefaultActiviti5CompatibilityHandlerFactory  - Activiti 5 compatibility handler implementation not found or error during instantiation : org.activiti.compatibility.DefaultActiviti5CompatibilityHandler. Activiti 5 backwards compatibility disabled.
09:56:17,644 [main] INFO  org.activiti.engine.impl.db.DbSqlSession  - performing create on engine with resource org/activiti/db/create/activiti.h2.create.engine.sql
09:56:17,702 [main] INFO  org.activiti.engine.impl.db.DbSqlSession  - performing create on history with resource org/activiti/db/create/activiti.h2.create.history.sql
09:56:17,708 [main] INFO  org.activiti.engine.impl.db.DbSqlSession  - performing create on identity with resource org/activiti/db/create/activiti.h2.create.identity.sql
09:56:17,712 [main] INFO  org.activiti.engine.impl.ProcessEngineImpl  - ProcessEngine default created
</code></pre>
<h3 id="mdc日志配置实例"><code>MDC</code>日志配置实例</h3>
<p>按照官方指南配置<code>MDC</code>日志输出格式</p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;

&lt;configuration debug=&quot;false&quot; scan=&quot;true&quot; scanPeriod=&quot;30 seconds&quot;&gt;
    &lt;property name=&quot;log.dir&quot; value=&quot;target/logs&quot;/&gt;
    &lt;property name=&quot;encoding&quot; value=&quot;UTF-8&quot;/&gt;
    &lt;property name=&quot;plain&quot; value=&quot;%msg%n&quot;/&gt;
    &lt;property name=&quot;std&quot; value=&quot;%d{HH:mm:ss.SSS}[%thread][%-5level]%msg %X{}&quot;/&gt;
    &lt;!--&lt;property name=&quot;normal&quot; value=&quot;%d{yyy-MM-dd:HH:mm:ss.SSS}[%thread][%-5level]&quot;/&gt;--&gt;
    &lt;property name=&quot;mdc&quot; value=&quot;ProcessDefinitionId=%X{mdcProcessDefinitionID}
executionId=%X{mdcExecutionId} mdcProcessInstanceID=%X{mdcProcessInstanceID} mdcBusinessKey=%X{mdcBusinessKey} %m%n&quot;/&gt;
    &lt;!-- 控制台输出 --&gt;   
    &lt;appender name=&quot;STDOUT&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;
        &lt;!-- 日志输出编码 --&gt;  
        &lt;Encoding&gt;UTF-8&lt;/Encoding&gt;   
        &lt;encoder&gt;
            &lt;!--&lt;pattern&gt;${plain}&lt;/pattern&gt;--&gt;
            &lt;pattern&gt;${mdc}&lt;/pattern&gt;
            &lt;charset&gt;${encoding}&lt;/charset&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;
    &lt;!-- 日志输出级别 --&gt;
    &lt;root level=&quot;INFO&quot;&gt;  
        &lt;appender-ref ref=&quot;STDOUT&quot;/&gt;
        &lt;appender-ref ref=&quot;FILE&quot;/&gt;
    &lt;/root&gt;

&lt;/configuration&gt;
</code></pre>
<p>使用<code>MDC</code>之后会在日志中看到以下信息</p>
<ul>
<li>流程定义Id 被记录为 <code>mdcProcessDefinitionID</code></li>
<li>流程实例Id 被记录为<code>mdcProcessInstanceID</code></li>
<li>流程执行Id 被记录为<code>mdcExecutionId</code></li>
<li>流程序列Id 被记录为<code>mdcBusinessKey</code></li>
</ul>
<p><strong>注意：<code>MDC</code>日志只有在发生异常时才会被记录</strong></p>
<p>创建异常模拟类</p>
<pre><code class="language-java">package top.fjy8018.activiti.sample.config.delegate;

/**
 * 模拟MDC错误
 *
 * @author F嘉阳
 * @date 2019-08-10 10:23
 */
@Slf4j
public class MDCErrorDelegate implements JavaDelegate {
    @Override
    public void execute(DelegateExecution delegateExecution) {
        log.info(&quot;执行 MDCErrorDelegate&quot;);
        throw new RuntimeException(&quot;模拟MDC异常&quot;);
    }
}
</code></pre>
<p>配置流程图</p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;definitions xmlns=&quot;http://www.omg.org/spec/BPMN/20100524/MODEL&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
             xmlns:activiti=&quot;http://activiti.org/bpmn&quot; xmlns:bpmndi=&quot;http://www.omg.org/spec/BPMN/20100524/DI&quot;
             xmlns:omgdc=&quot;http://www.omg.org/spec/DD/20100524/DC&quot; xmlns:omgdi=&quot;http://www.omg.org/spec/DD/20100524/DI&quot;
             typeLanguage=&quot;http://www.w3.org/2001/XMLSchema&quot; expressionLanguage=&quot;http://www.w3.org/1999/XPath&quot;
             targetNamespace=&quot;http://www.activiti.org/test&quot;&gt;

    &lt;process id=&quot;my-process&quot;&gt;

        &lt;startEvent id=&quot;start&quot;/&gt;
        &lt;sequenceFlow id=&quot;flow1&quot; sourceRef=&quot;start&quot; targetRef=&quot;someTask&quot;/&gt;

&lt;!--        &lt;userTask id=&quot;someTask&quot; name=&quot;Activiti is awesome!&quot;/&gt;--&gt;
        &lt;serviceTask id=&quot;someTask&quot;  activiti:class=&quot;top.fjy8018.activiti.sample.config.delegate.MDCErrorDelegate&quot; /&gt;
        &lt;sequenceFlow id=&quot;flow2&quot; sourceRef=&quot;someTask&quot; targetRef=&quot;end&quot;/&gt;
        &lt;endEvent id=&quot;end&quot;/&gt;

    &lt;/process&gt;
&lt;/definitions&gt;
</code></pre>
<p><strong>注意：脚手架默认提供的<code>xml</code>标签声明无法解析<code>BPMN2.0</code>语法，需要增加标签声明才能正确解析</strong></p>
<p>日志输出结果</p>
<pre><code class="language-bash">ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= Loading XML bean definitions from class path resource [activiti.cfg.xml]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= Activiti 5 compatibility handler implementation not found or error during instantiation : org.activiti.compatibility.DefaultActiviti5CompatibilityHandler. Activiti 5 backwards compatibility disabled.
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= performing create on engine with resource org/activiti/db/create/activiti.h2.create.engine.sql
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= performing create on history with resource org/activiti/db/create/activiti.h2.create.history.sql
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= performing create on identity with resource org/activiti/db/create/activiti.h2.create.identity.sql
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= ProcessEngine default created
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 执行 MDCErrorDelegate
ProcessDefinitionId=my-process:1:3 executionId=5 mdcProcessInstanceID=4 mdcBusinessKey= Error while closing command context
java.lang.RuntimeException: 模拟MDC异常
	at top.fjy8018.activiti.sample.config.delegate.MDCErrorDelegate.execute(MDCErrorDelegate.java:19)
	...
</code></pre>
<h3 id="通过拦截器配置mdc输出">通过拦截器配置<code>MDC</code>输出</h3>
<p>为了实现不修改流程配置文件的情况下实现全局<code>MDC</code>日志输出，可通过内置拦截器实现</p>
<p>配置拦截器</p>
<pre><code class="language-java">package top.fjy8018.activiti.sample.config.interceptor;

/**
 * MDC 日志输出拦截器实现
 * 参考 {@link DebugCommandInvoker} 实现
 *
 * @author F嘉阳
 * @date 2019-08-10 10:46
 */
@Slf4j
public class MDCCommandInvoker extends DebugCommandInvoker {
    @Override
    public void executeOperation(Runnable runnable) {
        boolean mdcEnabled = LogMDC.isMDCEnabled();
        // 启用MDC
        LogMDC.setMDCEnabled(true);
        // 判断是否是流程对象
        if (runnable instanceof AbstractOperation) {
            AbstractOperation operation = (AbstractOperation) runnable;
            if (operation.getExecution() != null) {
                // 放入MDC上下文中
                LogMDC.putMDCExecution(operation.getExecution());
            }
        }
        super.executeOperation(runnable);
        // 清理MDC上下文
        LogMDC.clear();
        // 重置原始配置
        if (!mdcEnabled){
            LogMDC.setMDCEnabled(false);
        }
    }
}
</code></pre>
<p>使用默认流程配置文件<code>my-process.bpmn20.xml</code></p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;definitions xmlns=&quot;http://www.omg.org/spec/BPMN/20100524/MODEL&quot;
             typeLanguage=&quot;http://www.w3.org/2001/XMLSchema&quot; expressionLanguage=&quot;http://www.w3.org/1999/XPath&quot;
             targetNamespace=&quot;http://www.activiti.org/test&quot;&gt;
    &lt;process id=&quot;my-process&quot;&gt;
        &lt;startEvent id=&quot;start&quot;/&gt;
        &lt;sequenceFlow id=&quot;flow1&quot; sourceRef=&quot;start&quot; targetRef=&quot;someTask&quot;/&gt;
        &lt;userTask id=&quot;someTask&quot; name=&quot;Activiti is awesome!&quot;/&gt;
        &lt;sequenceFlow id=&quot;flow2&quot; sourceRef=&quot;someTask&quot; targetRef=&quot;end&quot;/&gt;
        &lt;endEvent id=&quot;end&quot;/&gt;
    &lt;/process&gt;
&lt;/definitions&gt;
</code></pre>
<p>注册拦截器<code>activiti_mdc.cfg.xml</code></p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;
       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans   http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;

    &lt;bean id=&quot;processEngineConfiguration&quot;
          class=&quot;org.activiti.engine.impl.cfg.StandaloneInMemProcessEngineConfiguration&quot;&gt;
        &lt;property name=&quot;commandInvoker&quot; ref=&quot;commandInvoker&quot;/&gt;
    &lt;/bean&gt;

    &lt;bean id=&quot;commandInvoker&quot; class=&quot;top.fjy8018.activiti.sample.config.interceptor.MDCCommandInvoker&quot;/&gt;
&lt;/beans&gt;
</code></pre>
<p>编写单元测试</p>
<pre><code class="language-java">@Slf4j
public class MDCCommandInvokerConfigTest {

    @Rule
    public ActivitiRule activitiRule = new ActivitiRule(&quot;activiti_mdc.cfg.xml&quot;);

    @Test
    @Deployment(resources = {&quot;top/fjy8018.activiti.sample.config/my-process.bpmn20.xml&quot;})
    public void testMDCError() {
        ProcessInstance processInstance = activitiRule.getRuntimeService().startProcessInstanceByKey(&quot;my-process&quot;);
        assertNotNull(processInstance);
        Task task = activitiRule.getTaskService().createTaskQuery().singleResult();
        assertEquals(&quot;Activiti is awesome!&quot;, task.getName());
    }
}
</code></pre>
<p>执行结果</p>
<pre><code class="language-bash">ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= ProcessEngine default created
ProcessDefinitionId=my-process:1:3 executionId=5 mdcProcessInstanceID=4 mdcBusinessKey= Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :
ProcessDefinitionId=my-process:1:3 executionId=5 mdcProcessInstanceID=4 mdcBusinessKey= 
4 (process instance)
└── 5 : start (StartEvent, parent id 4 (active)

ProcessDefinitionId=my-process:1:3 executionId=5 mdcProcessInstanceID=4 mdcBusinessKey= Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation :
ProcessDefinitionId=my-process:1:3 executionId=5 mdcProcessInstanceID=4 mdcBusinessKey= 
4 (process instance)
└── 5 : start (StartEvent, parent id 4 (active)
...
</code></pre>
<p>输出为树形结构，是因为在<code>DebugCommandInvoker</code>源码中通过树形构建输出结果</p>
<pre><code class="language-java">package org.activiti.engine.impl.interceptor;

public class DebugCommandInvoker extends CommandInvoker {
  
  private static final Logger logger = LoggerFactory.getLogger(DebugCommandInvoker.class);
  
  @Override
  public void executeOperation(Runnable runnable) {
    if (runnable instanceof AbstractOperation) {
      AbstractOperation operation = (AbstractOperation) runnable;
      
      if (operation.getExecution() != null) {
        logger.info(&quot;Execution tree while executing operation {} :&quot;, operation.getClass());
        // 通过树形方式构建
        logger.info(&quot;{}&quot;, System.lineSeparator() +  ExecutionTreeUtil.buildExecutionTree(operation.getExecution()));
      }
    } 
    super.executeOperation(runnable);
  }
}
</code></pre>
<h3 id="历史记录配置实例">历史记录配置实例</h3>
<p>历史记录有多个级别，本次模拟流程和对应的输出级别如下</p>
<ol>
<li>
<p>启动流程</p>
</li>
<li>
<p>修改变量</p>
</li>
<li>
<p>提交表单 task—— <code>none</code>级别</p>
</li>
<li>
<p>输出历史内容</p>
</li>
<li>
<p>输出历史活动—— <code>activiti</code>级别</p>
</li>
<li>
<p>输出历史详情 ——<code>full</code>级别（<code>audit</code>级别会缺失部分字段）</p>
</li>
<li>
<p>输出历史表单—— <code>audit</code>级别</p>
</li>
</ol>
<p>单元测试类</p>
<pre><code class="language-java">@Slf4j
public class MDCHistoryLevelConfigTest {

    @Rule
    public ActivitiRule activitiRule = new ActivitiRule(&quot;activiti_history.cfg.xml&quot;);

    @Test
    @Deployment(resources = {&quot;top/fjy8018.activiti.sample.config/my-process.bpmn20.xml&quot;})
    public void testHistoryLevel1() {

        // 启动流程
        Map&lt;String, Object&gt; params = Maps.newHashMap();
        params.put(&quot;keyStart1&quot;, &quot;value1&quot;);
        params.put(&quot;keyStart2&quot;, &quot;value2&quot;);
        // 传入参数
        ProcessInstance processInstance = activitiRule.getRuntimeService().startProcessInstanceByKey(&quot;my-process&quot;, params);

        // 修改变量
        // 分页查询流程执行对象
        List&lt;Execution&gt; executions = activitiRule.getRuntimeService().createExecutionQuery().listPage(0, 100);
        executions.forEach(e -&gt; log.info(&quot;Execution = {}&quot;, e));
        log.info(&quot;Execution 大小 = {}&quot;, executions.size());
        // 通过执行对象查找执行变量
        // 取出第一条记录
        String excutionId = executions.iterator().next().getId();
        activitiRule.getRuntimeService().setVariable(excutionId, &quot;keyStart1&quot;, &quot;updateKey1&quot;);

        // 通过表单提交结束流程
        Task task = activitiRule.getTaskService().createTaskQuery().singleResult();
        Map&lt;String, String&gt; formData = Maps.newHashMap();
        formData.put(&quot;formKey1&quot;, &quot;formValue1&quot;);
        formData.put(&quot;formKey2&quot;, &quot;formValue2&quot;);
        // 提交表单 task 自动结束流程
        activitiRule.getFormService().submitTaskFormData(task.getId(), formData);

        // 输出历史内容
        // 输出历史活动
        printHistoricActivityInstance();

        // 输出历史变量
        printHistoricVariableInstance();

        // 输出历史表单详情
        printHistoricFormDetail();

        // 输出所有历史详情
        printHistoricDetail();

        // 输出历史表单
        printHistoricTaskInstance();
    }

    private void printHistoricTaskInstance() {
        List&lt;HistoricTaskInstance&gt; historicTaskInstances = activitiRule.getHistoryService()
                .createHistoricTaskInstanceQuery()
                .listPage(0, 100);
        historicTaskInstances.forEach(h -&gt; log.info(&quot;历史Task数量 = {}&quot;,h));
        log.info(&quot;历史Task数量={}&quot;,historicTaskInstances.size());
    }

    private void printHistoricDetail() {
        List&lt;HistoricDetail&gt; historicDetails = activitiRule.getHistoryService()
                .createHistoricDetailQuery()
                .listPage(0, 100);
        historicDetails.forEach(h -&gt; log.info(&quot;历史详情 = {}&quot;,historicDetailtoString(h)));
        log.info(&quot;历史详情数量={}&quot;,historicDetails.size());
    }

    private void printHistoricFormDetail() {
        List&lt;HistoricDetail&gt; historicFormDetails = activitiRule.getHistoryService()
                .createHistoricDetailQuery()
                .formProperties()
                .listPage(0, 100);
        historicFormDetails.forEach(h -&gt; log.info(&quot;历史表单 = {}&quot;,h));
        log.info(&quot;历史表单数量={}&quot;,historicFormDetails.size());
    }

    private void printHistoricVariableInstance() {
        List&lt;HistoricVariableInstance&gt; variableInstances = activitiRule.getHistoryService()
                .createHistoricVariableInstanceQuery()
                .listPage(0, 100);
        variableInstances.forEach(v -&gt; log.info(&quot;历史变量 = {}&quot;,v));
        log.info(&quot;历史变量数量={}&quot;,variableInstances.size());
    }

    private void printHistoricActivityInstance() {
        List&lt;HistoricActivityInstance&gt; historicActivityInstances = activitiRule.getHistoryService()
                .createHistoricActivityInstanceQuery()
                .listPage(0, 100);
        historicActivityInstances.forEach(h -&gt; log.info(&quot;历史活动={}&quot;,h));
        log.info(&quot;历史活动数量={}&quot;,historicActivityInstances.size());
    }

    private static String historicDetailtoString(HistoricDetail historicDetail){
        return ToStringBuilder.reflectionToString(historicDetail, ToStringStyle.SHORT_PREFIX_STYLE);
    }
}
</code></pre>
<p>其他配置按照默认即可</p>
<h4 id="默认历史记录级别activiti输出">默认历史记录级别<code>activiti</code>输出</h4>
<pre><code class="language-bash">...
ProcessDefinitionId=my-process:1:3 executionId=7 mdcProcessInstanceID=4 mdcBusinessKey= 
4 (process instance)
└── 7 : end (EndEvent, parent id 4 (active)

ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史活动=HistoricActivityInstanceEntity[id=15, activityId=end, activityName=null]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史活动=HistoricActivityInstanceEntity[id=8, activityId=start, activityName=null]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史活动=HistoricActivityInstanceEntity[id=9, activityId=someTask, activityName=Activiti is awesome!]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史活动数量=3
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量 = HistoricVariableInstanceEntity[id=13, name=formKey2, revision=0, type=string, textValue=formValue2]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量 = HistoricVariableInstanceEntity[id=14, name=formKey1, revision=0, type=string, textValue=formValue1]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量 = HistoricVariableInstanceEntity[id=5, name=keyStart2, revision=0, type=string, textValue=value2]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量 = HistoricVariableInstanceEntity[id=6, name=keyStart1, revision=1, type=string, textValue=updateKey1]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量数量=4
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史表单 = org.activiti.engine.impl.persistence.entity.HistoricFormPropertyEntityImpl@320e400
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史表单 = org.activiti.engine.impl.persistence.entity.HistoricFormPropertyEntityImpl@5167268
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史表单数量=2
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情 = HistoricFormPropertyEntityImpl[propertyId=formKey2,propertyValue=formValue2,processInstanceId=4,activityInstanceId=9,taskId=10,executionId=7,time=Sat Aug 10 16:30:13 CST 2019,detailType=FormProperty,id=11,isInserted=false,isUpdated=false,isDeleted=false]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情 = HistoricFormPropertyEntityImpl[propertyId=formKey1,propertyValue=formValue1,processInstanceId=4,activityInstanceId=9,taskId=10,executionId=7,time=Sat Aug 10 16:30:13 CST 2019,detailType=FormProperty,id=12,isInserted=false,isUpdated=false,isDeleted=false]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情数量=2
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史Task数量 = org.activiti.engine.impl.persistence.entity.HistoricTaskInstanceEntityImpl@3153ddfc
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史Task数量=1
</code></pre>
<p>通过流程配置文件修改日志级别</p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;
       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans   http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;

    &lt;bean id=&quot;processEngineConfiguration&quot;
          class=&quot;org.activiti.engine.impl.cfg.StandaloneInMemProcessEngineConfiguration&quot;&gt;
        &lt;property name=&quot;commandInvoker&quot; ref=&quot;commandInvoker&quot;/&gt;
        &lt;!--历史记录级别--&gt;
        &lt;property name=&quot;history&quot; value=&quot;none&quot;/&gt;
    &lt;/bean&gt;

    &lt;bean id=&quot;commandInvoker&quot; class=&quot;top.fjy8018.activiti.sample.config.interceptor.MDCCommandInvoker&quot;/&gt;
&lt;/beans&gt;
</code></pre>
<h4 id="none历史记录级别输出"><code>none</code>历史记录级别输出</h4>
<pre><code class="language-bash">...
ProcessDefinitionId=my-process:1:3 executionId=7 mdcProcessInstanceID=4 mdcBusinessKey= 
4 (process instance)
└── 7 : end (EndEvent, parent id 4 (active)

ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史活动数量=0
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量数量=0
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史表单数量=0
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情数量=0
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史Task数量=0
</code></pre>
<h4 id="audit历史记录级别输出"><code>audit</code>历史记录级别输出</h4>
<pre><code class="language-bash">...
ProcessDefinitionId=my-process:1:3 executionId=7 mdcProcessInstanceID=4 mdcBusinessKey= 
4 (process instance)
└── 7 : end (EndEvent, parent id 4 (active)

ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史活动=HistoricActivityInstanceEntity[id=15, activityId=end, activityName=null]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史活动=HistoricActivityInstanceEntity[id=8, activityId=start, activityName=null]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史活动=HistoricActivityInstanceEntity[id=9, activityId=someTask, activityName=Activiti is awesome!]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史活动数量=3
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量 = HistoricVariableInstanceEntity[id=13, name=formKey2, revision=0, type=string, textValue=formValue2]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量 = HistoricVariableInstanceEntity[id=14, name=formKey1, revision=0, type=string, textValue=formValue1]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量 = HistoricVariableInstanceEntity[id=5, name=keyStart2, revision=0, type=string, textValue=value2]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量 = HistoricVariableInstanceEntity[id=6, name=keyStart1, revision=1, type=string, textValue=updateKey1]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量数量=4
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史表单 = org.activiti.engine.impl.persistence.entity.HistoricFormPropertyEntityImpl@6d1310f6
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史表单 = org.activiti.engine.impl.persistence.entity.HistoricFormPropertyEntityImpl@3228d990
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史表单数量=2
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情 = HistoricFormPropertyEntityImpl[propertyId=formKey2,propertyValue=formValue2,processInstanceId=4,activityInstanceId=9,taskId=10,executionId=7,time=Sat Aug 10 16:33:28 CST 2019,detailType=FormProperty,id=11,isInserted=false,isUpdated=false,isDeleted=false]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情 = HistoricFormPropertyEntityImpl[propertyId=formKey1,propertyValue=formValue1,processInstanceId=4,activityInstanceId=9,taskId=10,executionId=7,time=Sat Aug 10 16:33:28 CST 2019,detailType=FormProperty,id=12,isInserted=false,isUpdated=false,isDeleted=false]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情数量=2
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史Task数量 = org.activiti.engine.impl.persistence.entity.HistoricTaskInstanceEntityImpl@3c321bdb
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史Task数量=1
</code></pre>
<h4 id="full历史记录级别输出"><code>full</code>历史记录级别输出</h4>
<p><code>full</code>级别历史记录详情更加丰富</p>
<pre><code class="language-bash">...
ProcessDefinitionId=my-process:1:3 executionId=9 mdcProcessInstanceID=4 mdcBusinessKey= 
4 (process instance)
└── 9 : end (EndEvent, parent id 4 (active)

ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史活动=HistoricActivityInstanceEntity[id=10, activityId=start, activityName=null]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史活动=HistoricActivityInstanceEntity[id=11, activityId=someTask, activityName=Activiti is awesome!]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史活动=HistoricActivityInstanceEntity[id=20, activityId=end, activityName=null]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史活动数量=3
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量 = HistoricVariableInstanceEntity[id=16, name=formKey2, revision=0, type=string, textValue=formValue2]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量 = HistoricVariableInstanceEntity[id=18, name=formKey1, revision=0, type=string, textValue=formValue1]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量 = HistoricVariableInstanceEntity[id=5, name=keyStart2, revision=0, type=string, textValue=value2]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量 = HistoricVariableInstanceEntity[id=7, name=keyStart1, revision=1, type=string, textValue=updateKey1]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量数量=4
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史表单 = org.activiti.engine.impl.persistence.entity.HistoricFormPropertyEntityImpl@6d1310f6
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史表单 = org.activiti.engine.impl.persistence.entity.HistoricFormPropertyEntityImpl@3228d990
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史表单数量=2
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情 = HistoricDetailVariableInstanceUpdateEntityImpl[revision=1,name=keyStart1,variableType=org.activiti.engine.impl.variable.StringType@24855019,longValue=&lt;null&gt;,doubleValue=&lt;null&gt;,textValue=updateKey1,textValue2=&lt;null&gt;,byteArrayRef=ByteArrayRef[id=null, name=null, entity=null],cachedValue=&lt;null&gt;,processInstanceId=4,activityInstanceId=&lt;null&gt;,taskId=&lt;null&gt;,executionId=4,time=Sat Aug 10 16:33:57 CST 2019,detailType=VariableUpdate,id=13,isInserted=false,isUpdated=false,isDeleted=false]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情 = HistoricFormPropertyEntityImpl[propertyId=formKey2,propertyValue=formValue2,processInstanceId=4,activityInstanceId=11,taskId=12,executionId=9,time=Sat Aug 10 16:33:57 CST 2019,detailType=FormProperty,id=14,isInserted=false,isUpdated=false,isDeleted=false]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情 = HistoricFormPropertyEntityImpl[propertyId=formKey1,propertyValue=formValue1,processInstanceId=4,activityInstanceId=11,taskId=12,executionId=9,time=Sat Aug 10 16:33:57 CST 2019,detailType=FormProperty,id=15,isInserted=false,isUpdated=false,isDeleted=false]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情 = HistoricDetailVariableInstanceUpdateEntityImpl[revision=0,name=formKey2,variableType=org.activiti.engine.impl.variable.StringType@24855019,longValue=&lt;null&gt;,doubleValue=&lt;null&gt;,textValue=formValue2,textValue2=&lt;null&gt;,byteArrayRef=ByteArrayRef[id=null, name=null, entity=null],cachedValue=&lt;null&gt;,processInstanceId=4,activityInstanceId=11,taskId=&lt;null&gt;,executionId=4,time=Sat Aug 10 16:33:57 CST 2019,detailType=VariableUpdate,id=17,isInserted=false,isUpdated=false,isDeleted=false]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情 = HistoricDetailVariableInstanceUpdateEntityImpl[revision=0,name=formKey1,variableType=org.activiti.engine.impl.variable.StringType@24855019,longValue=&lt;null&gt;,doubleValue=&lt;null&gt;,textValue=formValue1,textValue2=&lt;null&gt;,byteArrayRef=ByteArrayRef[id=null, name=null, entity=null],cachedValue=&lt;null&gt;,processInstanceId=4,activityInstanceId=11,taskId=&lt;null&gt;,executionId=4,time=Sat Aug 10 16:33:57 CST 2019,detailType=VariableUpdate,id=19,isInserted=false,isUpdated=false,isDeleted=false]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情 = HistoricDetailVariableInstanceUpdateEntityImpl[revision=0,name=keyStart2,variableType=org.activiti.engine.impl.variable.StringType@24855019,longValue=&lt;null&gt;,doubleValue=&lt;null&gt;,textValue=value2,textValue2=&lt;null&gt;,byteArrayRef=ByteArrayRef[id=null, name=null, entity=null],cachedValue=&lt;null&gt;,processInstanceId=4,activityInstanceId=&lt;null&gt;,taskId=&lt;null&gt;,executionId=4,time=Sat Aug 10 16:33:56 CST 2019,detailType=VariableUpdate,id=6,isInserted=false,isUpdated=false,isDeleted=false]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情 = HistoricDetailVariableInstanceUpdateEntityImpl[revision=0,name=keyStart1,variableType=org.activiti.engine.impl.variable.StringType@24855019,longValue=&lt;null&gt;,doubleValue=&lt;null&gt;,textValue=value1,textValue2=&lt;null&gt;,byteArrayRef=ByteArrayRef[id=null, name=null, entity=null],cachedValue=&lt;null&gt;,processInstanceId=4,activityInstanceId=&lt;null&gt;,taskId=&lt;null&gt;,executionId=4,time=Sat Aug 10 16:33:56 CST 2019,detailType=VariableUpdate,id=8,isInserted=false,isUpdated=false,isDeleted=false]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情数量=7
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史Task数量 = org.activiti.engine.impl.persistence.entity.HistoricTaskInstanceEntityImpl@3aaf4f07
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史Task数量=1
</code></pre>
<h3 id="事件及监听器配置">事件及监听器配置</h3>
<p>配置开启事件日志</p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;
       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans   http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;

    &lt;bean id=&quot;processEngineConfiguration&quot;
          class=&quot;org.activiti.engine.impl.cfg.StandaloneInMemProcessEngineConfiguration&quot;&gt;
        &lt;property name=&quot;commandInvoker&quot; ref=&quot;commandInvoker&quot;/&gt;
        &lt;!--开启事件日志--&gt;
        &lt;property name=&quot;enableDatabaseEventLogging&quot; value=&quot;true&quot;/&gt;
    &lt;/bean&gt;

    &lt;bean id=&quot;commandInvoker&quot; class=&quot;top.fjy8018.activiti.sample.config.interceptor.MDCCommandInvoker&quot;/&gt;
&lt;/beans&gt;
</code></pre>
<p><code>ManagementService</code>接口提供了两方式查询事件日志</p>
<pre><code class="language-java">package org.activiti.engine;

public interface ManagementService {

	List&lt;EventLogEntry&gt; getEventLogEntries(Long startLogNr, Long pageSize);

	List&lt;EventLogEntry&gt; getEventLogEntriesByProcessInstanceId(String processInstanceId);
    
}
</code></pre>
<p>由于<code>EventLogEntryEntityImpl</code>默认的<code>toString</code>只打印时间戳，真实数据存储在data字段中，故需要从字节数组构造字符串对象</p>
<pre><code class="language-java">package org.activiti.engine.impl.persistence.entity;

public class EventLogEntryEntityImpl extends AbstractEntityNoRevision implements EventLogEntryEntity {
	
	public byte[] getData() {
	  return data;
	}

	@Override
	public String toString() {
	  return timeStamp.toString() + &quot; : &quot; + type;
	}
}
</code></pre>
<p>编写单元测试输出事件日志</p>
<pre><code class="language-java">@Slf4j
public class EventLogConfigTest {

    @Rule
    public ActivitiRule activitiRule = new ActivitiRule(&quot;activiti_event_log.cfg.xml&quot;);

    @Test
    @Deployment(resources = {&quot;top/fjy8018.activiti.sample.config/my-process.bpmn20.xml&quot;})
    public void testMDCError() {
        ProcessInstance processInstance = activitiRule.getRuntimeService().startProcessInstanceByKey(&quot;my-process&quot;);
        Task task = activitiRule.getTaskService().createTaskQuery().singleResult();
        activitiRule.getTaskService().complete(task.getId());

        // 遍历事件日志
        List&lt;EventLogEntry&gt; logEntries = activitiRule.getManagementService()
                .getEventLogEntriesByProcessInstanceId(processInstance.getProcessInstanceId());
        logEntries.forEach(l -&gt; log.info(&quot;事件日志 类型 = {} 数据 = {}&quot;,l.getType(),new String(l.getData())));
        log.info(&quot;事件日志数量 {}&quot;,logEntries.size());
    }
}
</code></pre>
<p>输出结果</p>
<pre><code class="language-bash">ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 事件日志 类型 = PROCESSINSTANCE_START 数据 = {&quot;timeStamp&quot;:1565434004723,&quot;processDefinitionId&quot;:&quot;my-process:1:3&quot;,&quot;createTime&quot;:1565434004723,&quot;id&quot;:&quot;4&quot;}
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 事件日志 类型 = ACTIVITY_STARTED 数据 = {&quot;timeStamp&quot;:1565434004728,&quot;activityId&quot;:&quot;start&quot;,&quot;processDefinitionId&quot;:&quot;my-process:1:3&quot;,&quot;processInstanceId&quot;:&quot;4&quot;,&quot;executionId&quot;:&quot;5&quot;,&quot;behaviorClass&quot;:&quot;org.activiti.engine.impl.bpmn.behavior.NoneStartEventActivityBehavior&quot;,&quot;activityType&quot;:&quot;startEvent&quot;}
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 事件日志 类型 = ACTIVITY_COMPLETED 数据 = {&quot;timeStamp&quot;:1565434004731,&quot;activityId&quot;:&quot;start&quot;,&quot;processDefinitionId&quot;:&quot;my-process:1:3&quot;,&quot;processInstanceId&quot;:&quot;4&quot;,&quot;executionId&quot;:&quot;5&quot;,&quot;behaviorClass&quot;:&quot;org.activiti.engine.impl.bpmn.behavior.NoneStartEventActivityBehavior&quot;,&quot;activityType&quot;:&quot;startEvent&quot;}
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 事件日志 类型 = SEQUENCEFLOW_TAKEN 数据 = {&quot;targetActivityId&quot;:&quot;someTask&quot;,&quot;timeStamp&quot;:1565434004734,&quot;targetActivityBehaviorClass&quot;:&quot;org.activiti.engine.impl.bpmn.behavior.UserTaskActivityBehavior&quot;,&quot;sourceActivityType&quot;:&quot;org.activiti.bpmn.model.StartEvent&quot;,&quot;targetActivityName&quot;:&quot;Activiti is awesome!&quot;,&quot;id&quot;:&quot;flow1&quot;,&quot;sourceActivityBehaviorClass&quot;:&quot;org.activiti.engine.impl.bpmn.behavior.NoneStartEventActivityBehavior&quot;,&quot;targetActivityType&quot;:&quot;org.activiti.bpmn.model.UserTask&quot;,&quot;sourceActivityId&quot;:&quot;start&quot;}
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 事件日志 类型 = ACTIVITY_STARTED 数据 = {&quot;timeStamp&quot;:1565434004734,&quot;activityId&quot;:&quot;someTask&quot;,&quot;processDefinitionId&quot;:&quot;my-process:1:3&quot;,&quot;processInstanceId&quot;:&quot;4&quot;,&quot;executionId&quot;:&quot;5&quot;,&quot;behaviorClass&quot;:&quot;org.activiti.engine.impl.bpmn.behavior.UserTaskActivityBehavior&quot;,&quot;activityName&quot;:&quot;Activiti is awesome!&quot;,&quot;activityType&quot;:&quot;userTask&quot;}
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 事件日志 类型 = TASK_CREATED 数据 = {&quot;timeStamp&quot;:1565434004752,&quot;taskDefinitionKey&quot;:&quot;someTask&quot;,&quot;processDefinitionId&quot;:&quot;my-process:1:3&quot;,&quot;processInstanceId&quot;:&quot;4&quot;,&quot;executionId&quot;:&quot;5&quot;,&quot;createTime&quot;:1565434004735,&quot;name&quot;:&quot;Activiti is awesome!&quot;,&quot;id&quot;:&quot;8&quot;,&quot;priority&quot;:50}
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 事件日志 类型 = TASK_COMPLETED 数据 = {&quot;duration&quot;:141,&quot;timeStamp&quot;:1565434004876,&quot;taskDefinitionKey&quot;:&quot;someTask&quot;,&quot;processDefinitionId&quot;:&quot;my-process:1:3&quot;,&quot;processInstanceId&quot;:&quot;4&quot;,&quot;executionId&quot;:&quot;5&quot;,&quot;createTime&quot;:1565434004735,&quot;name&quot;:&quot;Activiti is awesome!&quot;,&quot;id&quot;:&quot;8&quot;,&quot;priority&quot;:50}
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 事件日志 类型 = ACTIVITY_COMPLETED 数据 = {&quot;timeStamp&quot;:1565434004886,&quot;activityId&quot;:&quot;someTask&quot;,&quot;processDefinitionId&quot;:&quot;my-process:1:3&quot;,&quot;processInstanceId&quot;:&quot;4&quot;,&quot;executionId&quot;:&quot;5&quot;,&quot;behaviorClass&quot;:&quot;org.activiti.engine.impl.bpmn.behavior.UserTaskActivityBehavior&quot;,&quot;activityName&quot;:&quot;Activiti is awesome!&quot;,&quot;activityType&quot;:&quot;userTask&quot;}
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 事件日志 类型 = SEQUENCEFLOW_TAKEN 数据 = {&quot;targetActivityId&quot;:&quot;end&quot;,&quot;timeStamp&quot;:1565434004886,&quot;sourceActivityName&quot;:&quot;Activiti is awesome!&quot;,&quot;targetActivityBehaviorClass&quot;:&quot;org.activiti.engine.impl.bpmn.behavior.NoneEndEventActivityBehavior&quot;,&quot;sourceActivityType&quot;:&quot;org.activiti.bpmn.model.UserTask&quot;,&quot;id&quot;:&quot;flow2&quot;,&quot;sourceActivityBehaviorClass&quot;:&quot;org.activiti.engine.impl.bpmn.behavior.UserTaskActivityBehavior&quot;,&quot;targetActivityType&quot;:&quot;org.activiti.bpmn.model.EndEvent&quot;,&quot;sourceActivityId&quot;:&quot;someTask&quot;}
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 事件日志 类型 = ACTIVITY_STARTED 数据 = {&quot;timeStamp&quot;:1565434004886,&quot;activityId&quot;:&quot;end&quot;,&quot;processDefinitionId&quot;:&quot;my-process:1:3&quot;,&quot;processInstanceId&quot;:&quot;4&quot;,&quot;executionId&quot;:&quot;5&quot;,&quot;behaviorClass&quot;:&quot;org.activiti.engine.impl.bpmn.behavior.NoneEndEventActivityBehavior&quot;,&quot;activityType&quot;:&quot;endEvent&quot;}
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 事件日志 类型 = ACTIVITY_COMPLETED 数据 = {&quot;timeStamp&quot;:1565434004887,&quot;activityId&quot;:&quot;end&quot;,&quot;processDefinitionId&quot;:&quot;my-process:1:3&quot;,&quot;processInstanceId&quot;:&quot;4&quot;,&quot;executionId&quot;:&quot;5&quot;,&quot;behaviorClass&quot;:&quot;org.activiti.engine.impl.bpmn.behavior.NoneEndEventActivityBehavior&quot;,&quot;activityType&quot;:&quot;endEvent&quot;}
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 事件日志 类型 = PROCESSINSTANCE_END 数据 = {&quot;timeStamp&quot;:1565434004894,&quot;processDefinitionId&quot;:&quot;my-process:1:3&quot;,&quot;id&quot;:&quot;4&quot;,&quot;endTime&quot;:1565434004894}
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 事件日志数量 12
</code></pre>
<p>核心信息</p>
<pre><code class="language-bash">事件日志 类型 = PROCESSINSTANCE_START 
事件日志 类型 = ACTIVITY_STARTED 
事件日志 类型 = ACTIVITY_COMPLETED 
事件日志 类型 = SEQUENCEFLOW_TAKEN 
事件日志 类型 = ACTIVITY_STARTED 
事件日志 类型 = TASK_CREATED 
事件日志 类型 = TASK_COMPLETED 
事件日志 类型 = ACTIVITY_COMPLETED 
事件日志 类型 = SEQUENCEFLOW_TAKEN 
事件日志 类型 = ACTIVITY_STARTED 
事件日志 类型 = ACTIVITY_COMPLETED 
事件日志 类型 = PROCESSINSTANCE_END 
事件日志数量 12
</code></pre>
<p>解析</p>
<ul>
<li>
<p><code>PROCESSINSTANCE_START</code> 流程开始</p>
</li>
<li>
<p><code>ACTIVITY_STARTED</code> 节点开始——开始节点</p>
</li>
<li>
<p><code>ACTIVITY_COMPLETED</code> 节点完成</p>
</li>
<li>
<p><code>SEQUENCEFLOW_TAKEN</code> 数据流</p>
</li>
<li>
<p><code>ACTIVITY_STARTED</code>节点开始——处理节点</p>
</li>
<li>
<p><code>TASK_CREATED</code> 任务开始</p>
</li>
<li>
<p><code>TASK_COMPLETED</code> 任务完成</p>
</li>
<li>
<p><code>ACTIVITY_COMPLETED</code> 节点完成</p>
</li>
<li>
<p><code>SEQUENCEFLOW_TAKEN</code>数据流</p>
</li>
<li>
<p><code>ACTIVITY_STARTED</code>节点开始——结束节点</p>
</li>
<li>
<p><code>ACTIVITY_COMPLETED</code>节点完成</p>
</li>
<li>
<p><code>PROCESSINSTANCE_END</code>流程完成</p>
</li>
</ul>
<h4 id="源码分析-2">源码分析</h4>
<p>配置入口在<code>ProcessEngineConfigurationImpl</code>类中</p>
<pre><code class="language-java">package org.activiti.engine.impl.cfg;

public abstract class ProcessEngineConfigurationImpl extends ProcessEngineConfiguration {
	public void initDatabaseEventLogging() {
	  if (enableDatabaseEventLogging) {
	  	// 启用则创建事件监听器
	    getEventDispatcher().addEventListener(new EventLogger(clock, objectMapper));
	  }
	}

	public ProcessEngineConfigurationImpl setEnableDatabaseEventLogging(boolean enableDatabaseEventLogging) {
	  this.enableDatabaseEventLogging = enableDatabaseEventLogging;
	  return this;
	}
}
</code></pre>
<p>事件日志中定义了输出常量和对应的处理器</p>
<pre><code class="language-java">package org.activiti.engine.impl.event.logger;

public class EventLogger implements ActivitiEventListener {
	protected void initializeDefaultHandlers() {
	  addEventHandler(ActivitiEventType.TASK_CREATED, TaskCreatedEventHandler.class);
		addEventHandler(ActivitiEventType.TASK_COMPLETED, TaskCompletedEventHandler.class);
		addEventHandler(ActivitiEventType.TASK_ASSIGNED, TaskAssignedEventHandler.class);
		
		addEventHandler(ActivitiEventType.SEQUENCEFLOW_TAKEN, SequenceFlowTakenEventHandler.class);
		
		addEventHandler(ActivitiEventType.ACTIVITY_COMPLETED, ActivityCompletedEventHandler.class);
		addEventHandler(ActivitiEventType.ACTIVITY_STARTED, ActivityStartedEventHandler.class);
		addEventHandler(ActivitiEventType.ACTIVITY_SIGNALED, ActivitySignaledEventHandler.class);
		addEventHandler(ActivitiEventType.ACTIVITY_MESSAGE_RECEIVED, ActivityMessageEventHandler.class);
		addEventHandler(ActivitiEventType.ACTIVITY_COMPENSATE, ActivityCompensatedEventHandler.class);
		addEventHandler(ActivitiEventType.ACTIVITY_ERROR_RECEIVED, ActivityErrorReceivedEventHandler.class);
		
		addEventHandler(ActivitiEventType.VARIABLE_CREATED, VariableCreatedEventHandler.class);
		addEventHandler(ActivitiEventType.VARIABLE_DELETED, VariableDeletedEventHandler.class);
		addEventHandler(ActivitiEventType.VARIABLE_UPDATED, VariableUpdatedEventHandler.class);
  	}
	
	@Override
	public void onEvent(ActivitiEvent event) {
		EventLoggerEventHandler eventHandler = getEventHandler(event);
		if (eventHandler != null) {

			// 当命令行上下文关闭时事件才刷新
			CommandContext currentCommandContext = Context.getCommandContext();
			EventFlusher eventFlusher = (EventFlusher) currentCommandContext.getAttribute(EVENT_FLUSHER_KEY);
			
			if (eventFlusher == null) {
				
				eventFlusher = createEventFlusher();
				if (eventFlusher == null) {
					// 默认写入数据库
					eventFlusher = new DatabaseEventFlusher(); 
				}
				currentCommandContext.addAttribute(EVENT_FLUSHER_KEY, eventFlusher);
				
				currentCommandContext.addCloseListener(eventFlusher);
				currentCommandContext
				    .addCloseListener(new CommandContextCloseListener() {

					    @Override
					    public void closing(CommandContext commandContext) {
					    }

					    @Override
					    public void closed(CommandContext commandContext) {
						    // 关闭时广播事件并记录日志
								if (listeners != null) {
									for (EventLoggerListener listener : listeners) {
										listener.eventsAdded(EventLogger.this);
									}
								}
					    }

              public void afterSessionsFlush(CommandContext commandContext) {
              }

              @Override
              public void closeFailure(CommandContext commandContext) {
              }
					    
				    });
			}

			eventFlusher.addEventHandler(eventHandler);
		}
	}
}
</code></pre>
<p>不同的事件监听的内容不同，以<code>TaskCreatedEventHandler</code>为例</p>
<pre><code class="language-java">package org.activiti.engine.impl.event.logger.handler;

public class TaskCreatedEventHandler extends AbstractTaskEventHandler {

	@Override
	public EventLogEntryEntity generateEventLogEntry(CommandContext commandContext) {
	  TaskEntity task = (TaskEntity) ((ActivitiEntityEvent) event).getEntity();
	  Map&lt;String, Object&gt; data = handleCommonTaskFields(task);
	  // 需要写入数据库的信息
	  return createEventLogEntry(task.getProcessDefinitionId(), task.getProcessInstanceId(), task.getExecutionId(), task.getId(), data);
	}

}

</code></pre>
<p>数据库写入逻辑</p>
<pre><code class="language-java">package org.activiti.engine.impl.event.logger;

public class DatabaseEventFlusher extends AbstractEventFlusher {

  private static final Logger logger = LoggerFactory.getLogger(DatabaseEventFlusher.class);

  @Override
  public void closing(CommandContext commandContext) {
    
    if (commandContext.getException() != null) {
      return;
    }
    
    EventLogEntryEntityManager eventLogEntryEntityManager = commandContext.getEventLogEntryEntityManager();
    for (EventLoggerEventHandler eventHandler : eventHandlers) {
      try {
        eventLogEntryEntityManager.insert(eventHandler.generateEventLogEntry(commandContext), false);
      } catch (Exception e) {
        logger.warn(&quot;Could not create event log&quot;, e);
      }
    }
  }
  public void afterSessionsFlush(CommandContext commandContext) {}
  public void closeFailure(CommandContext commandContext) {}
}
</code></pre>

                                </div>
                    </article>
                    <!--  -->
                    
                        <div class="next-post">
                            <div class="next">下一篇</div>
                            <a href="https://fjiayang.github.io//post/shi-yong-github-he-dockerhub-zi-dong-gou-jian-jing-xiang">
                                <h3 class="post-title">
                                    使用GitHub和DockerHub自动构建镜像
                                </h3>
                            </a>
                        </div>
                        
                            <div id="disqus_thread"></div>
                            <div id="gitalk-container"></div>
                </div>
                <!-- middle -->
                <div class="main-container-middle"></div>
                <!-- right -->
                <div id="sidebar" class="main-container-right">
                    
                        <!-- toc -->
                        
    <div class="toc-card i-card ">
        <div class="toc-title i-card-title">目录</div>
        <div class="toc-content">
            <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E6%A6%82%E8%A7%88">概览</a>
<ul>
<li><a href="#%E6%B5%81%E7%A8%8B%E5%BC%95%E6%93%8E%E9%85%8D%E7%BD%AE">流程引擎配置</a></li>
<li><a href="#%E6%A0%B8%E5%BF%83api">核心<code>API</code></a></li>
<li><a href="#%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E8%AE%BE%E8%AE%A1">数据模型设计</a></li>
<li><a href="#bpmn-20"><code>BPMN</code> 2.0</a>
<ul>
<li><a href="#%E7%AE%80%E4%BB%8B">简介</a></li>
<li><a href="#%E7%AC%A6%E5%8F%B7">符号</a></li>
</ul>
</li>
<li><a href="#%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2">快速部署</a></li>
<li><a href="#%E7%AE%80%E5%8D%95%E6%B5%81%E7%A8%8B%E8%AE%BE%E8%AE%A1">简单流程设计</a>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7">创建用户</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B">创建流程</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE%E7%94%A8%E6%88%B7%E7%8A%B6%E6%80%81">配置用户状态</a></li>
<li><a href="#%E4%BF%9D%E5%AD%98%E6%A8%A1%E5%9E%8B">保存模型</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E5%BA%94%E7%94%A8">创建应用</a></li>
</ul>
</li>
<li><a href="#%E7%AE%80%E5%8D%95%E6%B5%81%E7%A8%8B%E6%89%A7%E8%A1%8C">简单流程执行</a>
<ul>
<li><a href="#%E5%8F%91%E8%B5%B7%E6%B5%81%E7%A8%8B">发起流程</a></li>
<li><a href="#%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B">启动流程</a></li>
<li><a href="#%E5%AE%A1%E6%89%B9">审批</a></li>
<li><a href="#%E6%B5%81%E7%A8%8B%E7%BB%93%E6%9D%9F">流程结束</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E6%A0%B8%E5%BF%83%E6%A8%A1%E5%9D%97%E5%88%86%E6%9E%90">核心模块分析</a>
<ul>
<li><a href="#%E6%A0%B8%E5%BF%83%E6%A8%A1%E5%9D%97">核心模块</a></li>
<li><a href="#%E5%9F%BA%E4%BA%8E%E6%BA%90%E7%A0%81%E8%BF%90%E8%A1%8Cactiviti-app">基于源码运行<code>Activiti App</code></a>
<ul>
<li><a href="#%E6%A8%A1%E5%9D%97%E7%BB%93%E6%9E%84%E5%9B%BE">模块结构图</a></li>
<li><a href="#%E6%A8%A1%E5%9D%97%E5%8A%9F%E8%83%BD">模块功能</a></li>
<li><a href="#%E5%90%AF%E5%8A%A8">启动</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90">源码分析</a>
<ul>
<li><a href="#webconfigurer%E6%BA%90%E7%A0%81"><code>WebConfigurer</code>源码</a></li>
<li><a href="#applicationconfiguration%E6%BA%90%E7%A0%81"><code>ApplicationConfiguration</code>源码</a></li>
<li><a href="#appdispatcherservletconfiguration%E6%BA%90%E7%A0%81"><code>AppDispatcherServletConfiguration</code>源码</a></li>
<li><a href="#%E5%88%A9%E7%94%A8%E6%BA%90%E7%A0%81%E5%B7%A5%E5%85%B7%E5%88%9B%E5%BB%BAmaven%E8%84%9A%E6%89%8B%E6%9E%B6">利用源码工具创建Maven脚手架</a></li>
</ul>
</li>
<li><a href="#%E9%80%9A%E8%BF%87%E7%BC%96%E7%A0%81%E6%96%B9%E5%BC%8F%E8%AE%BE%E8%AE%A1%E6%B5%81%E7%A8%8B">通过编码方式设计流程</a>
<ul>
<li><a href="#%E8%AE%BE%E8%AE%A1%E6%B5%81%E7%A8%8B%E5%9B%BE">设计流程图</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE%E6%B5%81%E7%A8%8B%E5%9B%BE">配置流程图</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E5%B7%A5%E7%A8%8B">创建工程</a></li>
<li><a href="#%E5%B7%A5%E7%A8%8B%E6%BA%90%E7%A0%81">工程源码</a></li>
<li><a href="#maven%E6%89%93%E5%8C%85">maven打包</a></li>
<li><a href="#%E6%89%A7%E8%A1%8C">执行</a></li>
</ul>
</li>
<li><a href="#%E6%B5%81%E7%A8%8B%E5%88%9B%E5%BB%BA%E5%BC%95%E6%93%8E%E9%85%8D%E7%BD%AE">流程创建引擎配置</a>
<ul>
<li><a href="#%E5%BC%95%E6%93%8E%E9%85%8D%E7%BD%AE%E7%BB%93%E6%9E%84%E5%9B%BE">引擎配置结构图</a></li>
<li><a href="#processengineconfiguration%E6%BA%90%E7%A0%81"><code>ProcessEngineConfiguration</code>源码</a></li>
<li><a href="#%E4%B8%8D%E5%90%8C%E9%85%8D%E7%BD%AE%E5%B7%AE%E5%BC%82">不同配置差异</a>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BA%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE">创建默认配置</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E7%8B%AC%E7%AB%8B%E5%BC%95%E6%93%8E%E5%AF%B9%E8%B1%A1">创建独立引擎对象</a></li>
<li><a href="#%E7%BB%93%E6%9E%9C%E5%88%86%E6%9E%90">结果分析</a></li>
</ul>
</li>
<li><a href="#%E9%85%8D%E7%BD%AE%E5%BC%95%E6%93%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90">配置引擎源码分析</a>
<ul>
<li><a href="#%E9%A1%B6%E7%BA%A7%E6%8A%BD%E8%B1%A1%E9%85%8D%E7%BD%AE%E7%B1%BBprocessengineconfiguration">顶级抽象配置类<code>ProcessEngineConfiguration</code></a></li>
<li><a href="#%E9%BB%98%E8%AE%A4%E5%AE%9E%E7%8E%B0%E6%8A%BD%E8%B1%A1%E7%B1%BBprocessengineconfigurationimpl">默认实现抽象类<code>ProcessEngineConfigurationImpl</code></a></li>
<li><a href="#%E7%8B%AC%E7%AB%8B%E5%BC%95%E6%93%8E%E9%85%8D%E7%BD%AE%E7%B1%BBstandaloneprocessengineconfiguration">独立引擎配置类<code>StandaloneProcessEngineConfiguration</code></a></li>
<li><a href="#%E5%86%85%E5%AD%98%E5%BC%95%E6%93%8E%E9%85%8D%E7%BD%AE%E7%B1%BBstandaloneinmemprocessengineconfiguration">内存引擎配置类<code>StandaloneInMemProcessEngineConfiguration</code></a></li>
<li><a href="#spring%E9%9B%86%E6%88%90%E9%85%8D%E7%BD%AE%E7%B1%BBspringprocessengineconfiguration">Spring集成配置类<code>SpringProcessEngineConfiguration</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BC%95%E6%93%8E%E9%85%8D%E7%BD%AE">数据库引擎配置</a>
<ul>
<li><a href="#%E5%8F%AF%E9%80%89%E9%85%8D%E7%BD%AE">可选配置</a></li>
<li><a href="#60%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%AF%E6%8C%81%E5%88%97%E8%A1%A8">6.0数据库支持列表</a></li>
<li><a href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5">数据库更新策略</a>
<ul>
<li><a href="#standaloneinmemprocessengineconfiguration%E5%86%85%E5%AD%98%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BC%95%E6%93%8E%E6%BA%90%E7%A0%81"><code>StandaloneInMemProcessEngineConfiguration</code>内存数据库引擎源码</a></li>
</ul>
</li>
<li><a href="#%E9%85%8D%E7%BD%AEmysql%E6%95%B0%E6%8D%AE%E5%BA%93">配置<code>MySQL</code>数据库</a></li>
<li><a href="#%E9%85%8D%E7%BD%AEdruid%E8%BF%9E%E6%8E%A5%E6%B1%A0">配置Druid连接池</a></li>
<li><a href="#%E9%85%8D%E7%BD%AEhikaricp%E8%BF%9E%E6%8E%A5%E6%B1%A0">配置<code>HikariCP</code>连接池</a></li>
<li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE%E6%BA%90%E8%BF%9E%E6%8E%A5%E6%B1%A0%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90">初始化数据源连接池源码分析</a></li>
<li><a href="#%E5%85%B6%E4%BD%99%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE%E9%A1%B9">其余常用配置项</a></li>
</ul>
</li>
<li><a href="#%E6%97%A5%E5%BF%97%E5%92%8C%E6%95%B0%E6%8D%AE%E8%AE%B0%E5%BD%95%E9%85%8D%E7%BD%AE">日志和数据记录配置</a>
<ul>
<li><a href="#%E6%97%A5%E5%BF%97%E7%BB%84%E4%BB%B6%E7%9A%84%E5%85%B3%E7%B3%BB%E5%8F%8Amdc">日志组件的关系及<code>MDC</code></a>
<ul>
<li><a href="#%E6%97%A5%E5%BF%97%E7%BB%84%E4%BB%B6%E7%9A%84%E5%85%B3%E7%B3%BB">日志组件的关系</a></li>
<li><a href="#mdc"><code>MDC</code></a></li>
</ul>
</li>
<li><a href="#%E9%85%8D%E7%BD%AE%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95%E7%BA%A7%E5%88%ABhistorylevel">配置历史记录级别(<code>HistoryLevel</code>)</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE%E5%9F%BA%E4%BA%8Edb%E7%9A%84%E4%BA%8B%E4%BB%B6%E6%97%A5%E5%BF%97event-logging">配置基于db的事件日志(<code>Event logging</code>)</a></li>
<li><a href="#%E9%BB%98%E8%AE%A4%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE%E5%AE%9E%E4%BE%8B">默认日志配置实例</a></li>
<li><a href="#mdc%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE%E5%AE%9E%E4%BE%8B"><code>MDC</code>日志配置实例</a></li>
<li><a href="#%E9%80%9A%E8%BF%87%E6%8B%A6%E6%88%AA%E5%99%A8%E9%85%8D%E7%BD%AEmdc%E8%BE%93%E5%87%BA">通过拦截器配置<code>MDC</code>输出</a></li>
<li><a href="#%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95%E9%85%8D%E7%BD%AE%E5%AE%9E%E4%BE%8B">历史记录配置实例</a>
<ul>
<li><a href="#%E9%BB%98%E8%AE%A4%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95%E7%BA%A7%E5%88%ABactiviti%E8%BE%93%E5%87%BA">默认历史记录级别<code>activiti</code>输出</a></li>
<li><a href="#none%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95%E7%BA%A7%E5%88%AB%E8%BE%93%E5%87%BA"><code>none</code>历史记录级别输出</a></li>
<li><a href="#audit%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95%E7%BA%A7%E5%88%AB%E8%BE%93%E5%87%BA"><code>audit</code>历史记录级别输出</a></li>
<li><a href="#full%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95%E7%BA%A7%E5%88%AB%E8%BE%93%E5%87%BA"><code>full</code>历史记录级别输出</a></li>
</ul>
</li>
<li><a href="#%E4%BA%8B%E4%BB%B6%E5%8F%8A%E7%9B%91%E5%90%AC%E5%99%A8%E9%85%8D%E7%BD%AE">事件及监听器配置</a>
<ul>
<li><a href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-2">源码分析</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
        <script>
            function locateCatelogList() {
                /*获取文章目录集合,可通过:header过滤器*/
                var alis = $('.post-content :header');
                /*获取侧边栏目录列表集合**/
                var sidebar_alis = $('.markdownIt-TOC a');
                /*获取滚动条到顶部的距离*/
                var scroll_height = $(window).scrollTop();
                for (var i = 0; i < alis.length; i++) {
                    /*获取锚点集合中的元素分别到顶点的距离*/
                    var a_height = $(alis[i]).offset().top;
                    if (a_height < scroll_height) {
                        /*高亮显示*/
                        sidebar_alis.removeClass('on');
                        $(sidebar_alis[i]).addClass('on');
                    }
                }
            }
            $(function() {
                /*绑定滚动事件 */
                $(window).bind('scroll', locateCatelogList);
            });
        </script>
    </div>
    
                            

                </div>




            </div>


            <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | <a href="https://blog.fjy8018.top/" target="_blank">F嘉阳 博客</a> | 
  <a class="rss" href="https://fjiayang.github.io//atom.xml" target="_blank">RSS</a>
</div>

<script>
  hljs.initHighlightingOnLoad()
</script>


    </div>
    <script>
        $('#sidebar').stickySidebar({
            topSpacing: 80,
            // bottomSpacing: 60
        });
    </script>
    
</body>

</html>