<html>

<head>
    <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>
    F嘉阳
</title>
<link rel="shortcut icon" href="https://fjiayang.github.io//favicon.ico?v=1579680039929">
<!-- <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous"> -->
<link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://fjiayang.github.io//styles/main.css">
<!-- js -->
<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
<script src="https://fjiayang.github.io//media/js/jquery.sticky-sidebar.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/moment.js/2.23.0/moment.min.js"></script>


</head>

<body>
    <div class="main">
        <div class="header">
    <div class="nav">
        <div class="logo">
            <a href="https://fjiayang.github.io/">
                <img class="avatar" src="https://fjiayang.github.io//images/avatar.png?v=1579680039929" alt="">
            </a>
            <div class="site-title">
                <h1>
                    F嘉阳
                </h1>
            </div>
        </div>
        <span class="menu-btn fa fa-align-justify"></span>
        <div class="menu-container">
            <ul>
                
                    
                            <li>
                                <a href="/" class="menu">
                                    首页
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/archives" class="menu">
                                    归档
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/tags" class="menu">
                                    标签
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/post/about" class="menu">
                                    关于
                                </a>
                            </li>
                            
                                
            </ul>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        $(".menu-btn").click(function() {
            $(".menu-container").slideToggle();
        });
        $(window).resize(function() {

            if (window.matchMedia('(min-width: 960px)').matches) {
                $(".menu-container").css('display', 'block')
            } else {
                $(".menu-container").css('display', 'none')
            }

        });
    });
</script>

            <div id="main-content" class="post-container main-container">
                <div id="content" class="main-container-left">
                    
        
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://fjiayang.github.io//post/redis-duo-chong-qi-dong-pei-zhi-fang-shi">
                        redis多种启动配置方式
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2018-12-09</time>
                    
                        <a href="https://fjiayang.github.io//tag/4QCDLcnCA" class="post-tag i-tag
                            i-tag-info">
            #Redis
        </a>
                        
                </div>
                <div class="post-article">
                    
                            <div class="post-content">
                                
                                        <div class="post-content-content">
                                            总览
三种启动方式：

动态参数启动（指定端口号）
配置文件启动（生产环境推荐）
最简单启动

官方安装指南
安装前置环境gcc-c++
$ yum install -y gcc-c++

官方下载安装文档
$ wget http://download.redis.io/releases/redis-5.0.0.tar.gz
$ tar xzf redis-5.0.0.tar.gz
$ cd redis-5.0.0
$ make MALLOC=libc
$ make install

编译后在src目录下生成可执行文件
$ ls | grep redis-

redis-benchmark ——性能测试
redis-benchmark.c
redis-benchmark.o
redis-check-aof ——aof修复
redis-check-aof.c
redis-check-aof.o
redis-check-rdb ——rdb修复
redis-check-rdb.c
redis-check-rdb.o
redis-cli ——客户端
redis-cli.c
redis-cli.o
redis-sentinel ——集群
redis-server ——服务器
redis-trib.rb

启动
简单启动
$ redis-server 
2660:C 21 Nov 2018 20:01:10.958 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo
2660:C 21 Nov 2018 20:01:10.958 # Redis version=5.0.0, bits=64, commit=00000000, modified=0, pid=2660, just started
2660:C 21 Nov 2018 20:01:10.958 # Warning: no config file specified, using the default config. In order to specify a config file use redis-server /path/to/redis.conf
2660:M 21 Nov 2018 20:01:10.959 * Increased maximum number of open files to 10032 (it was originally set to 1024).
                _._                                                  
           _.-``__ &#39;&#39;-._                                             
      _.-``    `.  `_.  &#39;&#39;-._           Redis 5.0.0 (00000000/0) 64 bit
  .-`` .-```.  ```\/    _.,_ &#39;&#39;-._                                   
 (    &#39;      ,       .-`  | `,    )     Running in standalone mode
 |`-._`-...-` __...-.``-._|&#39;` _.-&#39;|     Port: 6379
 |    `-._   `._    /     _.-&#39;    |     PID: 2660
  `-._    `-._  `-./  _.-&#39;    _.-&#39;                                   
 |`-._`-._    `-.__.-&#39;    _.-&#39;_.-&#39;|                                  
 |    `-._`-._        _.-&#39;_.-&#39;    |           http://redis.io        
  `-._    `-._`-.__.-&#39;_.-&#39;    _.-&#39;                                   
 |`-._`-._    `-.__.-&#39;    _.-&#39;_.-&#39;|                                  
 |    `-._`-._        _.-&#39;_.-&#39;    |                                  
  `-._    `-._`-.__.-&#39;_.-&#39;    _.-&#39;                                   
      `-._    `-.__.-&#39;    _.-&#39;                                       
          `-._        _.-&#39;                                           
              `-.__.-&#39;                                               

2660:M 21 Nov 2018 20:01:10.961 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.
2660:M 21 Nov 2018 20:01:10.961 # Server initialized
2660:M 21 Nov 2018 20:01:10.961 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add &#39;vm.overcommit_memory = 1&#39; to /etc/sysctl.conf and then reboot or run the command &#39;sysctl vm.overcommit_memory=1&#39; for this to take effect.
2660:M 21 Nov 2018 20:01:10.961 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command &#39;echo never &amp;gt; /sys/kernel/mm/transparent_hugepage/enabled&#39; as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.
2660:M 21 Nov 2018 20:01:10.961 * Ready to accept connections

客户端连接测试
$ redis-cli -h 127.0.0.1 -p 6379
127.0.0.1:6379&amp;gt; ping
PONG
127.0.0.1:6379&amp;gt; set hello world
OK
127.0.0.1:6379&amp;gt; get hello
&amp;quot;world&amp;quot;

动态参数启动
$ redis-server --port 6380

连接默认端口测试
$ redis-cli -h 127.0.0.1 -p 6379
Could not connect to Redis at 127.0.0.1:6379: Connection refused
not connected&amp;gt; exit

连接新端口测试
$ redis-cli -h 127.0.0.1 -p 6380
127.0.0.1:6380&amp;gt; ping
PONG
127.0.0.1:6380&amp;gt; exit

通过进程查看
$ ps -ef | grep redis-server |grep -v grep
root       2666   1469  0 20:04 pts/0    00:00:00 redis-server *:6380

配置文件启动
拷贝默认配置
$ pwd
/root/redis-5.0.0
$ mkdir config
$ cp redis.conf config/
$ cd config/
$ ls
redis.conf

查看默认配置，以下命令用于去除注释和空格
$ cat redis.conf | grep -v &amp;quot;#&amp;quot; | grep -v &amp;quot;^$&amp;quot; &amp;gt; redis-default.conf
$ cat redis-default.conf 
bind 127.0.0.1
protected-mode yes
port 6379 #端口号
tcp-backlog 511
timeout 0
tcp-keepalive 300
daemonize no #默认非守护进程启动
supervised no
pidfile /var/run/redis_6379.pid
loglevel notice
logfile &amp;quot;&amp;quot; #日志文件名称
databases 16
always-show-logo yes
save 900 1
save 300 10
save 60 10000
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir ./ #工作目录
replica-serve-stale-data yes
replica-read-only yes
repl-diskless-sync no
repl-diskless-sync-delay 5
repl-disable-tcp-nodelay no
replica-priority 100
lazyfree-lazy-eviction no
lazyfree-lazy-expire no
lazyfree-lazy-server-del no
replica-lazy-flush no
appendonly no
appendfilename &amp;quot;appendonly.aof&amp;quot;
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes
aof-use-rdb-preamble yes
lua-time-limit 5000
slowlog-log-slower-than 10000
slowlog-max-len 128
latency-monitor-threshold 0
notify-keyspace-events &amp;quot;&amp;quot;
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
hll-sparse-max-bytes 3000
stream-node-max-bytes 4096
stream-node-max-entries 100
activerehashing yes
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60
hz 10
dynamic-hz yes
aof-rewrite-incremental-fsync yes
rdb-save-incremental-fsync yes

由于默认配置redis为单线程，故一台服务器一般起多个redis实例，配置文件以端口号区分
$ cp redis-default.conf redis-6379.conf
$ ll
总用量 72
-rw-r--r--. 1 root root    65 11月 21 20:46 redis-6379.conf
-rw-r--r--. 1 root root 62155 11月 21 20:36 redis.conf
-rw-r--r--. 1 root root  1425 11月 21 20:41 redis-default.conf

简化配置如下：
port 6380
daemonize yes
logfile &amp;quot;6380.log&amp;quot;
dir &amp;quot;/root/tmp/redis&amp;quot;

配置文件启动
 $ redis-server config/redis-6380.conf


                                        </div>
                                        
                                            <a class="btn btn-text" href="https://fjiayang.github.io//post/redis-duo-chong-qi-dong-pei-zhi-fang-shi">Read More ~</a>
                            </div>
                </div>
            </article>
            
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://fjiayang.github.io//post/ji-li-tui-jian-de-wang-luo-jia-su-ti-zi-fu-wu">
                        极力推荐的网络加速（梯子）服务
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2018-12-09</time>
                    
                        <a href="https://fjiayang.github.io//tag/d2Pd4JZcy" class="post-tag i-tag
                            i-tag-other_2">
            #评测
        </a>
                        
                </div>
                <div class="post-article">
                    
                            <div class="post-content">
                                
                                        <div class="post-content-content">
                                            地址
5折圣诞优惠码：CHRISTMASANDNEWYEAR ，账户内现有产品可使用优惠码 RENEW2019 获得 35% off 续约折扣
AAEX
原因
从最开始使用免费账号到坚持自建服务器搭建专线梯子，一直认为专线梯子才是王道，何必花钱购买别人的昂贵加速服务，然而。。直到发现AAEX。。其与自建服务器区别如下
默认套餐
默认套餐对自建服务器的吸引不大而且和其他服务提供商产品类型差不多，适用于视频搬运。另外，因为自建服务器成本和套餐差距不大，除了需要自己维护之外没太大区别，而且自建服务器还有台服务器可以折腾

对于本人来说一般就偶尔看个视频，自建服务器一个月才3-5刀，还不限流量，但缺点也是节点有限，而且带宽流量极大浪费，然后发现了另一个隐藏套餐
固定流量包
这个就比较有意思了，按量付费，和买运营商流量包一样，按需购买，还不清零，永久有效，对于查阅资料，游戏玩家来说还是非常友好的，而且所有节点均可用


本人试了下买了200多G的流量套餐100块，38个节点随便用，全平台支持（好评，特别是苹果用户，下载客户端非常麻烦，而且一般还要付费），AAEX官方提供appleID下载梯子app（满分）

效果
常见的控制台，多个香港节点，延迟低带宽大

使用RSS订阅客户端自动更新节点，同时带有流量统计，比原生的SSR体验好了不少

全节点均可用

通过在线视频和网页测试基本秒开，在线4K无压力，带宽也能跑满本地带宽（20M）
总结
一趟测试下来，优点如下

无需自己购买和搭建服务器
无需担心IP被墙
多节点选择，延迟低（自建服务器香港、日本机房贼贵）
固定流量包，不清零
全平台支持

用了这个之后基本就告别自建服务器的梯子了。。

                                        </div>
                                        
                                            <a class="btn btn-text" href="https://fjiayang.github.io//post/ji-li-tui-jian-de-wang-luo-jia-su-ti-zi-fu-wu">Read More ~</a>
                            </div>
                </div>
            </article>
            
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://fjiayang.github.io//post/mesos-ji-qun-an-zhuang">
                        Mesos集群安装
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2018-10-03</time>
                    
                        <a href="https://fjiayang.github.io//tag/xTpEEjjmQ" class="post-tag i-tag
                            i-tag-">
            #mesos
        </a>
                        
                        <a href="https://fjiayang.github.io//tag/kTPZcu1_NZ" class="post-tag i-tag
                            i-tag-warning">
            #Docker
        </a>
                        
                        <a href="https://fjiayang.github.io//tag/rjmWDGdyvm" class="post-tag i-tag
                            i-tag-other_3">
            #集群
        </a>
                        
                </div>
                <div class="post-article">
                    
                            <div class="post-content">
                                
                                        <div class="post-content-content">
                                            基础环境
4台服务器，一台外部客户机

安装指南
官方支持C++源码编译安装和Docker安装
C++源码编译安装地址
Docker镜像仓库
停止所有容器命令
docker stop $(docker ps -a -q)
docker rm $(docker ps -a -q)

安装
mesos主节点


node1
docker pull mesosphere/mesos-master:1.7.0



node2(host)
docker run --name mesos-zookeeper -p 2181:2181 --restart always -d zookeeper:3.5



node1执行脚本(需替换zk IP地址)
MESOS_QUORUM=1即1为单机运行，3个节点为2，计算方式为 n÷2+1 \
若不手动指定hostname映射的IP，则所有节点默认通过主机名进行通信


使用host通信脚本
docker run -d --net=host \
  -e MESOS_PORT=5050 \
  -e MESOS_ZK=zk://192.168.0.32:2181/mesos \
  -e MESOS_QUORUM=1 \
  -e MESOS_REGISTRY=in_memory \
  -e MESOS_LOG_DIR=/var/log/mesos \
  -e MESOS_WORK_DIR=/var/tmp/mesos \
  -v &amp;quot;$(pwd)/log/mesos:/var/log/mesos&amp;quot; \
  -v &amp;quot;$(pwd)/work/mesos:/var/tmp/mesos&amp;quot; \
  -p 5050:5050 \
  --name=mesos-master \
  mesosphere/mesos-master:1.7.0 \



使用IP通信脚本
docker run -d --net=host \
  --hostname=192.168.0.32 \
  -e MESOS_PORT=5050 \
  -e MESOS_ZK=zk://192.168.0.32:2181/mesos \
  -e MESOS_QUORUM=1 \
  -e MESOS_REGISTRY=in_memory \
  -e MESOS_LOG_DIR=/var/log/mesos \
  -e MESOS_WORK_DIR=/var/tmp/mesos \
  -v &amp;quot;$(pwd)/log/mesos:/var/log/mesos&amp;quot; \
  -v &amp;quot;$(pwd)/work/mesos:/var/tmp/mesos&amp;quot; \
  -p 5050:5050 \
  --name=mesos-master \
  mesosphere/mesos-master:1.7.0 \
  --no-hostname_lookup \
  --ip=192.168.0.33



查看日志
docker logs mesos-master

成功输出日志
I1003 08:41:29.868827    14 group.cpp:341] Group process (zookeeper-group(2)@192.168.0.33:5050) connected to ZooKeeper
I1003 08:41:29.868902    14 group.cpp:831] Syncing group operations: queue size (joins, cancels, datas) = (0, 0, 0)
I1003 08:41:29.868921    14 group.cpp:419] Trying to create path &#39;/mesos&#39; in ZooKeeper
I1003 08:41:29.902194    14 contender.cpp:268] New candidate (id=&#39;1&#39;) has entered the contest for leadership
I1003 08:41:29.904409     8 detector.cpp:152] Detected a new leader: (id=&#39;1&#39;)
I1003 08:41:29.904513     8 group.cpp:700] Trying to get &#39;/mesos/json.info_0000000001&#39; in ZooKeeper
I1003 08:41:29.912968     8 zookeeper.cpp:262] A new leading master (UPID=master@192.168.0.33:5050) is detected
I1003 08:41:29.913091     8 master.cpp:2113] Elected as the leading master!
I1003 08:41:29.913115     8 master.cpp:1668] Recovering from registrar
I1003 08:41:29.916913    11 registrar.cpp:383] Successfully fetched the registry (0B) in 3.734016ms
I1003 08:41:29.917054    11 registrar.cpp:487] Applied 1 operations in 26us; attempting to update the registry
I1003 08:41:29.918582    11 registrar.cpp:544] Successfully updated the registry in 1.449984ms
I1003 08:41:29.918630    11 registrar.cpp:416] Successfully recovered registrar
I1003 08:41:29.918772     8 master.cpp:1782] Recovered 0 agents from the registry (121B); allowing 10mins for agents to reregister

访问IP:5050，对于PWD，可以访问http://SSHIP-5050.direct.labs.play-with-docker.com/#/，将SSH ip替换成实际提供的IP即可

mesos从节点


node3 (slave-1)、node4(slave-2)
启动脚本


使用host通信脚本
mkdir /cgroup
docker run -d --net=host --privileged \
  -e MESOS_PORT=5051 \
  -e MESOS_MASTER=zk://192.168.0.32:2181/mesos \
  -e MESOS_SWITCH_USER=0 \
  -e MESOS_CONTAINERIZERS=docker,mesos \
  -e MESOS_LOG_DIR=/var/log/mesos \
  -e MESOS_WORK_DIR=/var/tmp/mesos \
  -v &amp;quot;$(pwd)/log/mesos:/var/log/mesos&amp;quot; \
  -v &amp;quot;$(pwd)/tmp/mesos:/var/tmp/mesos&amp;quot; \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v /cgroup:/cgroup \
  -v /sys:/sys \
  -v &amp;quot;$(which docker):/usr/local/bin/docker&amp;quot; \
  --name=mesos-slave \
  -p 5051:5051 \
  mesosphere/mesos-slave:1.7.0 \
  --no-systemd_enable_support



使用IP通信脚本，--ip需要改成实际IP
mkdir /cgroup
docker run -d --net=host --privileged \
  -e MESOS_PORT=5051 \
  -e MESOS_MASTER=zk://192.168.0.32:2181/mesos \
  -e MESOS_SWITCH_USER=0 \
  -e MESOS_CONTAINERIZERS=docker,mesos \
  -e MESOS_LOG_DIR=/var/log/mesos \
  -e MESOS_WORK_DIR=/var/tmp/mesos \
  -v &amp;quot;$(pwd)/log/mesos:/var/log/mesos&amp;quot; \
  -v &amp;quot;$(pwd)/tmp/mesos:/var/tmp/mesos&amp;quot; \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v /cgroup:/cgroup \
  -v /sys:/sys \
  -v &amp;quot;$(which docker):/usr/local/bin/docker&amp;quot; \
  --name=mesos-slave \
  -p 5051:5051 \
  mesosphere/mesos-slave:1.7.0 \
  --no-systemd_enable_support \
  --no-hostname_lookup \
  --ip=192.168.0.31



查看日志
docker logs mesos-slave

启动成功日志
I1003 09:05:08.615039    12 group.cpp:341] Group process (zookeeper-group(1)@192.168.0.31:5051) connected to ZooKeeper
I1003 09:05:08.615104    12 group.cpp:831] Syncing group operations: queue size (joins, cancels, datas) = (0, 0, 0)
I1003 09:05:08.615121    12 group.cpp:419] Trying to create path &#39;/mesos&#39; in ZooKeeper
I1003 09:05:08.618291    13 state.cpp:66] Recovering state from &#39;/var/tmp/mesos/meta&#39;
I1003 09:05:08.618405    15 slave.cpp:6930] Finished recovering checkpointed state from &#39;/var/tmp/mesos/meta&#39;, beginning agent recovery
I1003 09:05:08.618475     8 task_status_update_manager.cpp:207] Recovering task status update manager
I1003 09:05:08.618628     8 docker.cpp:908] Recovering Docker containers
I1003 09:05:08.626359    13 detector.cpp:152] Detected a new leader: (id=&#39;3&#39;)
I1003 09:05:08.626487    15 group.cpp:700] Trying to get &#39;/mesos/json.info_0000000003&#39; in ZooKeeper
I1003 09:05:08.628664    15 zookeeper.cpp:262] A new leading master (UPID=master@192.168.0.33:5050) is detected
I1003 09:05:08.997036    15 docker.cpp:921] Got the list of Docker containers
I1003 09:05:08.997324    15 docker.cpp:1157] Finished processing orphaned Docker containers
I1003 09:05:08.997436     8 slave.cpp:7159] Recovering executors
I1003 09:05:08.997553     8 slave.cpp:7312] Finished recovery
I1003 09:05:08.998044    11 task_status_update_manager.cpp:181] Pausing sending task status updates
I1003 09:05:08.998045     8 slave.cpp:1275] New master detected at master@192.168.0.33:5050
I1003 09:05:08.998159     8 slave.cpp:1329] No credentials provided. Attempting to register without authentication
I1003 09:05:08.998181     8 slave.cpp:1340] Detecting new master
I1003 09:05:09.446756    11 slave.cpp:1500] Registered with master master@192.168.0.33:5050; given agent ID b597695d-6e37-418a-9879-4ffe46117e17-S0
I1003 09:05:09.449091    10 task_status_update_manager.cpp:188] Resuming sending task status updates

访问主节点web界面可看见资源邀约有效



节点情况

marathon安装

node5

启动脚本
docker run -d --net=host \
  -p 8080:8080 \
  mesosphere/marathon:latest \
  --master zk://192.168.0.32:2181/mesos \
  --zk zk://192.168.0.32:2181/marathon

通过IP:8080查看运行结果

marathon-lb安装


node6
启动脚本
docker run -d -e PORTS=9090 --net=host \
  -p 9090:9090 \
  mesosphere/marathon-lb sse \
  --group external \
  --marathon http://192.168.0.29:8080

访问IP:9090/haproxy?stats可查看启动状态




                                        </div>
                                        
                                            <a class="btn btn-text" href="https://fjiayang.github.io//post/mesos-ji-qun-an-zhuang">Read More ~</a>
                            </div>
                </div>
            </article>
            
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://fjiayang.github.io//post/vps-xing-neng-ce-shi">
                        VPS性能测试
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2018-09-13</time>
                    
                        <a href="https://fjiayang.github.io//tag/d2Pd4JZcy" class="post-tag i-tag
                            i-tag-error">
            #评测
        </a>
                        
                </div>
                <div class="post-article">
                    
                            <div class="post-content">
                                
                                        <div class="post-content-content">
                                            测试命令
采用superbench
wget -qO- --no-check-certificate https://raw.githubusercontent.com/oooldking/script/master/superbench.sh | bash

OpenVZ
以手上的HiFormance VPS为例，superbench自动识别虚拟化平台和硬件信息，并对国内不同地点、不同运营商的上行、下行速度测试和延迟测试
HiFormance 亚洲优化线路，由于HiFormance 亚洲优化线路虚拟化平台是OpenVZ+lxc，故无法安装BBR加速

HiFormance 普通线路，启用了BBR加速

KVM
以搬瓦工VPS为例，平台识别正常
搬瓦工VPS，亚洲优化，启用BBR

阿里云ECS 1Mbps带宽，识别正常

物理机
识别平台为独立主机


                                        </div>
                                        
                                            <a class="btn btn-text" href="https://fjiayang.github.io//post/vps-xing-neng-ce-shi">Read More ~</a>
                            </div>
                </div>
            </article>
            
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://fjiayang.github.io//post/jenkinsgitlabansible-shi-xian-jing-tai-wang-zhan-zi-dong-bu-shu">
                        Jenkins+GitLab+Ansible实现静态网站自动部署
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2018-09-01</time>
                    
                        <a href="https://fjiayang.github.io//tag/dgP0uMsX9" class="post-tag i-tag
                            i-tag-banana">
            #Ansible
        </a>
                        
                        <a href="https://fjiayang.github.io//tag/55CGdWlsfz" class="post-tag i-tag
                            i-tag-banana">
            #Jenkins
        </a>
                        
                        <a href="https://fjiayang.github.io//tag/3x3ut1pT9" class="post-tag i-tag
                            i-tag-banana">
            #GitLab
        </a>
                        
                </div>
                <div class="post-article">
                    
                            <div class="post-content">
                                
                                        <div class="post-content-content">
                                            环境准备
参考前几篇文章配置后实现以下环境

部署好Jenkins服务器一台(192.168.163.133),并在Jenkins服务器上部署ansible，且与目标主机(192.168.163.132)做了免密登录
可以访问的GitLab服务器一台，并注册了Jenkins相关账号且在Jenkins系统设置中配置完毕
一台工作环境主机，用于代码编写，该主机可以通过域名访问目标主机(192.168.163.132)

编写ansible playbook
搭建基础工程目录结构
从仓库下载之前编写的ansible工程目录结构

若没有也可自行创建，最终文件目录结构如下
└─ansible-playbook-repo
    │  deploy.yml
    │
    ├─inventory
    │      dev
    │      prod
    │
    └─roles
        └─nginx
            ├─files
            │  │  health_check.sh
            │  │  index.html
            │  │
            │  └─website
            │
            ├─tasks
            │      main.yml
            │
            └─templates
                    nginx.conf.j2


文件编写
工程入口deploy.yml编写
- hosts: &amp;quot;nginx&amp;quot;
  gather_facts: true
  remote_user: root
  roles:
    - nginx

编写开发环境配置文件inventory/dev，此处dev与prod配置一致，若实际需求可自行修改，用于最后jenkins参数化构建的选项
inventory/dev文件内容
[nginx]
test.fjy8018.top

[nginx:vars]
server_name=test.fjy8018.top
port=80
user=ansible
worker_processes=4
max_open_file=65505
root=/www

inventory/prod文件内容
[nginx]
test.fjy8018.top

[nginx:vars]
server_name=test.fjy8018.top
port=80
user=ansible
worker_processes=4
max_open_file=65505
root=/www

编写健康检查shell脚本health_check.sh
roles/nginx/files/health_check.sh文件内容
#!/bin/bash

# 接受命令行参数
URL=$1

# 访问目标地址，判断是否能正常访问并输出
curl -Is http://$URL &amp;gt; /dev/null &amp;amp;&amp;amp; echo &amp;quot;远程主机状态正常&amp;quot; || echo &amp;quot;远程主机已停止&amp;quot;

添加静态网站文件
/roles/nginx/files/website为静态网页模板目录，里面存放从网上下载的静态网站模板
配置nginx指向该资源
/roles/nginx/templates/nginx.conf.j2文件内容
# For more information on configuration, see: 
user              {{ user }};  
worker_processes  {{ worker_processes }};  
  
error_log  /var/log/nginx/error.log;  
  
pid        /var/run/nginx.pid;  
  
events {  
    worker_connections  {{ max_open_file }};  
}  
  
  
http {  
    include       /etc/nginx/mime.types;  
    default_type  application/octet-stream;  
  
    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &amp;quot;$request&amp;quot; &#39;  
                      &#39;$status $body_bytes_sent &amp;quot;$http_referer&amp;quot; &#39;  
                      &#39;&amp;quot;$http_user_agent&amp;quot; &amp;quot;$http_x_forwarded_for&amp;quot;&#39;;  
  
    access_log  /var/log/nginx/access.log  main;  
  
    sendfile        on;  
    #tcp_nopush     on;  
  
    #keepalive_timeout  0;  
    keepalive_timeout  65;  
  
    #gzip  on;  
      
    # Load config files from the /etc/nginx/conf.d directory  
    # The default server is in conf.d/default.conf  
    #include /etc/nginx/conf.d/*.conf;  
    server {  
        listen       {{ port }} default_server;  
        server_name  {{ server_name }};  
  
        #charset koi8-r;  
  
        #access_log  logs/host.access.log  main;  
  
        location / {  
            root   {{ root }}/website;  
            index  index.html index.htm;  
        }  
  
        error_page  404              /404.html;  
        location = /404.html {  
            root   /usr/share/nginx/html;  
        }  
  
        # redirect server error pages to the static page /50x.html  
        #  
        error_page   500 502 503 504  /50x.html;  
        location = /50x.html {  
            root   /usr/share/nginx/html;  
        }  
  
    }  
  
}

编写主任务文件
主任务文件main.yml内容如下
- name: 关闭系统防火墙
  service: name=firewalld state=stopped

- name: 关闭强制访问控制策略
  selinux: state=disabled

- name: 设置yum源
  yum: pkg=epel-release state=latest

- name: 写入nginx配置文件
  template: src=roles/nginx/templates/nginx.conf.j2 dest=/etc/nginx/nginx.conf

- name: 创建nginx根目录文件夹
  file: &#39;path={{ root }} state=directory owner={{ user }} group={{ user }} mode=0755&#39;

- name: 文件拷贝
  copy: &#39;remote_src=no src=roles/nginx/files/website dest=/www/website owner={{ user }} mode=0755&#39;

- name: 启动nginx
  service: name=nginx state=restarted

- name: 运行健康检查
  shell: &amp;quot;sh roles/nginx/files/health_check.sh {{ server_name }}&amp;quot;
  # 本地执行
  delegate_to: localhost
  # 参数传递
  register: health_status

- debug: msg=&amp;quot;{{ health_status.stdout }}&amp;quot;

Git提交
提交变更到版本仓库GitLab
git add .
git commit -m &amp;quot;添加模板文件&amp;quot;
git push origin master

Jenkins创建并执行
创建自由风格构建任务，添加参数化构建、添加选项参数和文本参数

添加Git仓库地址和账号

添加Shell构建，Shell内容为
#!/bin/bash
# 关闭命令行扩展环境，避免环境参数日志干扰
set +x
# 加载虚拟环境
source /home/deploy/.py3-a2.5-env/bin/activate
# 加载ansible到当前用户目录
source /home/deploy/.py3-a2.5-env/ansible/hacking/env-setup -q

cd $WORKSPACE
ls -a
# 查看版本
ansible --version
ansible-playbook --version

# 引入资源清单，测试远程命令
ansible-playbook -i inventory/$deploy_env ./deploy.yml -e project=nginx -e branch=$branch -e env=$deploy_env


保存并构建
结果
构建成功

访问测试
在工作主机上访问目标地址+资源路径即可，访问通过

后续构建
后期只要在工作主机变更代码推送到git仓库，再到Jenkins的web界面点击参数化构建即可让Jenkins自动拉取最新分支并执行Ansible脚本

                                        </div>
                                        
                                            <a class="btn btn-text" href="https://fjiayang.github.io//post/jenkinsgitlabansible-shi-xian-jing-tai-wang-zhan-zi-dong-bu-shu">Read More ~</a>
                            </div>
                </div>
            </article>
            
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://fjiayang.github.io//post/jenkins-yu-maven-ji-cheng">
                        Jenkins 与Maven集成
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2018-08-26</time>
                    
                        <a href="https://fjiayang.github.io//tag/mBLSimdZa" class="post-tag i-tag
                            i-tag-success">
            #Maven
        </a>
                        
                        <a href="https://fjiayang.github.io//tag/55CGdWlsfz" class="post-tag i-tag
                            i-tag-banana">
            #Jenkins
        </a>
                        
                </div>
                <div class="post-article">
                    
                            <div class="post-content">
                                
                                        <div class="post-content-content">
                                            环境准备
安装jdk
yum -y install java-devel java

检测安装结果
[root@localhost maven-freestyle-job]# javac -version
javac 1.8.0_181
[root@localhost maven-freestyle-job]# java -version
openjdk version &amp;quot;1.8.0_181&amp;quot;
OpenJDK Runtime Environment (build 1.8.0_181-b13)
OpenJDK 64-Bit Server VM (build 25.181-b13, mixed mode)

安装maven环境
wget http://apache.osuosl.org/maven/maven-3/3.5.4/binaries/apache-maven-3.5.4-bin.tar.gz

解压，并指定解压路径
tar -zxvf apache-maven-3.5.4-bin.tar.gz -C /opt

查看安装结果
[root@localhost ~]# cd /opt/
[root@localhost opt]# cd apache-maven-3.5.4/
[root@localhost apache-maven-3.5.4]# cd bin/
[root@localhost bin]# ./mvn -v
Apache Maven 3.5.4 (1edded0938998edf8bf061f1ceb3cfdeccf443fe; 2018-06-18T02:33:14+08:00)
Maven home: /opt/apache-maven-3.5.4
Java version: 1.8.0_181, vendor: Oracle Corporation, runtime: /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.181-3.b13.el7_5.x86_64/jre
Default locale: zh_CN, platform encoding: UTF-8
OS name: &amp;quot;linux&amp;quot;, version: &amp;quot;3.10.0-862.el7.x86_64&amp;quot;, arch: &amp;quot;amd64&amp;quot;, family: &amp;quot;unix&amp;quot;
[root@localhost bin]# pwd
/opt/apache-maven-3.5.4/bin


配置环境
进入Jenkins系统管理中的全局工具配置，配置本地的maven地址

此处的jdk报错正常，若不配置则会自动调用系统环境里的jdk

指定maven名称和路径

准备maven工程
提前在gitlab中装备一个简单的Springboot web工程，通过springboot脚手架快速生成，pom文件如下

新建构建
新建构建并填写目标仓库地址

添加构建设置为maven构建

添加构建参数，即在命令行mvn之后的参数

选择maven版本

构建
构建成功


                                        </div>
                                        
                                            <a class="btn btn-text" href="https://fjiayang.github.io//post/jenkins-yu-maven-ji-cheng">Read More ~</a>
                            </div>
                </div>
            </article>
            
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://fjiayang.github.io//post/jenkins-job-bian-xie-ce-shi">
                        Jenkins job编写测试
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2018-08-26</time>
                    
                        <a href="https://fjiayang.github.io//tag/55CGdWlsfz" class="post-tag i-tag
                            i-tag-other_2">
            #Jenkins
        </a>
                        
                </div>
                <div class="post-article">
                    
                            <div class="post-content">
                                
                                        <div class="post-content-content">
                                            系统预配置
关闭防止跨站请求伪造
测试期间系统设置中临时关闭防止跨站请求伪造，否则容易出现登录超时无法新建任务


添加远程仓库配置
GitLab的用户邮箱、用户名、密码，用于拉取远程仓库代码

凭据
添加凭据，凭据为用户的标识

选择全局凭据

添加凭据

添加为Git用户

Jenkins job
freestyle Job
freestyle Job简介

需要在页面添加模块配置项与参数完成配置
每个Job仅能实现一个开发功能
无法将配置代码化，不利于Job配置迁移与版本控制
没有版本日志记录
逻辑简单

新建freestyle Job
新建任务

添加选项参数

添加文本参数

指定远程仓库地址

添加Shell脚本


保存后选择通过参数构建

构建报错

检查后发现Shell脚本开头的#!/bin/bash写成了#! /bin/bash，中间包含空格后系统无法识别
修正错误后重新构建

报语法错误，12行缺少空格

检查发现if [ -s test.properties ]写成了if [ -s test.properties]，修正错误后再次构建
修正后的Shell脚本为
#!/bin/bash
# export PATH=&amp;quot;/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin&amp;quot;

# 打印环境变量
echo &amp;quot;[INFO] 打印环境变量&amp;quot;
echo &amp;quot;[INFO] 当前发布环境为 $deploy_env&amp;quot; &amp;gt;&amp;gt; test.properties
echo &amp;quot;[INFO] 构建版本为 $version &amp;quot; &amp;gt;&amp;gt; test.properties
echo &amp;quot;[INFO] 打印环境变量完成...&amp;quot;

# 检查test.properties
echo &amp;quot;[INFO] 检查test.properties&amp;quot;
if [ -s test.properties ]
then
  cat test.properties
  echo &amp;quot;[INFO] 检查完成...&amp;quot;
else
  echo &amp;quot;[WARN] test.properties为空&amp;quot;
fi

echo &amp;quot;[INFO] 构建完成...&amp;quot;

构建成功，输出正常

查看构建历史


同时显示构建稳定性

pipeline job
pipeline job简介

所有代码包裹在pipeline{}内
stages{}用来包含pipeline所有子层
stage(管道名称){}每个子层可以执行一个任务，并不互相影响
steps{}用来添加具体需要调用的模块语句

新建pipeline任务

编写pipeline 脚本
#!groovy

pipeline {
    // agent 定义pipeline在何处运行，使用any、none或者Jenkins node主机名
	agent {node {label &#39;master&#39;}}
	// 声明环境变量，environment 定义系统环境变量，可以应用于所有stages
	// 定义局部环境变量则于steps平级即可
	environment {
		PATH=&amp;quot;/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin&amp;quot;
	}

	parameters {
		// 声明可选参数
		choice(
				// 可选参数为两个，以空行分隔
				choices: &#39;dev\nprod&#39;,
				// 设置参数描述
				description: &#39;选择发布环境&#39;,
				// 声明参数变量名
				name: &#39;deploy_env&#39;
			)
		// 声明文本参数，和默认值
		string (name: &#39;version&#39;, defaultValue: &#39;0.0.1&#39;,description: &#39;构建版本号&#39;)
	}

	stages {
		// 执行一个任务
		stage(&amp;quot;切换到测试版本仓库&amp;quot;) {
			// 添加具体需要调用的模块语句
			steps {
				// 关闭Git ssl安全认证
				sh &#39;git config --system http.sslVerify false&#39;
				// 指定工作空间
				dir (&amp;quot;${env.WORKSPACE}&amp;quot;) {
					// 指定分支和Jenkins凭据ID
					git branch: &#39;master&#39;,
						credentialsId: &#39;52f4c34f-544c-4830-828d-6691d603b8e4&#39;,
						url: &#39;http://home.fjy8018.top:8099/jenkins/test-repo.git&#39;
				}
			}
		}
		stage(&amp;quot;打印环境变量&amp;quot;) {
			steps {
				dir (&amp;quot;${env.WORKSPACE}&amp;quot;) {
					sh &amp;quot;&amp;quot;&amp;quot;
						echo &amp;quot;[INFO] 打印环境变量&amp;quot;
						echo &amp;quot;[INFO] 当前发布环境为 $deploy_env&amp;quot; &amp;gt;&amp;gt; test.properties
						echo &amp;quot;[INFO] 构建版本为 $version &amp;quot; &amp;gt;&amp;gt; test.properties
						echo &amp;quot;[INFO] 打印环境变量完成...&amp;quot;
					&amp;quot;&amp;quot;&amp;quot;
				}
			}
		}
		stage(&amp;quot;检查test.properties&amp;quot;) {
			steps {
				dir (&amp;quot;${env.WORKSPACE}&amp;quot;) {
					sh &amp;quot;&amp;quot;&amp;quot;
						echo &amp;quot;[INFO] 检查test.properties&amp;quot;
						if [ -s test.properties ]
						then
						  cat test.properties
						  echo &amp;quot;[INFO] 检查完成...&amp;quot;
						else
						  echo &amp;quot;[WARN] test.properties为空&amp;quot;
						fi
					&amp;quot;&amp;quot;&amp;quot;
					echo &amp;quot;[INFO] 构建完成...&amp;quot;
				}
			}
		}
	}
}

其中credentialsId来自用户的凭据唯一标识，可在凭据页面查看

写入Shell脚本

执行报错，error: could not lock config file /etc/gitconfig: ????

由于使用root用户执行同样命令不会报错，故猜测没有权限，修改语法为git config --global http.sslVerify false即可
重新构建

日志符合预期

freestyle shell Job
新建任务

写入shell脚本如下
#!/bin/bash

user=`whoami`

if [ $user == &#39;deploy&#39; ]; then
	echo &amp;quot;成功，当前用户为 $user&amp;quot;
else
	echo &amp;quot;失败，当前用户不是 $user&amp;quot;
fi
# 查看主机ip
ip addr
# 查看系统版本
cat /etc/system-release
# 查看内存状态
free -m
# 查看磁盘状态
df -h
# 将python安装位置赋值给变量
py_cmd=`which python`
# 查看python版本号
$py_cmd --version


运行并查看日志，符合预期

参数任务
新建参数化构建任务

添加选项参数等

添加shell构建参数

构建

输出符合预期


                                        </div>
                                        
                                            <a class="btn btn-text" href="https://fjiayang.github.io//post/jenkins-job-bian-xie-ce-shi">Read More ~</a>
                            </div>
                </div>
            </article>
            
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://fjiayang.github.io//post/jenkins-an-zhuang-pei-zhi">
                        Jenkins 安装配置
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2018-08-26</time>
                    
                        <a href="https://fjiayang.github.io//tag/55CGdWlsfz" class="post-tag i-tag
                            i-tag-other_1">
            #Jenkins
        </a>
                        
                </div>
                <div class="post-article">
                    
                            <div class="post-content">
                                
                                        <div class="post-content-content">
                                            使用Docker安装
基础环境
docker环境
查看docker版本
[root@localhost ~]# docker -v
Docker version 18.06.0-ce, build 0ffa825

新建用户目录，用户挂载容器存储
useradd jenkins-docker


运行docker命令
docker run -p 8081:8080 -p 50001:50000  -v /home/jenkins-docker:/var/jenkins_home hub.c.163.com/library/jenkins:latest


命令中没有使用后台启动为了查看输出的管理员密码

若使用了挂载目录也可以在挂载的目录下查看

访问web界面，输入密码即可

使用原生系统安装
基础环境
CentOS7 1804最小安装
安装基础wget工具yum install -y wget

导入仓库源
wget -O /etc/yum.repos.d/jenkins.repo http://pkg.jenkins.io/redhat-stable/jenkins.repo


下载并导入仓库的key，用于验证仓库安全性
rpm --import http://pkg.jenkins.io/redhat-stable/jenkins.io.key

安装java8
yum -y install java

验证java版本
[root@localhost ~]# java -version
openjdk version &amp;quot;1.8.0_181&amp;quot;
OpenJDK Runtime Environment (build 1.8.0_181-b13)
OpenJDK 64-Bit Server VM (build 25.181-b13, mixed mode)

关闭防火墙
[root@localhost ~]# systemctl stop firewalld

关闭防火墙开机启动
[root@localhost ~]# systemctl disable firewalld
Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service.
Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.

关闭强制访问控制安全策略
vi /etc/sysconfig/selinux

# This file controls the state of SELinux on the system.
# SELINUX= can take one of these three values:
#     enforcing - SELinux security policy is enforced.
#     permissive - SELinux prints warnings instead of enforcing.
#     disabled - No SELinux policy is loaded.
SELINUX=enforcing
# SELINUXTYPE= can take one of three two values:
#     targeted - Targeted processes are protected,
#     minimum - Modification of targeted policy. Only selected processes are protected.
#     mls - Multi Level Security protection.
SELINUXTYPE=targeted

SELINUX=enforcing

改成
SELINUX=disabled

reboot使禁用操作生效
查看操作是否生效
[root@localhost ~]# getenforce
Disabled

安装jenkins
直接安装
yum -y install jenkins


安装后会自动添加jenkins，此时可以自定义发布用户
[root@localhost ~]# useradd jenkins
useradd：用户“jenkins”已存在
[root@localhost ~]# useradd deploy

配置
编辑配置文件
[root@localhost ~]# vi /etc/sysconfig/jenkins 

将用户改为新建的用户JENKINS_USER=&amp;quot;deploy&amp;quot;，端口号默认为8080

修改log目录和权限
[root@localhost ~]# chown -R deploy:deploy /var/lib/jenkins
[root@localhost ~]# chown -R deploy:deploy /var/log/jenkins
[root@localhost ~]# chown -R deploy:deploy /var/cache/jenkins

启动jenkins
[root@localhost ~]# systemctl start jenkins

查看服务是否启动
[root@localhost ~]# ps -ef | grep jenkins
root       1445   1311  0 19:06 pts/0    00:00:00 grep --color=auto jenkins

或者使用lsof（需要额外安装）
[root@localhost jenkins]# lsof -i:8080
COMMAND  PID   USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
java    1683 deploy  161u  IPv6  24353      0t0  TCP *:webcache (LISTEN)

访问web界面
地址为ip:8080

去提示的目录下查找密码

安装推荐配置插件

新建管理员用户

安装成功


                                        </div>
                                        
                                            <a class="btn btn-text" href="https://fjiayang.github.io//post/jenkins-an-zhuang-pei-zhi">Read More ~</a>
                            </div>
                </div>
            </article>
            
                <!-- 翻页 -->
                
    <div class="pagination-container">
        
            <a href="https://fjiayang.github.io//page/3/" class="page-btn btn">上一页</a>
            
                
    </div>
    
                </div>
                <!--  -->
                <div class="main-container-middle"></div>
                <!--  -->
                <div id="sidebar" class="main-container-right">

                    <!-- 个人信息 -->
                    
    <div class="id_card i-card">
        <div class="id_card-avatar" style="background-image: url(https://fjiayang.github.io//images/avatar.png?v=1579680039929)">
        </div>
        <h1 class="id_card-title">
            F嘉阳
        </h1>
        <h2 class="id_card-description">
            愿你被世界温柔以待
        </h2>
        <!--  -->
        <div class="id_card-sns">
            <!-- github -->
            
                    <!-- twitter -->
                    
                            <!-- weibo -->
                            
                                <a href="https://weibo.com/2007780675" target="_blank" rel="noopener noreferrer"><i
                class="fa fa-weibo"></i></a>
                                
                                    <!-- facebook -->
                                    

        </div>
    </div>
    

                        <!-- 公告栏 -->
                        
    <div class="notice-card i-card ">
        <div class="notice-title i-card-title">公告</div>
        <div class="notice-content">
            主博客：https://blog.fjy8018.top/
        </div>
    </div>
    

                </div>
            </div>



            <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | <a href="https://blog.fjy8018.top/" target="_blank">F嘉阳 博客</a> | 
  <a class="rss" href="https://fjiayang.github.io//atom.xml" target="_blank">RSS</a>
</div>

<script>
  hljs.initHighlightingOnLoad()
</script>

    </div>
    <script>
        $('#sidebar').stickySidebar({
            topSpacing: 80,
            // bottomSpacing: 60
        });
    </script>
</body>

</html>