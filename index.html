<html>

<head>
    <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>
    F嘉阳
</title>
<link rel="shortcut icon" href="https://fjiayang.github.io//favicon.ico?v=1579679926111">
<!-- <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous"> -->
<link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://fjiayang.github.io//styles/main.css">
<!-- js -->
<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
<script src="https://fjiayang.github.io//media/js/jquery.sticky-sidebar.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/moment.js/2.23.0/moment.min.js"></script>


</head>

<body>
    <div class="main">
        <div class="header">
    <div class="nav">
        <div class="logo">
            <a href="https://fjiayang.github.io/">
                <img class="avatar" src="https://fjiayang.github.io//images/avatar.png?v=1579679926111" alt="">
            </a>
            <div class="site-title">
                <h1>
                    F嘉阳
                </h1>
            </div>
        </div>
        <span class="menu-btn fa fa-align-justify"></span>
        <div class="menu-container">
            <ul>
                
                    
                            <li>
                                <a href="/" class="menu">
                                    首页
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/archives" class="menu">
                                    归档
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/tags" class="menu">
                                    标签
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/post/about" class="menu">
                                    关于
                                </a>
                            </li>
                            
                                
            </ul>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        $(".menu-btn").click(function() {
            $(".menu-container").slideToggle();
        });
        $(window).resize(function() {

            if (window.matchMedia('(min-width: 960px)').matches) {
                $(".menu-container").css('display', 'block')
            } else {
                $(".menu-container").css('display', 'none')
            }

        });
    });
</script>

            <div id="main-content" class="post-container main-container">
                <div id="content" class="main-container-left">
                    
        
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://fjiayang.github.io//post/activiti-xue-xi-bi-ji">
                        `Activiti` 学习笔记
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2020-01-22</time>
                    
                </div>
                <div class="post-article">
                    
                            <div class="post-content">
                                
                                        <div class="post-content-content">
                                            概览
流程引擎配置
配置核心为ProcessEnigne，可获取各种Service
graph LR
    A[activiti.cfg.xml] --&amp;gt; B[ProcessEnigneConfiguration] 
    B --&amp;gt; C[ProcessEnigne]
    C --&amp;gt; D[RepositoryService]
    C --&amp;gt; E[RuntimeService]
    C --&amp;gt; F[xxxService]

核心API

RepositoryService 负责对流程定义文件管理，操作静态文件xml、图片等。其中涉及两个实体对象：部署对象和资源对象，两者关系为一对多，即一次部署可以有多个资源对象
RuntimeService实现对流程的控制，如启动、暂停、挂起等，可以查询进行中的流程实例和对象以及操作流程中的上下文数据
TaskService操作人工任务，增删改查等
IdentityService操作用户和用户组并维护用户组的关系
FormServcie操作和渲染输入表单数据
HistoryService查询运行结束的流程实例
ManagemenetService对流程引擎进行基础管理，如定时任务Job等
DynamicBpmServcie可以动态的对流程进行修改，侵入性较高

数据模型设计
官方文档



数据表分类
描述




ACT_RE_*
RE代表repository。具有此前缀的表包含静态信息，例如流程定义和流程资源（图像，规则等）。


ACT_RU_*
RU代表runtime。这些是包含流程实例，用户任务，变量，作业等的运行时数据的运行时表.Activiti仅在流程实例执行期间存储运行时数据，并在流程实例结束时删除记录。这使运行时表保持小而快。


ACT_ID_*
ID代表identity。这些表包含身份信息，例如用户，组等。


ACT_HI_*
HI代表history。这些是包含历史数据的表，例如过去的流程实例，变量，任务等。


ACT_GE_*
general数据，通用数据表，用于各种用例。



BPMN 2.0
简介
BPMN2.0（Business Process Model and Notation）

是一套业务流程模型与符号建模标准
精准的执行语义来描述元素的操作
以XML为载体，以符号可视化业务

符号


快速部署


从官方仓库下载Activiti6.0
官方仓库


下载Tomcat


安装JDK 8


将activiti压缩包内的activiti-app.war和activiti-admin.war放入Tomcat的webapps路径下


启动Tomcat


访问 http://localhost:8080/activiti-app 即可


默认用户名：admin 密码：test

主页

简单流程设计
创建用户




创建流程



自动进入流程绘制页面


配置用户状态


第二级同理

保存模型

选择保存并关闭

结果

创建应用


选择包含的流程




选择保存并发布

结果

首页已经包含新的模块

简单流程执行
发起流程
登出并使用普通用户登陆

启动流程

流程启动成功，可以添加描述

审批
切换用户TL查看代办任务，点击Claim获取

添加备注

此时用户登陆可以看到当前的流程进度

切换用户HR执行相同操作即可
流程结束
流程结束后所有用户都无法查看到该流程，可以通过访问http://localhost:8080/activiti-admin 查看
用户名：admin，密码：admin


如果端口号识别有误可以手动修改并检测

管理端可以查看历史流程执行信息
核心模块分析
克隆官方源码
源码地址
切换为6.0.0分支
$ git checkout -b study6 activiti-6.0.0
Checking out files: 100% (13850/13850), done.
Switched to a new branch &#39;study6&#39;

编译
$ mvn clean test-compile


核心模块

modules/activiti-engine 核心引擎
modules/activiti-spring Spring集成模块
modules/activiti-spring-boot SpringBoot集成模块
modules/activiti-rest 对外提供rest api模块
modules/activiti-form-engine 表单引擎模块
modules/activiti-ldap 集成LDAP用户的模块

activiti-engine模块依赖图

基于源码运行Activiti App
模块结构图

模块功能

activiti-app-logic UI的业务逻辑
activiti-app-rest 提供接口的Rest Api
activiti-app-conf UI独立于业务外的配置
activiti-app 集成发布的WAR工程（无Java代码）

启动
进入App模块
$ cd modules/activiti-ui/activiti-app

启动
$ mvn clean tomcat7:run

这种方式启动默认端口为9999

或者执行start-jrebel.sh可以支持热部署
源码分析
WebConfigurer源码
在\modules\activiti-ui\activiti-app\src\main\webapp\WEB-INF\web.xml中包含Servlet配置类WebConfigurer，其实现了Servlet监听器ServletContextListener
package org.activiti.app.servlet;

public class WebConfigurer implements ServletContextListener {
	
    private final Logger log = LoggerFactory.getLogger(WebConfigurer.class);

    public AnnotationConfigWebApplicationContext context;
    
    public void setContext(AnnotationConfigWebApplicationContext context) {
        this.context = context;
    }
    
    @Override
    public void contextInitialized(ServletContextEvent sce) {
        log.debug(&amp;quot;Configuring Spring root application context&amp;quot;);
		// Servlet容器初始化
        ServletContext servletContext = sce.getServletContext();
		// Spring容器初始化
        AnnotationConfigWebApplicationContext rootContext = null;
        
        if (context == null) {
            rootContext = new AnnotationConfigWebApplicationContext();
            // 注册根容器应用配置
            rootContext.register(ApplicationConfiguration.class);
            // 将Spring容器于Servlet容器进行双向绑定
            if (rootContext.getServletContext() == null) {
              // Spring 容器注入Servlet容器
              rootContext.setServletContext(servletContext);
            }
            
            rootContext.refresh();
            context = rootContext;
            
        } else {
            rootContext = context;
            if (rootContext.getServletContext() == null) {
              rootContext.setServletContext(servletContext);
            }
        }
        // Servlet 容器作为属性注入 Spring容器
 servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, rootContext);

        EnumSet&amp;lt;DispatcherType&amp;gt; disps = EnumSet.of(DispatcherType.REQUEST, DispatcherType.FORWARD, DispatcherType.ASYNC);
		// Spring初始化
        initSpring(servletContext, rootContext);
        // 安全相关初始化
        initSpringSecurity(servletContext, disps);

        log.debug(&amp;quot;Web application fully configured&amp;quot;);
    }

    /**
     * 基于Servlet 3.0规范 通过编码方式注入Servlet配置
     */
    private void initSpring(ServletContext servletContext, AnnotationConfigWebApplicationContext rootContext) {
        log.debug(&amp;quot;Configuring Spring Web application context&amp;quot;);
        // 注册子容器1 AppDispatcherServlet
        AnnotationConfigWebApplicationContext appDispatcherServletConfiguration = new AnnotationConfigWebApplicationContext();
        // 绑定父容器
        appDispatcherServletConfiguration.setParent(rootContext);
        appDispatcherServletConfiguration.register(AppDispatcherServletConfiguration.class);

        log.debug(&amp;quot;Registering Spring MVC Servlet&amp;quot;);
        // 绑定配置
        ServletRegistration.Dynamic appDispatcherServlet = servletContext.addServlet(&amp;quot;appDispatcher&amp;quot;, 
                new DispatcherServlet(appDispatcherServletConfiguration));
        // 设置映射
        appDispatcherServlet.addMapping(&amp;quot;/app/*&amp;quot;);
        appDispatcherServlet.setLoadOnStartup(1);
        // 开启异步支持
        appDispatcherServlet.setAsyncSupported(true);

        log.debug(&amp;quot;Registering Activiti public REST API&amp;quot;);
        
        // 注册子容器2 ApiDispatcherServlet
        AnnotationConfigWebApplicationContext apiDispatcherServletConfiguration = new AnnotationConfigWebApplicationContext();
        // 绑定父容器
        apiDispatcherServletConfiguration.setParent(rootContext);
        apiDispatcherServletConfiguration.register(ApiDispatcherServletConfiguration.class);
		// 绑定配置
        ServletRegistration.Dynamic apiDispatcherServlet = servletContext.addServlet(&amp;quot;apiDispatcher&amp;quot;,
                new DispatcherServlet(apiDispatcherServletConfiguration));
        // 设置映射
        apiDispatcherServlet.addMapping(&amp;quot;/api/*&amp;quot;);
        apiDispatcherServlet.setLoadOnStartup(1);
        // 开启异步支持
        apiDispatcherServlet.setAsyncSupported(true);
    }
    
    private void initSpringSecurity(ServletContext servletContext, EnumSet&amp;lt;DispatcherType&amp;gt; disps) {...}

    @Override
    public void contextDestroyed(ServletContextEvent sce) {...}
}

容器结构图
graph TD
    A[rootContext] --&amp;gt; B[AppDispatcherServlet] 
    A --&amp;gt; C[ApiDispatcherServlet]

ApplicationConfiguration源码
该类为应用配置类，注册为Spring配置类，并指定了配置资源文件和包扫描路径，其中源码中标明了activiti-app.properties允许不存在，说明Activiti包含了规约配置也允许用户覆盖默认配置
package org.activiti.app.conf;

import org.springframework.context.annotation.*;
import org.springframework.context.support.PropertySourcesPlaceholderConfigurer;

@Configuration
@PropertySources({
	
	@PropertySource(&amp;quot;classpath:/META-INF/activiti-app/activiti-app.properties&amp;quot;),
	@PropertySource(value = &amp;quot;classpath:activiti-app.properties&amp;quot;, ignoreResourceNotFound = true),
	@PropertySource(value = &amp;quot;file:activiti-app.properties&amp;quot;, ignoreResourceNotFound = true),

})
@ComponentScan(basePackages = {
        &amp;quot;org.activiti.app.conf&amp;quot;,
        &amp;quot;org.activiti.app.repository&amp;quot;,
        &amp;quot;org.activiti.app.service&amp;quot;,
        &amp;quot;org.activiti.app.security&amp;quot;,
        &amp;quot;org.activiti.app.model.component&amp;quot;})
public class ApplicationConfiguration {
	@Bean
    public static PropertySourcesPlaceholderConfigurer propertySourcesPlaceholderConfigurer() {
        return new PropertySourcesPlaceholderConfigurer();
    }
}

AppDispatcherServletConfiguration源码
该类为根容器Servlet配置Bean，该类仅扫描Rest包，主要实现请求数据处理
package org.activiti.app.servlet;

@Configuration
@ComponentScan(value = {&amp;quot;org.activiti.app.rest&amp;quot;})
@EnableAsync
public class AppDispatcherServletConfiguration extends WebMvcConfigurationSupport {

    private final Logger log = LoggerFactory.getLogger(AppDispatcherServletConfiguration.class);

    @Inject
    private ObjectMapper objectMapper;
    
    @Inject
    private Environment environment;

    @Bean
    public SessionLocaleResolver localeResolver() {
        return new SessionLocaleResolver();
    }

    @Bean
    public LocaleChangeInterceptor localeChangeInterceptor() {
        // 配置本地化
        log.debug(&amp;quot;Configuring localeChangeInterceptor&amp;quot;);
        LocaleChangeInterceptor localeChangeInterceptor = new LocaleChangeInterceptor();
        localeChangeInterceptor.setParamName(&amp;quot;language&amp;quot;);
        return localeChangeInterceptor;
    }

    @Bean
    public MultipartResolver multipartResolver() {
        // 文件上传配置
        CommonsMultipartResolver multipartResolver = new CommonsMultipartResolver();
        multipartResolver.setMaxUploadSize(environment.getProperty(&amp;quot;file.upload.max.size&amp;quot;, Long.class));
        return multipartResolver;
    }

    @Bean
    public RequestMappingHandlerMapping requestMappingHandlerMapping() {
        // Spring 请求处理器
        log.debug(&amp;quot;Creating requestMappingHandlerMapping&amp;quot;);
        RequestMappingHandlerMapping requestMappingHandlerMapping = new RequestMappingHandlerMapping();
        // 禁用后缀匹配
        requestMappingHandlerMapping.setUseSuffixPatternMatch(false);
        // 保留原本的URL
        requestMappingHandlerMapping.setRemoveSemicolonContent(false);
        Object[] interceptors = {localeChangeInterceptor()};
        requestMappingHandlerMapping.setInterceptors(interceptors);
        return requestMappingHandlerMapping;
    }
    
    @Override
    public void configureMessageConverters(List&amp;lt;HttpMessageConverter&amp;lt;?&amp;gt;&amp;gt; converters) {
        addDefaultHttpMessageConverters(converters);
        for (HttpMessageConverter&amp;lt;?&amp;gt; converter: converters) {
            // 序列化
            if (converter instanceof MappingJackson2HttpMessageConverter) {
                MappingJackson2HttpMessageConverter jackson2HttpMessageConverter = (MappingJackson2HttpMessageConverter) converter;
                jackson2HttpMessageConverter.setObjectMapper(objectMapper);
                break;
            }
        }
    }
}

利用源码工具创建Maven脚手架
路径\tooling\archetypes\activiti-archetype-unittest
目录结构

进入archetypes目录通过命令安装即可
$ mvn clean install

默认不会在新建工程中显示，需要手动添加

填写版本信息

创建成功

通过脚手架创建工程

通过编码方式设计流程
通过编码设计二级审批流程，基于命令行交互
设计流程图
使用在线BPMN绘图工具快速绘制
在线绘制地址

下载为.bpmn文件放入工程resources目录即可
推荐使用activiti 官方eclipse插件绘制
Activiti-Designer下载地址
使用离线安装即可
创建流程图工程

绘制结果

配置流程图
配置需要填写的表单


配置判断表达式，语法为EL表达式


创建工程
使用maven创建空工程
加入依赖配置
&amp;lt;dependencies&amp;gt;
    &amp;lt;dependency&amp;gt;
        &amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;
        &amp;lt;artifactId&amp;gt;spring-boot-starter&amp;lt;/artifactId&amp;gt;
    &amp;lt;/dependency&amp;gt;
    &amp;lt;!-- 流程引擎 --&amp;gt;
    &amp;lt;dependency&amp;gt;
        &amp;lt;groupId&amp;gt;org.activiti&amp;lt;/groupId&amp;gt;
        &amp;lt;artifactId&amp;gt;activiti-engine&amp;lt;/artifactId&amp;gt;
        &amp;lt;version&amp;gt;6.0.0&amp;lt;/version&amp;gt;
    &amp;lt;/dependency&amp;gt;
    &amp;lt;!-- 单元测试 --&amp;gt;
    &amp;lt;dependency&amp;gt;
        &amp;lt;groupId&amp;gt;junit&amp;lt;/groupId&amp;gt;
        &amp;lt;artifactId&amp;gt;junit&amp;lt;/artifactId&amp;gt;
        &amp;lt;version&amp;gt;4.11&amp;lt;/version&amp;gt;
        &amp;lt;scope&amp;gt;test&amp;lt;/scope&amp;gt;
    &amp;lt;/dependency&amp;gt;
    &amp;lt;!-- 日志 --&amp;gt;
    &amp;lt;dependency&amp;gt;
        &amp;lt;groupId&amp;gt;ch.qos.logback&amp;lt;/groupId&amp;gt;
        &amp;lt;artifactId&amp;gt;logback-classic&amp;lt;/artifactId&amp;gt;
        &amp;lt;version&amp;gt;1.2.3&amp;lt;/version&amp;gt;
    &amp;lt;/dependency&amp;gt;
    &amp;lt;!-- 日志、实体类插件 --&amp;gt;
    &amp;lt;dependency&amp;gt;
        &amp;lt;groupId&amp;gt;org.projectlombok&amp;lt;/groupId&amp;gt;
        &amp;lt;artifactId&amp;gt;lombok&amp;lt;/artifactId&amp;gt;
        &amp;lt;version&amp;gt;1.18.2&amp;lt;/version&amp;gt;
        &amp;lt;scope&amp;gt;provided&amp;lt;/scope&amp;gt;
    &amp;lt;/dependency&amp;gt;
    &amp;lt;!-- 工具类 --&amp;gt;
    &amp;lt;dependency&amp;gt;
        &amp;lt;groupId&amp;gt;com.google.guava&amp;lt;/groupId&amp;gt;
        &amp;lt;artifactId&amp;gt;guava&amp;lt;/artifactId&amp;gt;
        &amp;lt;version&amp;gt;23.0&amp;lt;/version&amp;gt;
    &amp;lt;/dependency&amp;gt;
    &amp;lt;!-- 内存数据库 --&amp;gt;
    &amp;lt;dependency&amp;gt;
        &amp;lt;groupId&amp;gt;com.h2database&amp;lt;/groupId&amp;gt;
        &amp;lt;artifactId&amp;gt;h2&amp;lt;/artifactId&amp;gt;
        &amp;lt;version&amp;gt;1.4.196&amp;lt;/version&amp;gt;
    &amp;lt;/dependency&amp;gt;
&amp;lt;/dependencies&amp;gt;

配置日志文件logback.xml
&amp;lt;?xml version=&amp;quot;1.0&amp;quot; encoding=&amp;quot;UTF-8&amp;quot;?&amp;gt;
&amp;lt;configuration scan=&amp;quot;true&amp;quot; scanPeriod=&amp;quot;60 seconds&amp;quot; debug=&amp;quot;false&amp;quot;&amp;gt;
    &amp;lt;!-- ConsoleAppender 控制台输出日志 --&amp;gt;
    &amp;lt;appender name=&amp;quot;STDOUT&amp;quot; class=&amp;quot;ch.qos.logback.core.ConsoleAppender&amp;quot;&amp;gt;
        &amp;lt;!-- 对日志进行格式化 --&amp;gt;
        &amp;lt;encoder&amp;gt;
            &amp;lt;pattern&amp;gt;%msg%n&amp;lt;/pattern&amp;gt;
        &amp;lt;/encoder&amp;gt;
    &amp;lt;/appender&amp;gt;

    &amp;lt;logger name=&amp;quot;top.fjy8018.activiti&amp;quot; level=&amp;quot;DEBUG&amp;quot;/&amp;gt;
    &amp;lt;logger name=&amp;quot;ch.qos.logback&amp;quot; level=&amp;quot;OFF&amp;quot;/&amp;gt;
    &amp;lt;logger name=&amp;quot;root&amp;quot; level=&amp;quot;ERROR&amp;quot;/&amp;gt;

    &amp;lt;!-- root级别   WARN --&amp;gt;
    &amp;lt;root&amp;gt;
        &amp;lt;!-- 控制台输出 --&amp;gt;
        &amp;lt;appender-ref ref=&amp;quot;STDOUT&amp;quot;/&amp;gt;
    &amp;lt;/root&amp;gt;
&amp;lt;/configuration&amp;gt;

拷贝写好的.bpmn文件到资源目录

工程源码
启动类
package top.fjy8018.activiti.helloworld;

import com.google.common.collect.Maps;
import lombok.extern.slf4j.Slf4j;
import org.activiti.engine.*;
import org.activiti.engine.form.FormProperty;
import org.activiti.engine.form.TaskFormData;
import org.activiti.engine.impl.form.DateFormType;
import org.activiti.engine.impl.form.StringFormType;
import org.activiti.engine.repository.Deployment;
import org.activiti.engine.repository.DeploymentBuilder;
import org.activiti.engine.repository.ProcessDefinition;
import org.activiti.engine.runtime.ProcessInstance;
import org.activiti.engine.task.Task;

import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;
import java.util.Map;
import java.util.Scanner;

/**
 * 启动类
 *
 * @author F嘉阳
 * @date 2018/8/29 20:19
 */
@Slf4j
public class Main {

    public static void main(String[] args) throws ParseException {
        log.info(&amp;quot;主程序启动&amp;quot;);
        // 创建流程引擎
        ProcessEngine processEngine = getProcessEngine();

        // 部署流程定义文件
        ProcessDefinition processDefinition = getProcessDefinition(processEngine);

        // 启动流程
        ProcessInstance processInstance = getProcessInstance(processEngine, processDefinition);

        // 处理流程任务
        processTask(processEngine, processInstance);
        log.info(&amp;quot;主程序结束&amp;quot;);
    }

    /**
     * 处理流程任务
     *
     * @param processEngine
     * @param processInstance
     * @throws ParseException
     */
    private static void processTask(ProcessEngine processEngine, ProcessInstance processInstance) throws ParseException {
        // 处理控制台输入
        Scanner scanner = new Scanner(System.in);
        // 流程不为空且流程未结束
        while (processInstance != null &amp;amp;&amp;amp; !processInstance.isEnded()) {
            TaskService taskService = processEngine.getTaskService();
            // 列出所有任务
            List&amp;lt;Task&amp;gt; taskList = taskService.createTaskQuery().list();
            log.info(&amp;quot;待处理任务数量 [{}]&amp;quot;, taskList.size());
            for (Task task : taskList) {
                log.info(&amp;quot;待处理任务 [{}]&amp;quot;, task.getName());
                // 处理表单输入
                FormService formService = processEngine.getFormService();
                // 取出当前任务的表单信息
                TaskFormData taskFormData = formService.getTaskFormData(task.getId());
                // 取出属性值
                List&amp;lt;FormProperty&amp;gt; formProperties = taskFormData.getFormProperties();
                formProperties.forEach(e -&amp;gt; log.info(&amp;quot;属性值 {},类型 {}&amp;quot;, e.getName(), e.getType()));
                Map&amp;lt;String, Object&amp;gt; variables = getMap(scanner, formProperties);
                // 提交工作
                taskService.complete(task.getId(), variables);
                // 同步最新流程状态
                processInstance = processEngine
                        .getRuntimeService()
                        .createProcessInstanceQuery()
                        .processInstanceId(processInstance.getId())
                        .singleResult();
            }
        }
        scanner.close();
    }

    /**
     * 读取参数
     *
     * @param scanner        标准输入
     * @param formProperties 表单参数集合
     * @return Map
     * @throws ParseException
     */
    private static Map&amp;lt;String, Object&amp;gt; getMap(Scanner scanner, List&amp;lt;FormProperty&amp;gt; formProperties) throws ParseException {
        Map&amp;lt;String, Object&amp;gt; variables = Maps.newHashMap();
        // 支持多参数输入
        for (FormProperty formProperty : formProperties) {
            String line = &amp;quot;&amp;quot;;
            // 对输入类型判断
            if (StringFormType.class.isInstance(formProperty.getType())) {
                log.info(&amp;quot;请输入 {} ?&amp;quot;, formProperty.getName());
                line = scanner.nextLine();
                // 存储输入
                variables.put(formProperty.getId(), line);
            } else {
                if (DateFormType.class.isInstance(formProperty.getType())) {
                    log.info(&amp;quot;请输入 {} ? 格式 (yyyy-MM-dd HH:mm:ss)&amp;quot;, formProperty.getName());
                    line = scanner.nextLine();
                    // 日期格式化
                    SimpleDateFormat dateFormat = new SimpleDateFormat(&amp;quot;yyyy-MM-dd HH:mm:ss&amp;quot;);
                    Date date = dateFormat.parse(line);
                    variables.put(formProperty.getId(), line);
                    log.info(&amp;quot;输入的内容为 [{}]&amp;quot;, line);
                } else {
                    // 其余类型
                    log.info(&amp;quot;{} 类型暂不支持&amp;quot;, formProperty.getType());
                }
            }
            log.info(&amp;quot;输入的内容给 [{}]&amp;quot;, line);
        }
        return variables;
    }

    /**
     * 启动流程
     *
     * @param processEngine
     * @param processDefinition
     * @return ProcessInstance
     */
    private static ProcessInstance getProcessInstance(ProcessEngine processEngine, ProcessDefinition processDefinition) {
        // 新建运行时对象
        RuntimeService runtimeService = processEngine.getRuntimeService();
        // 通过ID启动
        ProcessInstance processInstance = runtimeService.startProcessInstanceById(processDefinition.getId());
        log.info(&amp;quot;启动流程 [{}]&amp;quot;, processInstance.getProcessDefinitionKey());
        return processInstance;
    }

    /**
     * 部署流程定义文件
     *
     * @param processEngine
     * @return ProcessDefinition
     */
    private static ProcessDefinition getProcessDefinition(ProcessEngine processEngine) {
        // 创建对二进制文件操作的service
        RepositoryService repositoryService = processEngine.getRepositoryService();
        DeploymentBuilder deploymentBuilder = repositoryService.createDeployment();
        // 指定路径
        deploymentBuilder.addClasspathResource(&amp;quot;second_approve.bpmn&amp;quot;);
        // 部署
        Deployment deploy = deploymentBuilder.deploy();
        String deployId = deploy.getId();
        // 获得流程定义对象
        ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().deploymentId(deployId).singleResult();

        // 输出=&amp;gt;流程定义文件二级审批流程，流程IDsecond_approve:1:4，:1:4为部署ID与流程ID组装的结果
        log.info(&amp;quot;流程定义文件 [{}]，流程ID [{}]&amp;quot;, processDefinition.getName(), processDefinition.getId());
        return processDefinition;
    }

    /**
     * 创建流程引擎
     *
     * @return ProcessEngine
     */
    private static ProcessEngine getProcessEngine() {
        // 创建基于内存的流程引擎
        ProcessEngineConfiguration cfg = ProcessEngineConfiguration.createStandaloneInMemProcessEngineConfiguration();
        // 构造流程引擎
        ProcessEngine processEngine = cfg.buildProcessEngine();
        // 获取流程引擎信息
        String name = processEngine.getName();
        String version = ProcessEngine.VERSION;
        log.info(&amp;quot;流程引擎名称[{}],版本[{}]&amp;quot;, name, version);
        return processEngine;
    }
}

maven打包
直接打包
$ mvn clean package

或者打包同时运行
$ mvn clean spring-boot:run

执行
结果
主程序启动
流程引擎名称[default],版本[6.0.0.4]
流程定义文件 [二级审批流程]，流程ID [second_approve:1:4]
启动流程 [second_approve]
待处理任务数量 [1]
待处理任务 [填写审批信息]
属性值 申请信息,类型 org.activiti.engine.impl.form.StringFormType@5bfa8cc5
属性值 申请人姓名,类型 org.activiti.engine.impl.form.StringFormType@5bfa8cc5
属性值 提交时间,类型 org.activiti.engine.impl.form.DateFormType@666b83a4
属性值 确认申请,类型 org.activiti.engine.impl.form.StringFormType@5bfa8cc5
请输入 申请信息 ?
TEST
输入的内容给 [TEST]
请输入 申请人姓名 ?
FJY
输入的内容给 [FJY]
请输入 提交时间 ? 格式 (yyyy-MM-dd)
2019-01-01
输入的内容为 [Tue Jan 01 00:00:00 CST 2019]
输入的内容给 [2019-01-01]
请输入 确认申请 ?
Y
输入的内容给 [Y]
待处理任务数量 [1]
待处理任务 [主管审批]
属性值 主管审批结果,类型 org.activiti.engine.impl.form.StringFormType@5bfa8cc5
属性值 主管备注,类型 org.activiti.engine.impl.form.StringFormType@5bfa8cc5
请输入 主管审批结果 ?
Y
输入的内容给 [Y]
请输入 主管备注 ?
YES
输入的内容给 [YES]
待处理任务数量 [1]
待处理任务 [HR审批]
属性值 人事审批结果,类型 org.activiti.engine.impl.form.StringFormType@5bfa8cc5
属性值 人事审批备注,类型 org.activiti.engine.impl.form.StringFormType@5bfa8cc5
请输入 人事审批结果 ?
Y
输入的内容给 [Y]
请输入 人事审批备注 ?
YES
输入的内容给 [YES]
主程序结束

流程创建引擎配置
引擎配置结构图
graph TD
    A[activiti.cfg.xml] --&amp;gt; B[ProcessEnigneConfiguration] 
    B --&amp;gt; C[ProcessEnigne]
    C --&amp;gt; D[RepositoryService]
    C --&amp;gt; E[RuntimeService]
    C --&amp;gt; F[xxxService]

ProcessEnigneConfiguration核心功能

查找并解析xml配置文件activiti.cfg.xml
提供多个静态方法创建配置对象
实现几个基于不同场景的子类，配置方式非常灵活

ProcessEngineConfiguration源码
其提供了7个静态方法创建流程引擎对象
package org.activiti.engine;

public abstract class ProcessEngineConfiguration {
    ...
    // 默认配置创建
	public static ProcessEngineConfiguration createProcessEngineConfigurationFromResourceDefault() {
    return createProcessEngineConfigurationFromResource(&amp;quot;activiti.cfg.xml&amp;quot;, &amp;quot;processEngineConfiguration&amp;quot;);
  }

  public static ProcessEngineConfiguration createProcessEngineConfigurationFromResource(String resource) {
    return createProcessEngineConfigurationFromResource(resource, &amp;quot;processEngineConfiguration&amp;quot;);
  }
  // 指定配置创建
  public static ProcessEngineConfiguration createProcessEngineConfigurationFromResource(String resource, String beanName) {
    return BeansConfigurationHelper.parseProcessEngineConfigurationFromResource(resource, beanName);
  }

  public static ProcessEngineConfiguration createProcessEngineConfigurationFromInputStream(InputStream inputStream) {
    return createProcessEngineConfigurationFromInputStream(inputStream, &amp;quot;processEngineConfiguration&amp;quot;);
  }

  public static ProcessEngineConfiguration createProcessEngineConfigurationFromInputStream(InputStream inputStream, String beanName) {
    return BeansConfigurationHelper.parseProcessEngineConfigurationFromInputStream(inputStream, beanName);
  }
  // 独立引擎对象
  public static ProcessEngineConfiguration createStandaloneProcessEngineConfiguration() {
    return new StandaloneProcessEngineConfiguration();
  }
  // 独立的内存引擎对象
  public static ProcessEngineConfiguration createStandaloneInMemProcessEngineConfiguration() {
    return new StandaloneInMemProcessEngineConfiguration();
  }
    ...
}

其实现类关系图，通过多个子类适配不同场景

实现类主要功能

ProcessEngineConfigurationImpl非真正的实现类，实现了大部分引擎配置
StandaloneProcessEngineConfiguration 用于支持独立部署运行
SpringProcessEngineConfiguration 实现Spring集成，包括数据源、事务、外部化配置等

不同配置差异
创建默认配置
工程下创建配置文件activiti.cfg.xml，从源码工程中获取并修改如下
&amp;lt;?xml version=&amp;quot;1.0&amp;quot; encoding=&amp;quot;UTF-8&amp;quot;?&amp;gt;

&amp;lt;beans xmlns=&amp;quot;http://www.springframework.org/schema/beans&amp;quot;
       xmlns:xsi=&amp;quot;http://www.w3.org/2001/XMLSchema-instance&amp;quot;
       xsi:schemaLocation=&amp;quot;http://www.springframework.org/schema/beans   http://www.springframework.org/schema/beans/spring-beans.xsd&amp;quot;&amp;gt;

  &amp;lt;bean id=&amp;quot;processEngineConfiguration&amp;quot; class=&amp;quot;org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration&amp;quot;&amp;gt;
    &amp;lt;property name=&amp;quot;jdbcUrl&amp;quot; value=&amp;quot;jdbc:h2:mem:activiti;DB_CLOSE_DELAY=1000;MVCC=TRUE&amp;quot; /&amp;gt;
    &amp;lt;property name=&amp;quot;jdbcDriver&amp;quot; value=&amp;quot;org.h2.Driver&amp;quot; /&amp;gt;
    &amp;lt;property name=&amp;quot;jdbcUsername&amp;quot; value=&amp;quot;sa&amp;quot; /&amp;gt;
    &amp;lt;property name=&amp;quot;jdbcPassword&amp;quot; value=&amp;quot;&amp;quot; /&amp;gt;
  &amp;lt;/bean&amp;gt;
&amp;lt;/beans&amp;gt;

创建测试类
package top.fjy8018.activiti.sample.config;

/**
 * @author ：F嘉阳
 * @date ：2019/8/8 15:54
 */
@Slf4j
public class DefaultConfigTest {
    @Test
    public void defalutConfig(){
        ProcessEngineConfiguration configuration = ProcessEngineConfiguration
                .createProcessEngineConfigurationFromResourceDefault();
        log.info(&amp;quot;config = {}&amp;quot;,configuration);
    }
}


输出为
16:10:46.965 [main] DEBUG org.springframework.core.env.StandardEnvironment - Adding PropertySource &#39;systemProperties&#39; with lowest search precedence
16:10:46.969 [main] DEBUG org.springframework.core.env.StandardEnvironment - Adding PropertySource &#39;systemEnvironment&#39; with lowest search precedence
16:10:46.970 [main] DEBUG org.springframework.core.env.StandardEnvironment - Initialized StandardEnvironment with PropertySources [MapPropertySource@85777802 {name=&#39;systemProperties&#39;, properties={java.runtime.name=Java(TM) SE Runtime Environment, sun.boot.library.path=...
16:10:46.975 [main] INFO org.springframework.beans.factory.xml.XmlBeanDefinitionReader - Loading XML bean definitions from class path resource [activiti.cfg.xml]
16:10:46.993 [main] DEBUG org.springframework.beans.factory.xml.DefaultDocumentLoader - Using JAXP provider [com.sun.org.apache.xerces.internal.jaxp.DocumentBuilderFactoryImpl]
16:10:47.039 [main] DEBUG org.springframework.beans.factory.xml.PluggableSchemaResolver - Loading schema mappings from [META-INF/spring.schemas]
16:10:47.042 [main] DEBUG org.springframework.beans.factory.xml.PluggableSchemaResolver - Loaded schema mappings: ...
16:10:47.043 [main] DEBUG org.springframework.beans.factory.xml.PluggableSchemaResolver - Found XML schema [http://www.springframework.org/schema/beans/spring-beans.xsd] in classpath: org/springframework/beans/factory/xml/spring-beans.xsd
16:10:47.087 [main] DEBUG org.springframework.beans.factory.xml.DefaultBeanDefinitionDocumentReader - Loading bean definitions
16:10:47.101 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Creating shared instance of singleton bean &#39;processEngineConfiguration&#39;
16:10:47.101 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Creating instance of bean &#39;processEngineConfiguration&#39;
16:10:47.377 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Eagerly caching bean &#39;processEngineConfiguration&#39; to allow for resolving potential circular references
16:10:47.572 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Finished creating instance of bean &#39;processEngineConfiguration&#39;
16:10:47.573 [main] INFO top.fjy8018.activiti.sample.config.DefaultConfigTest - config = org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration@3bd82cf5

创建独立引擎对象
增加单元测试
package top.fjy8018.activiti.sample.config;

/**
 * @author ：F嘉阳
 * @date ：2019/8/8 15:54
 */
@Slf4j
public class DefaultConfigTest {
    @Test
    public void standaloneConfig() {
        ProcessEngineConfiguration configuration = ProcessEngineConfiguration
                .createStandaloneProcessEngineConfiguration();
        log.info(&amp;quot;config = {}&amp;quot;, configuration);
    }
}

输出结果
16:10:13.328 [main] INFO top.fjy8018.activiti.sample.config.DefaultConfigTest - config = org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration@70a9f84e

结果分析
两种方式均创建了StandaloneProcessEngineConfiguration对象，但默认配置是通过解析Spring Bean配置文件创建，而手动创建不需要解析Spring Bean配置
创建过程ProcessEngineConfiguration源码分析
package org.activiti.engine;

public abstract class ProcessEngineConfiguration {

	// 默认配置
	public static ProcessEngineConfiguration createProcessEngineConfigurationFromResourceDefault() {
	  return createProcessEngineConfigurationFromResource(&amp;quot;activiti.cfg.xml&amp;quot;, &amp;quot;processEngineConfiguration&amp;quot;);
	}
	// 读取资源
	public static ProcessEngineConfiguration createProcessEngineConfigurationFromResource(String resource, String beanName) {
	  return BeansConfigurationHelper.parseProcessEngineConfigurationFromResource(resource, beanName);
	}
}

资源解析BeansConfigurationHelper
package org.activiti.engine.impl.cfg;

public class BeansConfigurationHelper {

	// 解析Spring配置
	public static ProcessEngineConfiguration parseProcessEngineConfigurationFromResource(String resource, String beanName) {
	  Resource springResource = new ClassPathResource(resource);
	  return parseProcessEngineConfiguration(springResource, beanName);
	}

	public static ProcessEngineConfiguration parseProcessEngineConfiguration(Resource springResource, String beanName) {
	  DefaultListableBeanFactory beanFactory = new DefaultListableBeanFactory();
	  XmlBeanDefinitionReader xmlBeanDefinitionReader = new XmlBeanDefinitionReader(beanFactory);
	  xmlBeanDefinitionReader.setValidationMode(XmlBeanDefinitionReader.VALIDATION_XSD);
	  xmlBeanDefinitionReader.loadBeanDefinitions(springResource);
	  ProcessEngineConfigurationImpl processEngineConfiguration = (ProcessEngineConfigurationImpl) beanFactory.getBean(beanName);
	  processEngineConfiguration.setBeans(new SpringBeanFactoryProxyMap(beanFactory));
	  return processEngineConfiguration;
	}
}

而指定创建独立流程引擎对象则是直接返回一个对象
package org.activiti.engine;

public abstract class ProcessEngineConfiguration {

	public static ProcessEngineConfiguration createStandaloneInMemProcessEngineConfiguration() {
      // 直接创建对象并返回
	  return new StandaloneInMemProcessEngineConfiguration();
	}
}

配置引擎源码分析
顶级抽象配置类ProcessEngineConfiguration
ProcessEngineConfiguration内也指定了大量规约配置，例如默认数据库为H2等
但其默认使用的是Mybatis提供的连接池，生产上不推荐使用
package org.activiti.engine;

public abstract class ProcessEngineConfiguration {

	/**
	 * 默认不对数据库做修改
	 */
	public static final String DB_SCHEMA_UPDATE_FALSE = &amp;quot;false&amp;quot;;
	public static final String DB_SCHEMA_UPDATE_CREATE_DROP = &amp;quot;create-drop&amp;quot;;

	/**
	 * 自动对表结构进行更新
	 */
	public static final String DB_SCHEMA_UPDATE_TRUE = &amp;quot;true&amp;quot;;

	public static final String NO_TENANT_ID = &amp;quot;&amp;quot;;

	protected String processEngineName = ProcessEngines.NAME_DEFAULT;
	protected int idBlockSize = 2500;
	protected String history = HistoryLevel.AUDIT.getKey();
	protected boolean asyncExecutorActivate;

	protected String mailServerHost = &amp;quot;localhost&amp;quot;;
	protected String mailServerUsername; // 默认继承了邮件配置
	protected String mailServerPassword;
	protected int mailServerPort = 25;
	protected boolean useSSL;
	protected boolean useTLS;
	protected String mailServerDefaultFrom = &amp;quot;activiti@localhost&amp;quot;;
	protected String mailSessionJndi;
	protected Map&amp;lt;String, MailServerInfo&amp;gt; mailServers = new HashMap&amp;lt;String, MailServerInfo&amp;gt;();
	protected Map&amp;lt;String, String&amp;gt; mailSessionsJndi = new HashMap&amp;lt;String, String&amp;gt;();

	protected String databaseType;
	protected String databaseSchemaUpdate = DB_SCHEMA_UPDATE_FALSE;
	protected String jdbcDriver = &amp;quot;org.h2.Driver&amp;quot;;
	protected String jdbcUrl = &amp;quot;jdbc:h2:tcp://localhost/~/activiti&amp;quot;;
	protected String jdbcUsername = &amp;quot;sa&amp;quot;;
	protected String jdbcPassword = &amp;quot;&amp;quot;;
    protected String xmlEncoding = &amp;quot;UTF-8&amp;quot;;

	protected String defaultCamelContext = &amp;quot;camelContext&amp;quot;;

	protected String activityFontName = &amp;quot;Arial&amp;quot;;
	protected String labelFontName = &amp;quot;Arial&amp;quot;;
	protected String annotationFontName = &amp;quot;Arial&amp;quot;;
}

其创建流程引擎方法作为抽象供子类实现

默认实现抽象类ProcessEngineConfigurationImpl
ProcessEngineConfigurationImpl默认实现如下，执行大量初始化流程
public abstract class ProcessEngineConfigurationImpl extends ProcessEngineConfiguration {
	
	@Override
	public ProcessEngine buildProcessEngine() {
	  init();
	  ProcessEngineImpl processEngine = new ProcessEngineImpl(this);

	  // trigger build of Activiti 5 Engine
	  if (isActiviti5CompatibilityEnabled &amp;amp;&amp;amp; activiti5CompatibilityHandler != null) {
	    Context.setProcessEngineConfiguration(processEngine.getProcessEngineConfiguration());
	    activiti5CompatibilityHandler.getRawProcessEngine();
	  }

	  postProcessEngineInitialisation();

	  return processEngine;
	}
	
	public void init() {
	    initConfigurators();
	    configuratorsBeforeInit();
	    ...
}

独立引擎配置类StandaloneProcessEngineConfiguration
StandaloneProcessEngineConfiguration实现较为简单，只返回空拦截器
package org.activiti.engine.impl.cfg;

public class StandaloneProcessEngineConfiguration extends ProcessEngineConfigurationImpl {
  // 返回空拦截器
  @Override
  public CommandInterceptor createTransactionInterceptor() {
    return null;
  }
}

内存引擎配置类StandaloneInMemProcessEngineConfiguration
其子类实现了内存数据库拦截器
package org.activiti.engine.impl.cfg;

public class StandaloneInMemProcessEngineConfiguration extends StandaloneProcessEngineConfiguration {

  public StandaloneInMemProcessEngineConfiguration() {
    this.databaseSchemaUpdate = DB_SCHEMA_UPDATE_CREATE_DROP;
    this.jdbcUrl = &amp;quot;jdbc:h2:mem:activiti&amp;quot;;
  }
}

Spring集成配置类SpringProcessEngineConfiguration
实现事务、数据源、自动部署等配置，多用于生产环境
package org.activiti.spring;

public class SpringProcessEngineConfiguration extends ProcessEngineConfigurationImpl implements ApplicationContextAware {
	// 事务定义
	protected PlatformTransactionManager transactionManager;
	// 配置自动部署文件夹
	protected String deploymentName = &amp;quot;SpringAutoDeployment&amp;quot;;
	protected Resource[] deploymentResources = new Resource[0];
	protected String deploymentMode = &amp;quot;default&amp;quot;;
	protected ApplicationContext applicationContext;
	protected Integer transactionSynchronizationAdapterOrder = null;
	private Collection&amp;lt;AutoDeploymentStrategy&amp;gt; deploymentStrategies = new ArrayList&amp;lt;AutoDeploymentStrategy&amp;gt;();

	public SpringProcessEngineConfiguration() {
	  this.transactionsExternallyManaged = true;
	  deploymentStrategies.add(new DefaultAutoDeploymentStrategy());
	  deploymentStrategies.add(new SingleResourceAutoDeploymentStrategy());
	  deploymentStrategies.add(new ResourceParentFolderAutoDeploymentStrategy());
	}

	@Override
	public void initTransactionContextFactory() {
	  if (transactionContextFactory == null &amp;amp;&amp;amp; transactionManager != null) {
	    transactionContextFactory = new SpringTransactionContextFactory(transactionManager, transactionSynchronizationAdapterOrder);
	  }
	}

	// JPA 初始化
	@Override
	public void initJpa() {
	  super.initJpa();
	  if (jpaEntityManagerFactory != null) {
	    sessionFactories.put(EntityManagerSession.class, new SpringEntityManagerSessionFactory(jpaEntityManagerFactory, jpaHandleTransaction, jpaCloseEntityManager));
	  }
	}

	// 自动资源部署
	protected void autoDeployResources(ProcessEngine processEngine) {
	  if (deploymentResources != null &amp;amp;&amp;amp; deploymentResources.length &amp;gt; 0) {
	    final AutoDeploymentStrategy strategy = getAutoDeploymentStrategy(deploymentMode);
	    strategy.deployResources(deploymentName, deploymentResources, processEngine.getRepositoryService());
	  }
	}

	// 数据源配置
	@Override
	public ProcessEngineConfiguration setDataSource(DataSource dataSource) {
	  if (dataSource instanceof TransactionAwareDataSourceProxy) {
	    return super.setDataSource(dataSource);
	  } else {
	    // Wrap datasource in Transaction-aware proxy
	    DataSource proxiedDataSource = new TransactionAwareDataSourceProxy(dataSource);
	    return super.setDataSource(proxiedDataSource);
	  }
	}
	
	public PlatformTransactionManager getTransactionManager() {
	  return transactionManager;
	}

	public void setTransactionManager(PlatformTransactionManager transactionManager) {
	  this.transactionManager = transactionManager;
	}
}

数据库引擎配置
可选配置

缺省配置默认，使用H2内存数据库
配置JDBC属性，使用mybatis提供的连接池
配置DataSource，可自选第三方实现

Druid 为监控而生的数据库连接池来自阿里
Dbcp老牌数据源连接池，稳定可靠，Tomcat自带
HikariCP来自日本的的极速数据源连接池，Spring默选






基本配置
连接池配置





jdbcUrl
jdbcMaxActiveConnections
最大活跃连接数


jdbcUsername
jdbcMaxldleConnections
最大空闲连接


jdbcPassword
jdbcMaxCheckoutTime
最大检查时间


jdbcDriver
jdbcMaxWaitTime
最长等待时间



用法和线程池相同，一般就设置最大连接数和最小连接数相同，减少连接创建和销毁的开销
6.0数据库支持列表
官方文档支持列表如下



数据库
JDBC 连接URL样例




h2
jdbc:h2:tcp://localhost/activiti


mysql
jdbc:mysql://localhost:3306/activiti?autoReconnect=true


oracle
jdbc:oracle:thin:@localhost:1521:xe


postgres
jdbc:postgresql://localhost:5432/activiti


db2
jdbc:db2://localhost:50000/activiti


mssql
jdbc:sqlserver://localhost:1433;databaseName=activiti(jdbc.driver=com.microsoft.sqlserver.jdbc.SQLServerDriver) OR jdbc:jtds:sqlserver://localhost:1433/activiti (jdbc.driver=net.sourceforge.jtds.jdbc.Driver)



数据库更新策略
原因：Activiti 版本更新后表结构可能发生变化
策略：

false: 启动时检查数据库版本,发生不匹配抛异常（生产环境对数据库无DDL权限时使用）
true:  启动时自动检查并更新数据库表,不存在会创建
create-drop：启动时创建数据库表结构，结束时删除表结构（测试时使用）

默认内存引擎配置
package top.fjy8018.activiti.sample.config;

/**
 * @author ：F嘉阳
 * @date ：2019/8/9 8:28
 */
@Slf4j
public class DBConfigTest {

    @Test
    public void inMemProcessEngineConfig() {
        ProcessEngineConfiguration configuration = ProcessEngineConfiguration
                .createProcessEngineConfigurationFromResourceDefault();
        log.info(&amp;quot;config = {}&amp;quot;, configuration);
        ProcessEngine processEngine = configuration.buildProcessEngine();
        log.info(&amp;quot;流程引擎 {}&amp;quot;,processEngine.getName());
        processEngine.close();
    }
}

输出结果
...
08:36:28.790 [main] INFO top.fjy8018.activiti.sample.config.DBConfigTest - config = org.activiti.engine.impl.cfg.StandaloneInMemProcessEngineConfiguration@158d2680
...
08:36:30.089 [main] INFO org.activiti.engine.impl.db.DbSqlSession - performing create on engine with resource org/activiti/db/create/activiti.h2.create.engine.sql
08:36:30.187 [main] INFO org.activiti.engine.impl.db.DbSqlSession - performing create on history with resource org/activiti/db/create/activiti.h2.create.history.sql
08:36:30.217 [main] INFO org.activiti.engine.impl.db.DbSqlSession - performing create on identity with resource org/activiti/db/create/activiti.h2.create.identity.sql
08:36:30.317 [main] INFO org.activiti.engine.impl.db.DbSqlSession - performing drop on engine with resource org/activiti/db/drop/activiti.h2.drop.engine.sql

...
08:36:30.316 [main] INFO top.fjy8018.activiti.sample.config.DBConfigTest - 流程引擎 default
...

由此看出使用内存引擎会自动调用创建数据库脚本语句，并在执行完毕后删除对应的脚本
StandaloneInMemProcessEngineConfiguration内存数据库引擎源码
从内存引擎的实现源码可看到相应的配置
package org.activiti.engine.impl.cfg;

public class StandaloneInMemProcessEngineConfiguration extends StandaloneProcessEngineConfiguration {

	public StandaloneInMemProcessEngineConfiguration() {
      // 创建后销毁策略
	  this.databaseSchemaUpdate = DB_SCHEMA_UPDATE_CREATE_DROP;
	  this.jdbcUrl = &amp;quot;jdbc:h2:mem:activiti&amp;quot;;
	}
}

配置MySQL数据库
pom文件中加入驱动依赖
&amp;lt;dependency&amp;gt;
    &amp;lt;groupId&amp;gt;mysql&amp;lt;/groupId&amp;gt;
    &amp;lt;artifactId&amp;gt;mysql-connector-java&amp;lt;/artifactId&amp;gt;
    &amp;lt;version&amp;gt;8.0.16&amp;lt;/version&amp;gt;
    &amp;lt;scope&amp;gt;runtime&amp;lt;/scope&amp;gt;
&amp;lt;/dependency&amp;gt;

修改bean配置文件activiti.cfg.xml
&amp;lt;?xml version=&amp;quot;1.0&amp;quot; encoding=&amp;quot;UTF-8&amp;quot;?&amp;gt;

&amp;lt;beans xmlns=&amp;quot;http://www.springframework.org/schema/beans&amp;quot;
       xmlns:xsi=&amp;quot;http://www.w3.org/2001/XMLSchema-instance&amp;quot;
       xsi:schemaLocation=&amp;quot;http://www.springframework.org/schema/beans   http://www.springframework.org/schema/beans/spring-beans.xsd&amp;quot;&amp;gt;

    &amp;lt;bean id=&amp;quot;processEngineConfiguration&amp;quot;
          class=&amp;quot;org.activiti.engine.impl.cfg.StandaloneInMemProcessEngineConfiguration&amp;quot;&amp;gt;
        &amp;lt;property name=&amp;quot;jdbcUrl&amp;quot; value=&amp;quot;jdbc:mysql://db:3306/activiti?useSSL=false&amp;amp;amp;useUnicode=true&amp;amp;amp;characterEncoding=UTF-8&amp;amp;amp;serverTimezone=Asia/Shanghai&amp;quot; /&amp;gt;
        &amp;lt;property name=&amp;quot;jdbcDriver&amp;quot; value=&amp;quot;com.mysql.cj.jdbc.Driver&amp;quot; /&amp;gt;
        &amp;lt;property name=&amp;quot;jdbcUsername&amp;quot; value=&amp;quot;dbactiviti&amp;quot; /&amp;gt;
        &amp;lt;property name=&amp;quot;jdbcPassword&amp;quot; value=&amp;quot;pwactiviti&amp;quot; /&amp;gt;
    &amp;lt;/bean&amp;gt;
&amp;lt;/beans&amp;gt;

执行数据库、用户创建和授权
DROP DATABASE IF EXISTS activiti;
CREATE DATABASE activiti
  DEFAULT CHARACTER SET utf8mb4
  COLLATE utf8mb4_general_ci;

GRANT ALL ON activiti.* TO dbactiviti@&#39;%&#39;
    IDENTIFIED BY &#39;pwactiviti&#39;;
FLUSH PRIVILEGES;

日志输出，同样会自动执行创建和销毁动作
09:50:42.506 [main] DEBUG org.activiti.engine.impl.cfg.ProcessEngineConfigurationImpl - database product name: &#39;MySQL&#39;
09:50:42.506 [main] DEBUG org.activiti.engine.impl.cfg.ProcessEngineConfigurationImpl - using database type: mysql
...
09:50:41.981 [main] INFO top.fjy8018.activiti.sample.config.DBConfigTest - config = org.activiti.engine.impl.cfg.StandaloneInMemProcessEngineConfiguration@5e5d171f
...
09:50:43.730 [main] INFO org.activiti.engine.impl.db.DbSqlSession - Found MySQL: majorVersion=5 minorVersion=7
09:50:43.730 [main] INFO org.activiti.engine.impl.db.DbSqlSession - performing create on engine with resource org/activiti/db/create/activiti.mysql.create.engine.sql
09:50:48.255 [main] INFO org.activiti.engine.impl.db.DbSqlSession - performing create on history with resource org/activiti/db/create/activiti.mysql.create.history.sql
09:50:49.315 [main] INFO org.activiti.engine.impl.db.DbSqlSession - performing create on identity with resource org/activiti/db/create/activiti.mysql.create.identity.sql
...
09:50:49.856 [main] INFO top.fjy8018.activiti.sample.config.DBConfigTest - 流程引擎 default
...
09:50:49.858 [main] INFO org.activiti.engine.impl.db.DbSqlSession - performing drop on engine with resource org/activiti/db/drop/activiti.mysql.drop.engine.sql
09:50:51.728 [main] INFO org.activiti.engine.impl.db.DbSqlSession - performing drop on history with resource org/activiti/db/drop/activiti.mysql.drop.history.sql

为了防止可能出现的维护问题，建议手动指明数据库策略
&amp;lt;bean id=&amp;quot;processEngineConfiguration&amp;quot;
      class=&amp;quot;org.activiti.engine.impl.cfg.StandaloneInMemProcessEngineConfiguration&amp;quot;&amp;gt;
    &amp;lt;property name=&amp;quot;jdbcUrl&amp;quot;
              value=&amp;quot;jdbc:mysql://120.79.226.26:3306/activiti?useSSL=false&amp;amp;amp;useUnicode=true&amp;amp;amp;characterEncoding=UTF-8&amp;amp;amp;serverTimezone=Asia/Shanghai&amp;quot;/&amp;gt;
    &amp;lt;property name=&amp;quot;jdbcDriver&amp;quot; value=&amp;quot;com.mysql.cj.jdbc.Driver&amp;quot;/&amp;gt;
    &amp;lt;property name=&amp;quot;jdbcUsername&amp;quot; value=&amp;quot;dbactiviti&amp;quot;/&amp;gt;
    &amp;lt;property name=&amp;quot;jdbcPassword&amp;quot; value=&amp;quot;pwactiviti&amp;quot;/&amp;gt;
    &amp;lt;!-- 数据库策略 --&amp;gt;
    &amp;lt;property name=&amp;quot;databaseSchemaUpdate&amp;quot; value=&amp;quot;create-drop&amp;quot;/&amp;gt;
&amp;lt;/bean&amp;gt;

配置Druid连接池
加入Druid依赖
&amp;lt;!-- https://mvnrepository.com/artifact/com.alibaba/druid --&amp;gt;
&amp;lt;dependency&amp;gt;
    &amp;lt;groupId&amp;gt;com.alibaba&amp;lt;/groupId&amp;gt;
    &amp;lt;artifactId&amp;gt;druid&amp;lt;/artifactId&amp;gt;
    &amp;lt;version&amp;gt;1.1.19&amp;lt;/version&amp;gt;
&amp;lt;/dependency&amp;gt;

增加bean配置文件activiti_druid.cfg.xml
&amp;lt;?xml version=&amp;quot;1.0&amp;quot; encoding=&amp;quot;UTF-8&amp;quot;?&amp;gt;

&amp;lt;beans xmlns=&amp;quot;http://www.springframework.org/schema/beans&amp;quot;
       xmlns:xsi=&amp;quot;http://www.w3.org/2001/XMLSchema-instance&amp;quot;
       xsi:schemaLocation=&amp;quot;http://www.springframework.org/schema/beans   http://www.springframework.org/schema/beans/spring-beans.xsd&amp;quot;&amp;gt;

    &amp;lt;bean id=&amp;quot;processEngineConfiguration&amp;quot;
          class=&amp;quot;org.activiti.engine.impl.cfg.StandaloneInMemProcessEngineConfiguration&amp;quot;&amp;gt;
        &amp;lt;!--数据源--&amp;gt;
        &amp;lt;property name=&amp;quot;dataSource&amp;quot; ref=&amp;quot;dataSource&amp;quot; /&amp;gt;
        &amp;lt;!-- 数据库策略 --&amp;gt;
        &amp;lt;property name=&amp;quot;databaseSchemaUpdate&amp;quot; value=&amp;quot;create-drop&amp;quot;/&amp;gt;
    &amp;lt;/bean&amp;gt;

    &amp;lt;bean id=&amp;quot;dataSource&amp;quot; class=&amp;quot;com.alibaba.druid.pool.DruidDataSource&amp;quot; &amp;gt;
        &amp;lt;property name=&amp;quot;driverClassName&amp;quot; value=&amp;quot;com.mysql.cj.jdbc.Driver&amp;quot; /&amp;gt;
        &amp;lt;property name=&amp;quot;url&amp;quot; value=&amp;quot;jdbc:mysql://120.79.226.26:3306/activiti?useSSL=false&amp;amp;amp;useUnicode=true&amp;amp;amp;characterEncoding=UTF-8&amp;amp;amp;serverTimezone=Asia/Shanghai&amp;quot; /&amp;gt;
        &amp;lt;property name=&amp;quot;username&amp;quot; value=&amp;quot;dbactiviti&amp;quot; /&amp;gt;
        &amp;lt;property name=&amp;quot;password&amp;quot; value=&amp;quot;pwactiviti&amp;quot; /&amp;gt;
        &amp;lt;property name=&amp;quot;defaultAutoCommit&amp;quot; value=&amp;quot;false&amp;quot; /&amp;gt;
        &amp;lt;property name=&amp;quot;initialSize&amp;quot; value=&amp;quot;1&amp;quot;/&amp;gt;
        &amp;lt;property name=&amp;quot;maxActive&amp;quot; value=&amp;quot;10&amp;quot;/&amp;gt;
        &amp;lt;!--监控、日志过滤器--&amp;gt;
        &amp;lt;property name=&amp;quot;filters&amp;quot; value=&amp;quot;stat,slf4j&amp;quot; /&amp;gt;
    &amp;lt;/bean&amp;gt;
&amp;lt;/beans&amp;gt;

创建测试类，加载druid配置文件
/**
 * druid数据库引擎测试
 */
@Test
public void druidProcessEngineConfig() {
    ProcessEngineConfiguration configuration = ProcessEngineConfiguration
            .createProcessEngineConfigurationFromResource(&amp;quot;activiti_druid.cfg.xml&amp;quot;);
    log.info(&amp;quot;config = {}&amp;quot;, configuration);
    ProcessEngine processEngine = configuration.buildProcessEngine();
    log.info(&amp;quot;流程引擎 {}&amp;quot;, processEngine.getName());
    processEngine.close();
}

输出结果
2019-08-09 02:26:58  INFO [main]  at top.fjy8018.activiti.sample.config.DBConfigTest.druidProcessEngineConfig(DBConfigTest.java:35) - config = org.activiti.engine.impl.cfg.StandaloneInMemProcessEngineConfiguration@65c7a252
2019-08-09 02:26:58  INFO [main]  at com.alibaba.druid.pool.DruidDataSource.init(DruidDataSource.java:1003) - {dataSource-1} inited
2019-08-09 02:26:59  INFO [main]  at org.activiti.engine.impl.db.DbSqlSession.executeSchemaResource(DbSqlSession.java:1147) - performing create on engine with resource org/activiti/db/create/activiti.mysql.create.engine.sql
2019-08-09 02:26:59  INFO [main]  at org.activiti.engine.impl.db.DbSqlSession.executeSchemaResource(DbSqlSession.java:1162) - Found MySQL: majorVersion=5 minorVersion=7
2019-08-09 02:27:05  INFO [main]  at org.activiti.engine.impl.db.DbSqlSession.executeSchemaResource(DbSqlSession.java:1147) - performing create on history with resource org/activiti/db/create/activiti.mysql.create.history.sql
2019-08-09 02:27:06  INFO [main]  at org.activiti.engine.impl.db.DbSqlSession.executeSchemaResource(DbSqlSession.java:1147) - performing create on identity with resource org/activiti/db/create/activiti.mysql.create.identity.sql
2019-08-09 02:27:06  INFO [main]  at top.fjy8018.activiti.sample.config.DBConfigTest.druidProcessEngineConfig(DBConfigTest.java:37) - 流程引擎 default
2019-08-09 02:27:06  INFO [main]  at org.activiti.engine.impl.db.DbSqlSession.executeSchemaResource(DbSqlSession.java:1147) - performing drop on engine with resource org/activiti/db/drop/activiti.mysql.drop.engine.sql
2019-08-09 02:27:08  INFO [main]  at org.activiti.engine.impl.db.DbSqlSession.executeSchemaResource(DbSqlSession.java:1147) - performing drop on history with resource org/activiti/db/drop/activiti.mysql.drop.history.sql
2019-08-09 02:27:09  INFO [main]  at org.activiti.engine.impl.db.DbSqlSession.executeSchemaResource(DbSqlSession.java:1147) - performing drop on identity with resource org/activiti/db/drop/activiti.mysql.drop.identity.sql

配置HikariCP连接池
加入HikariCP依赖
&amp;lt;!-- https://mvnrepository.com/artifact/com.zaxxer/HikariCP --&amp;gt;
&amp;lt;dependency&amp;gt;
    &amp;lt;groupId&amp;gt;com.zaxxer&amp;lt;/groupId&amp;gt;
    &amp;lt;artifactId&amp;gt;HikariCP&amp;lt;/artifactId&amp;gt;
    &amp;lt;version&amp;gt;3.3.1&amp;lt;/version&amp;gt;
&amp;lt;/dependency&amp;gt;

增加bean配置文件activiti_HikariCP.cfg.xml
&amp;lt;?xml version=&amp;quot;1.0&amp;quot; encoding=&amp;quot;UTF-8&amp;quot;?&amp;gt;

&amp;lt;beans xmlns=&amp;quot;http://www.springframework.org/schema/beans&amp;quot;
       xmlns:xsi=&amp;quot;http://www.w3.org/2001/XMLSchema-instance&amp;quot;
       xsi:schemaLocation=&amp;quot;http://www.springframework.org/schema/beans   http://www.springframework.org/schema/beans/spring-beans.xsd&amp;quot;&amp;gt;

    &amp;lt;bean id=&amp;quot;processEngineConfiguration&amp;quot;
          class=&amp;quot;org.activiti.engine.impl.cfg.StandaloneInMemProcessEngineConfiguration&amp;quot;&amp;gt;
        &amp;lt;!--数据源--&amp;gt;
        &amp;lt;property name=&amp;quot;dataSource&amp;quot; ref=&amp;quot;dataSource&amp;quot;/&amp;gt;
        &amp;lt;!-- 数据库策略 --&amp;gt;
        &amp;lt;property name=&amp;quot;databaseSchemaUpdate&amp;quot; value=&amp;quot;create-drop&amp;quot;/&amp;gt;
    &amp;lt;/bean&amp;gt;

    &amp;lt;bean id=&amp;quot;dataSource&amp;quot; class=&amp;quot;com.zaxxer.hikari.HikariDataSource&amp;quot;&amp;gt;
        &amp;lt;property name=&amp;quot;driverClassName&amp;quot; value=&amp;quot;com.mysql.cj.jdbc.Driver&amp;quot;/&amp;gt;
        &amp;lt;property name=&amp;quot;jdbcUrl&amp;quot;
                  value=&amp;quot;jdbc:mysql://120.79.226.26:3306/activiti?useSSL=false&amp;amp;amp;useUnicode=true&amp;amp;amp;characterEncoding=UTF-8&amp;amp;amp;serverTimezone=Asia/Shanghai&amp;quot;/&amp;gt;
        &amp;lt;property name=&amp;quot;username&amp;quot; value=&amp;quot;dbactiviti&amp;quot;/&amp;gt;
        &amp;lt;property name=&amp;quot;password&amp;quot; value=&amp;quot;pwactiviti&amp;quot;/&amp;gt;
        &amp;lt;property name=&amp;quot;maximumPoolSize&amp;quot; value=&amp;quot;20&amp;quot;/&amp;gt;
    &amp;lt;/bean&amp;gt;
&amp;lt;/beans&amp;gt;

只需要在装载时切换读取的配置文件即可
/**
 * HikariCP数据库引擎测试
 */
@Test
public void hikariProcessEngineConfig() {
    ProcessEngineConfiguration configuration = ProcessEngineConfiguration
            .createProcessEngineConfigurationFromResource(&amp;quot;activiti_HikariCP.cfg.xml&amp;quot;);
    log.info(&amp;quot;config = {}&amp;quot;, configuration);
    ProcessEngine processEngine = configuration.buildProcessEngine();
    log.info(&amp;quot;流程引擎 {}&amp;quot;, processEngine.getName());
    processEngine.close();
}

日志输出显示连接池切换成功
2019-08-09 02:38:57  INFO [main]  at com.zaxxer.hikari.HikariDataSource.getConnection(HikariDataSource.java:110) - HikariPool-1 - Starting...
2019-08-09 02:38:58  INFO [main]  at com.zaxxer.hikari.HikariDataSource.getConnection(HikariDataSource.java:123) - HikariPool-1 - Start completed.

初始化数据源连接池源码分析
初始化工作在ProcessEngineConfigurationImpl中实现
package org.activiti.engine.impl.cfg;

public abstract class ProcessEngineConfigurationImpl extends ProcessEngineConfiguration {

    public void init() {
        initConfigurators();
        ...
        if (usingRelationalDatabase) {
            // 初始化数据源
            initDataSource();
        }

        initAgendaFactory();
        ...
    }

    // 初始化数据源
    public void initDataSource() {
        // 配置数据源为空则使用Jndi数据源
        if (dataSource == null) {
            if (dataSourceJndiName != null) {
                try {
                    dataSource = (DataSource) new InitialContext().lookup(dataSourceJndiName);
                } catch (Exception e) {
                    throw new ActivitiException(&amp;quot;couldn&#39;t lookup datasource from &amp;quot; + dataSourceJndiName + &amp;quot;: &amp;quot; + e.getMessage(), e);
                }
            } else if (jdbcUrl != null) {
                // 读取数据源配置信息
                if ((jdbcDriver == null) || (jdbcUsername == null)) {
                    throw new ActivitiException(&amp;quot;DataSource or JDBC properties have to be specified in a process engine configuration&amp;quot;);
                }
                log.debug(&amp;quot;initializing datasource to db: {}&amp;quot;, jdbcUrl);
                // 默认使用mybatis连接池 org.apache.ibatis.datasource.pooled.PooledDataSource
                PooledDataSource pooledDataSource = new PooledDataSource(ReflectUtil.getClassLoader(), jdbcDriver, jdbcUrl, jdbcUsername, jdbcPassword);
                if (jdbcMaxActiveConnections &amp;gt; 0) {
                    pooledDataSource.setPoolMaximumActiveConnections(jdbcMaxActiveConnections);
                }
                if (jdbcMaxIdleConnections &amp;gt; 0) {
                    pooledDataSource.setPoolMaximumIdleConnections(jdbcMaxIdleConnections);
                }
                if (jdbcMaxCheckoutTime &amp;gt; 0) {
                    pooledDataSource.setPoolMaximumCheckoutTime(jdbcMaxCheckoutTime);
                }
                if (jdbcMaxWaitTime &amp;gt; 0) {
                    pooledDataSource.setPoolTimeToWait(jdbcMaxWaitTime);
                }
                if (jdbcPingEnabled == true) {
                    pooledDataSource.setPoolPingEnabled(true);
                    if (jdbcPingQuery != null) {
                        pooledDataSource.setPoolPingQuery(jdbcPingQuery);
                    }
                    pooledDataSource.setPoolPingConnectionsNotUsedFor(jdbcPingConnectionNotUsedFor);
                }
                if (jdbcDefaultTransactionIsolationLevel &amp;gt; 0) {
                    pooledDataSource.setDefaultTransactionIsolationLevel(jdbcDefaultTransactionIsolationLevel);
                }
                dataSource = pooledDataSource;
            }
            // 如果外部配置的数据源为mybatis数据源则强制关闭
            if (dataSource instanceof PooledDataSource) {
                ((PooledDataSource) dataSource).forceCloseAll();
            }
        }
        if (databaseType == null) {
            // 初始化数据库类型
            initDatabaseType();
        }
    }

    // 初始化数据库类型
    public void initDatabaseType() {
        Connection connection = null;
        try {
            connection = dataSource.getConnection();
            // 获取元信息
            DatabaseMetaData databaseMetaData = connection.getMetaData();
            // 查询元信息映射关系
            String databaseProductName = databaseMetaData.getDatabaseProductName();
            log.debug(&amp;quot;database product name: &#39;{}&#39;&amp;quot;, databaseProductName);
            databaseType = databaseTypeMappings.getProperty(databaseProductName);
            // 查询为空则不支持该数据库
            if (databaseType == null) {
                throw new ActivitiException(&amp;quot;couldn&#39;t deduct database type from database product name &#39;&amp;quot; + databaseProductName + &amp;quot;&#39;&amp;quot;);
            }
            log.debug(&amp;quot;using database type: {}&amp;quot;, databaseType);
            if (DATABASE_TYPE_MSSQL.equals(databaseType)) {
                maxNrOfStatementsInBulkInsert = DEFAULT_MAX_NR_OF_STATEMENTS_BULK_INSERT_SQL_SERVER;
            }

        } catch (SQLException e) {
            log.error(&amp;quot;Exception while initializing Database connection&amp;quot;, e);
        } finally {
            try {
                if (connection != null) {
                    connection.close();
                }
            } catch (SQLException e) {
                log.error(&amp;quot;Exception while closing the Database connection&amp;quot;, e);
            }
        }
    }

    // 数据库元信息映射关系
    protected static Properties databaseTypeMappings = getDefaultDatabaseTypeMappings();

    public static final String DATABASE_TYPE_H2 = &amp;quot;h2&amp;quot;;
    public static final String DATABASE_TYPE_HSQL = &amp;quot;hsql&amp;quot;;
    public static final String DATABASE_TYPE_MYSQL = &amp;quot;mysql&amp;quot;;
    public static final String DATABASE_TYPE_ORACLE = &amp;quot;oracle&amp;quot;;
    public static final String DATABASE_TYPE_POSTGRES = &amp;quot;postgres&amp;quot;;
    public static final String DATABASE_TYPE_MSSQL = &amp;quot;mssql&amp;quot;;
    public static final String DATABASE_TYPE_DB2 = &amp;quot;db2&amp;quot;;

    public static Properties getDefaultDatabaseTypeMappings() {
        Properties databaseTypeMappings = new Properties();
        databaseTypeMappings.setProperty(&amp;quot;H2&amp;quot;, DATABASE_TYPE_H2);
        databaseTypeMappings.setProperty(&amp;quot;HSQL Database Engine&amp;quot;, DATABASE_TYPE_HSQL);
        databaseTypeMappings.setProperty(&amp;quot;MySQL&amp;quot;, DATABASE_TYPE_MYSQL);
        databaseTypeMappings.setProperty(&amp;quot;Oracle&amp;quot;, DATABASE_TYPE_ORACLE);
        databaseTypeMappings.setProperty(&amp;quot;PostgreSQL&amp;quot;, DATABASE_TYPE_POSTGRES);
		...
        return databaseTypeMappings;
    }
}

其余常用配置项
数据库策略，建议为true，自动更新数据库表结构，由于MySQL 5.6.4之前Timestamp不支持毫秒精度，故官方建议使用 5.6.4+ 的版本
&amp;lt;property name=&amp;quot;databaseSchemaUpdate&amp;quot; value=&amp;quot;true&amp;quot;/&amp;gt;


Note for MySQL users: MySQL version lower than 5.6.4 has no support for timestamps or dates with millisecond precision. To make things even worse, some version will throw an exception when trying to create such a column but other versions don’t. When doing auto-creation/upgrade, the engine will change the DDL when executing it. When using the DDL file approach, both a regular version and a special file with mysql55 in it are available (this applies on anything lower than 5.6.4). This latter file will have column types with no millisecond precision in it.
Concretely, the following applies for MySQL version

&amp;lt;5.6: No millisecond precision available. DDL files available (look for files containing mysql55). Auto creation/update will work out of the box.
5.6.0 - 5.6.3: No millisecond precision available. Auto creation/update will NOT work. It is advised to upgrade to a newer database version anyway. DDL files for mysql 5.5 could be used if really needed.
5.6.4+: Millisecond precision available. DDL files available (default file containing mysql). Auto creation/update works out of the box.

Do note that in the case of upgrading the MySQL database later on and the Activiti tables are already created/upgraded, the column type change will have to be done manually!

是否使用历史数据，若为false则不保存流程历史数据
&amp;lt;property name=&amp;quot;dbHistoryUsed&amp;quot; value=&amp;quot;true&amp;quot; /&amp;gt;

是否使用身份验证，即用户组、用户校验等，若有外部验证则可配置为false
&amp;lt;property name=&amp;quot;dbIdentityUsed&amp;quot; value=&amp;quot;true&amp;quot;/&amp;gt;

支持自定义前缀
&amp;lt;property name=&amp;quot;databaseTablePrefix&amp;quot; value=&amp;quot;t_&amp;quot;/&amp;gt;

支持手动指定数据库类型，不建议配置，源码表示其会自动识别数据库类型
&amp;lt;property name=&amp;quot;databaseType&amp;quot; value=&amp;quot;mysql&amp;quot;/&amp;gt;

日志和数据记录配置
日志组件的关系及MDC
日志组件的关系

MDC
即流程上下文信息存储在线程变量ThreadLocal中
配置开启MDC(Mapped Diagnostic Contexts)

默认没有开启，需要手动设置LogMDC.setMDCEnable(true)
配置logback.xml 日志模板%X{mdcProcessInstanceID}
流程只有在执行过程出现异常时才会记录MDC信息

配置历史记录级别(HistoryLevel)
配置HistoryLevel

none: 不记录历史流程，性能高，流程结束后不可读取
activiti: 归档流程实例和活动实例，流程变量不同步
audit: 默认值，在activiti基础上同步变量值，保存表单属性
full: 性能较差，记录所有实例和变量细节变化

配置基于db的事件日志(Event logging)
配置Event Logging

实验性的事件记录机制，性能影响较大
开启默认记录所有数据的变化过程，表记录快速增长
日志内容json格式，建议存入mongoDB、Elastic Search

默认日志配置实例
通过脚手架创建的工程会自带一个单元测试

@Deployment表示在测试前去Activiti中部署资源文件，该默认测试实现装载资源文件并启动流程引擎，仅需要加入执行流程语句即可
public class MyUnitTest {

	@Rule
	public ActivitiRule activitiRule = new ActivitiRule();

	@Test
	@Deployment(resources = {&amp;quot;top/fjy8018/my-process.bpmn20.xml&amp;quot;})
	public void test() {
		ProcessInstance processInstance = activitiRule.getRuntimeService().startProcessInstanceByKey(&amp;quot;my-process&amp;quot;);
		assertNotNull(processInstance);

		Task task = activitiRule.getTaskService().createTaskQuery().singleResult();
		assertEquals(&amp;quot;Activiti is awesome!&amp;quot;, task.getName());
	}
}

默认流程配置文件my-process.bpmn20.xml内容为
&amp;lt;?xml version=&amp;quot;1.0&amp;quot; encoding=&amp;quot;UTF-8&amp;quot;?&amp;gt;

&amp;lt;definitions xmlns=&amp;quot;http://www.omg.org/spec/BPMN/20100524/MODEL&amp;quot;
             typeLanguage=&amp;quot;http://www.w3.org/2001/XMLSchema&amp;quot;
             expressionLanguage=&amp;quot;http://www.w3.org/1999/XPath&amp;quot; targetNamespace=&amp;quot;http://www.activiti.org/test&amp;quot;&amp;gt;

    &amp;lt;process id=&amp;quot;my-process&amp;quot;&amp;gt;

        &amp;lt;startEvent id=&amp;quot;start&amp;quot;/&amp;gt;
        &amp;lt;sequenceFlow id=&amp;quot;flow1&amp;quot; sourceRef=&amp;quot;start&amp;quot; targetRef=&amp;quot;someTask&amp;quot;/&amp;gt;

        &amp;lt;userTask id=&amp;quot;someTask&amp;quot; name=&amp;quot;Activiti is awesome!&amp;quot;/&amp;gt;
        &amp;lt;sequenceFlow id=&amp;quot;flow2&amp;quot; sourceRef=&amp;quot;someTask&amp;quot; targetRef=&amp;quot;end&amp;quot;/&amp;gt;

        &amp;lt;endEvent id=&amp;quot;end&amp;quot;/&amp;gt;

    &amp;lt;/process&amp;gt;

&amp;lt;/definitions&amp;gt;

即一个开始一个结束一个处理的简单流程图

默认用例执行结果，从日志可知默认过程为加载xml配置并初始化数据库再销毁关闭引擎
09:56:15,843 [main] INFO  org.springframework.beans.factory.xml.XmlBeanDefinitionReader  - Loading XML bean definitions from class path resource [activiti.cfg.xml]
09:56:17,628 [main] INFO  org.activiti.engine.compatibility.DefaultActiviti5CompatibilityHandlerFactory  - Activiti 5 compatibility handler implementation not found or error during instantiation : org.activiti.compatibility.DefaultActiviti5CompatibilityHandler. Activiti 5 backwards compatibility disabled.
09:56:17,644 [main] INFO  org.activiti.engine.impl.db.DbSqlSession  - performing create on engine with resource org/activiti/db/create/activiti.h2.create.engine.sql
09:56:17,702 [main] INFO  org.activiti.engine.impl.db.DbSqlSession  - performing create on history with resource org/activiti/db/create/activiti.h2.create.history.sql
09:56:17,708 [main] INFO  org.activiti.engine.impl.db.DbSqlSession  - performing create on identity with resource org/activiti/db/create/activiti.h2.create.identity.sql
09:56:17,712 [main] INFO  org.activiti.engine.impl.ProcessEngineImpl  - ProcessEngine default created

MDC日志配置实例
按照官方指南配置MDC日志输出格式
&amp;lt;?xml version=&amp;quot;1.0&amp;quot; encoding=&amp;quot;UTF-8&amp;quot; ?&amp;gt;

&amp;lt;configuration debug=&amp;quot;false&amp;quot; scan=&amp;quot;true&amp;quot; scanPeriod=&amp;quot;30 seconds&amp;quot;&amp;gt;
    &amp;lt;property name=&amp;quot;log.dir&amp;quot; value=&amp;quot;target/logs&amp;quot;/&amp;gt;
    &amp;lt;property name=&amp;quot;encoding&amp;quot; value=&amp;quot;UTF-8&amp;quot;/&amp;gt;
    &amp;lt;property name=&amp;quot;plain&amp;quot; value=&amp;quot;%msg%n&amp;quot;/&amp;gt;
    &amp;lt;property name=&amp;quot;std&amp;quot; value=&amp;quot;%d{HH:mm:ss.SSS}[%thread][%-5level]%msg %X{}&amp;quot;/&amp;gt;
    &amp;lt;!--&amp;lt;property name=&amp;quot;normal&amp;quot; value=&amp;quot;%d{yyy-MM-dd:HH:mm:ss.SSS}[%thread][%-5level]&amp;quot;/&amp;gt;--&amp;gt;
    &amp;lt;property name=&amp;quot;mdc&amp;quot; value=&amp;quot;ProcessDefinitionId=%X{mdcProcessDefinitionID}
executionId=%X{mdcExecutionId} mdcProcessInstanceID=%X{mdcProcessInstanceID} mdcBusinessKey=%X{mdcBusinessKey} %m%n&amp;quot;/&amp;gt;
    &amp;lt;!-- 控制台输出 --&amp;gt;   
    &amp;lt;appender name=&amp;quot;STDOUT&amp;quot; class=&amp;quot;ch.qos.logback.core.ConsoleAppender&amp;quot;&amp;gt;
        &amp;lt;!-- 日志输出编码 --&amp;gt;  
        &amp;lt;Encoding&amp;gt;UTF-8&amp;lt;/Encoding&amp;gt;   
        &amp;lt;encoder&amp;gt;
            &amp;lt;!--&amp;lt;pattern&amp;gt;${plain}&amp;lt;/pattern&amp;gt;--&amp;gt;
            &amp;lt;pattern&amp;gt;${mdc}&amp;lt;/pattern&amp;gt;
            &amp;lt;charset&amp;gt;${encoding}&amp;lt;/charset&amp;gt;
        &amp;lt;/encoder&amp;gt;
    &amp;lt;/appender&amp;gt;
    &amp;lt;!-- 日志输出级别 --&amp;gt;
    &amp;lt;root level=&amp;quot;INFO&amp;quot;&amp;gt;  
        &amp;lt;appender-ref ref=&amp;quot;STDOUT&amp;quot;/&amp;gt;
        &amp;lt;appender-ref ref=&amp;quot;FILE&amp;quot;/&amp;gt;
    &amp;lt;/root&amp;gt;

&amp;lt;/configuration&amp;gt;

使用MDC之后会在日志中看到以下信息

流程定义Id 被记录为 mdcProcessDefinitionID
流程实例Id 被记录为mdcProcessInstanceID
流程执行Id 被记录为mdcExecutionId
流程序列Id 被记录为mdcBusinessKey

注意：MDC日志只有在发生异常时才会被记录
创建异常模拟类
package top.fjy8018.activiti.sample.config.delegate;

/**
 * 模拟MDC错误
 *
 * @author F嘉阳
 * @date 2019-08-10 10:23
 */
@Slf4j
public class MDCErrorDelegate implements JavaDelegate {
    @Override
    public void execute(DelegateExecution delegateExecution) {
        log.info(&amp;quot;执行 MDCErrorDelegate&amp;quot;);
        throw new RuntimeException(&amp;quot;模拟MDC异常&amp;quot;);
    }
}

配置流程图
&amp;lt;?xml version=&amp;quot;1.0&amp;quot; encoding=&amp;quot;UTF-8&amp;quot;?&amp;gt;

&amp;lt;definitions xmlns=&amp;quot;http://www.omg.org/spec/BPMN/20100524/MODEL&amp;quot; xmlns:xsi=&amp;quot;http://www.w3.org/2001/XMLSchema-instance&amp;quot;
             xmlns:activiti=&amp;quot;http://activiti.org/bpmn&amp;quot; xmlns:bpmndi=&amp;quot;http://www.omg.org/spec/BPMN/20100524/DI&amp;quot;
             xmlns:omgdc=&amp;quot;http://www.omg.org/spec/DD/20100524/DC&amp;quot; xmlns:omgdi=&amp;quot;http://www.omg.org/spec/DD/20100524/DI&amp;quot;
             typeLanguage=&amp;quot;http://www.w3.org/2001/XMLSchema&amp;quot; expressionLanguage=&amp;quot;http://www.w3.org/1999/XPath&amp;quot;
             targetNamespace=&amp;quot;http://www.activiti.org/test&amp;quot;&amp;gt;

    &amp;lt;process id=&amp;quot;my-process&amp;quot;&amp;gt;

        &amp;lt;startEvent id=&amp;quot;start&amp;quot;/&amp;gt;
        &amp;lt;sequenceFlow id=&amp;quot;flow1&amp;quot; sourceRef=&amp;quot;start&amp;quot; targetRef=&amp;quot;someTask&amp;quot;/&amp;gt;

&amp;lt;!--        &amp;lt;userTask id=&amp;quot;someTask&amp;quot; name=&amp;quot;Activiti is awesome!&amp;quot;/&amp;gt;--&amp;gt;
        &amp;lt;serviceTask id=&amp;quot;someTask&amp;quot;  activiti:class=&amp;quot;top.fjy8018.activiti.sample.config.delegate.MDCErrorDelegate&amp;quot; /&amp;gt;
        &amp;lt;sequenceFlow id=&amp;quot;flow2&amp;quot; sourceRef=&amp;quot;someTask&amp;quot; targetRef=&amp;quot;end&amp;quot;/&amp;gt;
        &amp;lt;endEvent id=&amp;quot;end&amp;quot;/&amp;gt;

    &amp;lt;/process&amp;gt;
&amp;lt;/definitions&amp;gt;

注意：脚手架默认提供的xml标签声明无法解析BPMN2.0语法，需要增加标签声明才能正确解析
日志输出结果
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= Loading XML bean definitions from class path resource [activiti.cfg.xml]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= Activiti 5 compatibility handler implementation not found or error during instantiation : org.activiti.compatibility.DefaultActiviti5CompatibilityHandler. Activiti 5 backwards compatibility disabled.
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= performing create on engine with resource org/activiti/db/create/activiti.h2.create.engine.sql
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= performing create on history with resource org/activiti/db/create/activiti.h2.create.history.sql
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= performing create on identity with resource org/activiti/db/create/activiti.h2.create.identity.sql
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= ProcessEngine default created
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 执行 MDCErrorDelegate
ProcessDefinitionId=my-process:1:3 executionId=5 mdcProcessInstanceID=4 mdcBusinessKey= Error while closing command context
java.lang.RuntimeException: 模拟MDC异常
	at top.fjy8018.activiti.sample.config.delegate.MDCErrorDelegate.execute(MDCErrorDelegate.java:19)
	...

通过拦截器配置MDC输出
为了实现不修改流程配置文件的情况下实现全局MDC日志输出，可通过内置拦截器实现
配置拦截器
package top.fjy8018.activiti.sample.config.interceptor;

/**
 * MDC 日志输出拦截器实现
 * 参考 {@link DebugCommandInvoker} 实现
 *
 * @author F嘉阳
 * @date 2019-08-10 10:46
 */
@Slf4j
public class MDCCommandInvoker extends DebugCommandInvoker {
    @Override
    public void executeOperation(Runnable runnable) {
        boolean mdcEnabled = LogMDC.isMDCEnabled();
        // 启用MDC
        LogMDC.setMDCEnabled(true);
        // 判断是否是流程对象
        if (runnable instanceof AbstractOperation) {
            AbstractOperation operation = (AbstractOperation) runnable;
            if (operation.getExecution() != null) {
                // 放入MDC上下文中
                LogMDC.putMDCExecution(operation.getExecution());
            }
        }
        super.executeOperation(runnable);
        // 清理MDC上下文
        LogMDC.clear();
        // 重置原始配置
        if (!mdcEnabled){
            LogMDC.setMDCEnabled(false);
        }
    }
}

使用默认流程配置文件my-process.bpmn20.xml
&amp;lt;?xml version=&amp;quot;1.0&amp;quot; encoding=&amp;quot;UTF-8&amp;quot;?&amp;gt;
&amp;lt;definitions xmlns=&amp;quot;http://www.omg.org/spec/BPMN/20100524/MODEL&amp;quot;
             typeLanguage=&amp;quot;http://www.w3.org/2001/XMLSchema&amp;quot; expressionLanguage=&amp;quot;http://www.w3.org/1999/XPath&amp;quot;
             targetNamespace=&amp;quot;http://www.activiti.org/test&amp;quot;&amp;gt;
    &amp;lt;process id=&amp;quot;my-process&amp;quot;&amp;gt;
        &amp;lt;startEvent id=&amp;quot;start&amp;quot;/&amp;gt;
        &amp;lt;sequenceFlow id=&amp;quot;flow1&amp;quot; sourceRef=&amp;quot;start&amp;quot; targetRef=&amp;quot;someTask&amp;quot;/&amp;gt;
        &amp;lt;userTask id=&amp;quot;someTask&amp;quot; name=&amp;quot;Activiti is awesome!&amp;quot;/&amp;gt;
        &amp;lt;sequenceFlow id=&amp;quot;flow2&amp;quot; sourceRef=&amp;quot;someTask&amp;quot; targetRef=&amp;quot;end&amp;quot;/&amp;gt;
        &amp;lt;endEvent id=&amp;quot;end&amp;quot;/&amp;gt;
    &amp;lt;/process&amp;gt;
&amp;lt;/definitions&amp;gt;

注册拦截器activiti_mdc.cfg.xml
&amp;lt;?xml version=&amp;quot;1.0&amp;quot; encoding=&amp;quot;UTF-8&amp;quot;?&amp;gt;

&amp;lt;beans xmlns=&amp;quot;http://www.springframework.org/schema/beans&amp;quot;
       xmlns:xsi=&amp;quot;http://www.w3.org/2001/XMLSchema-instance&amp;quot;
       xsi:schemaLocation=&amp;quot;http://www.springframework.org/schema/beans   http://www.springframework.org/schema/beans/spring-beans.xsd&amp;quot;&amp;gt;

    &amp;lt;bean id=&amp;quot;processEngineConfiguration&amp;quot;
          class=&amp;quot;org.activiti.engine.impl.cfg.StandaloneInMemProcessEngineConfiguration&amp;quot;&amp;gt;
        &amp;lt;property name=&amp;quot;commandInvoker&amp;quot; ref=&amp;quot;commandInvoker&amp;quot;/&amp;gt;
    &amp;lt;/bean&amp;gt;

    &amp;lt;bean id=&amp;quot;commandInvoker&amp;quot; class=&amp;quot;top.fjy8018.activiti.sample.config.interceptor.MDCCommandInvoker&amp;quot;/&amp;gt;
&amp;lt;/beans&amp;gt;

编写单元测试
@Slf4j
public class MDCCommandInvokerConfigTest {

    @Rule
    public ActivitiRule activitiRule = new ActivitiRule(&amp;quot;activiti_mdc.cfg.xml&amp;quot;);

    @Test
    @Deployment(resources = {&amp;quot;top/fjy8018.activiti.sample.config/my-process.bpmn20.xml&amp;quot;})
    public void testMDCError() {
        ProcessInstance processInstance = activitiRule.getRuntimeService().startProcessInstanceByKey(&amp;quot;my-process&amp;quot;);
        assertNotNull(processInstance);
        Task task = activitiRule.getTaskService().createTaskQuery().singleResult();
        assertEquals(&amp;quot;Activiti is awesome!&amp;quot;, task.getName());
    }
}

执行结果
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= ProcessEngine default created
ProcessDefinitionId=my-process:1:3 executionId=5 mdcProcessInstanceID=4 mdcBusinessKey= Execution tree while executing operation class org.activiti.engine.impl.agenda.ContinueProcessOperation :
ProcessDefinitionId=my-process:1:3 executionId=5 mdcProcessInstanceID=4 mdcBusinessKey= 
4 (process instance)
└── 5 : start (StartEvent, parent id 4 (active)

ProcessDefinitionId=my-process:1:3 executionId=5 mdcProcessInstanceID=4 mdcBusinessKey= Execution tree while executing operation class org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation :
ProcessDefinitionId=my-process:1:3 executionId=5 mdcProcessInstanceID=4 mdcBusinessKey= 
4 (process instance)
└── 5 : start (StartEvent, parent id 4 (active)
...

输出为树形结构，是因为在DebugCommandInvoker源码中通过树形构建输出结果
package org.activiti.engine.impl.interceptor;

public class DebugCommandInvoker extends CommandInvoker {
  
  private static final Logger logger = LoggerFactory.getLogger(DebugCommandInvoker.class);
  
  @Override
  public void executeOperation(Runnable runnable) {
    if (runnable instanceof AbstractOperation) {
      AbstractOperation operation = (AbstractOperation) runnable;
      
      if (operation.getExecution() != null) {
        logger.info(&amp;quot;Execution tree while executing operation {} :&amp;quot;, operation.getClass());
        // 通过树形方式构建
        logger.info(&amp;quot;{}&amp;quot;, System.lineSeparator() +  ExecutionTreeUtil.buildExecutionTree(operation.getExecution()));
      }
    } 
    super.executeOperation(runnable);
  }
}

历史记录配置实例
历史记录有多个级别，本次模拟流程和对应的输出级别如下


启动流程


修改变量


提交表单 task—— none级别


输出历史内容


输出历史活动—— activiti级别


输出历史详情 ——full级别（audit级别会缺失部分字段）


输出历史表单—— audit级别


单元测试类
@Slf4j
public class MDCHistoryLevelConfigTest {

    @Rule
    public ActivitiRule activitiRule = new ActivitiRule(&amp;quot;activiti_history.cfg.xml&amp;quot;);

    @Test
    @Deployment(resources = {&amp;quot;top/fjy8018.activiti.sample.config/my-process.bpmn20.xml&amp;quot;})
    public void testHistoryLevel1() {

        // 启动流程
        Map&amp;lt;String, Object&amp;gt; params = Maps.newHashMap();
        params.put(&amp;quot;keyStart1&amp;quot;, &amp;quot;value1&amp;quot;);
        params.put(&amp;quot;keyStart2&amp;quot;, &amp;quot;value2&amp;quot;);
        // 传入参数
        ProcessInstance processInstance = activitiRule.getRuntimeService().startProcessInstanceByKey(&amp;quot;my-process&amp;quot;, params);

        // 修改变量
        // 分页查询流程执行对象
        List&amp;lt;Execution&amp;gt; executions = activitiRule.getRuntimeService().createExecutionQuery().listPage(0, 100);
        executions.forEach(e -&amp;gt; log.info(&amp;quot;Execution = {}&amp;quot;, e));
        log.info(&amp;quot;Execution 大小 = {}&amp;quot;, executions.size());
        // 通过执行对象查找执行变量
        // 取出第一条记录
        String excutionId = executions.iterator().next().getId();
        activitiRule.getRuntimeService().setVariable(excutionId, &amp;quot;keyStart1&amp;quot;, &amp;quot;updateKey1&amp;quot;);

        // 通过表单提交结束流程
        Task task = activitiRule.getTaskService().createTaskQuery().singleResult();
        Map&amp;lt;String, String&amp;gt; formData = Maps.newHashMap();
        formData.put(&amp;quot;formKey1&amp;quot;, &amp;quot;formValue1&amp;quot;);
        formData.put(&amp;quot;formKey2&amp;quot;, &amp;quot;formValue2&amp;quot;);
        // 提交表单 task 自动结束流程
        activitiRule.getFormService().submitTaskFormData(task.getId(), formData);

        // 输出历史内容
        // 输出历史活动
        printHistoricActivityInstance();

        // 输出历史变量
        printHistoricVariableInstance();

        // 输出历史表单详情
        printHistoricFormDetail();

        // 输出所有历史详情
        printHistoricDetail();

        // 输出历史表单
        printHistoricTaskInstance();
    }

    private void printHistoricTaskInstance() {
        List&amp;lt;HistoricTaskInstance&amp;gt; historicTaskInstances = activitiRule.getHistoryService()
                .createHistoricTaskInstanceQuery()
                .listPage(0, 100);
        historicTaskInstances.forEach(h -&amp;gt; log.info(&amp;quot;历史Task数量 = {}&amp;quot;,h));
        log.info(&amp;quot;历史Task数量={}&amp;quot;,historicTaskInstances.size());
    }

    private void printHistoricDetail() {
        List&amp;lt;HistoricDetail&amp;gt; historicDetails = activitiRule.getHistoryService()
                .createHistoricDetailQuery()
                .listPage(0, 100);
        historicDetails.forEach(h -&amp;gt; log.info(&amp;quot;历史详情 = {}&amp;quot;,historicDetailtoString(h)));
        log.info(&amp;quot;历史详情数量={}&amp;quot;,historicDetails.size());
    }

    private void printHistoricFormDetail() {
        List&amp;lt;HistoricDetail&amp;gt; historicFormDetails = activitiRule.getHistoryService()
                .createHistoricDetailQuery()
                .formProperties()
                .listPage(0, 100);
        historicFormDetails.forEach(h -&amp;gt; log.info(&amp;quot;历史表单 = {}&amp;quot;,h));
        log.info(&amp;quot;历史表单数量={}&amp;quot;,historicFormDetails.size());
    }

    private void printHistoricVariableInstance() {
        List&amp;lt;HistoricVariableInstance&amp;gt; variableInstances = activitiRule.getHistoryService()
                .createHistoricVariableInstanceQuery()
                .listPage(0, 100);
        variableInstances.forEach(v -&amp;gt; log.info(&amp;quot;历史变量 = {}&amp;quot;,v));
        log.info(&amp;quot;历史变量数量={}&amp;quot;,variableInstances.size());
    }

    private void printHistoricActivityInstance() {
        List&amp;lt;HistoricActivityInstance&amp;gt; historicActivityInstances = activitiRule.getHistoryService()
                .createHistoricActivityInstanceQuery()
                .listPage(0, 100);
        historicActivityInstances.forEach(h -&amp;gt; log.info(&amp;quot;历史活动={}&amp;quot;,h));
        log.info(&amp;quot;历史活动数量={}&amp;quot;,historicActivityInstances.size());
    }

    private static String historicDetailtoString(HistoricDetail historicDetail){
        return ToStringBuilder.reflectionToString(historicDetail, ToStringStyle.SHORT_PREFIX_STYLE);
    }
}

其他配置按照默认即可
默认历史记录级别activiti输出
...
ProcessDefinitionId=my-process:1:3 executionId=7 mdcProcessInstanceID=4 mdcBusinessKey= 
4 (process instance)
└── 7 : end (EndEvent, parent id 4 (active)

ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史活动=HistoricActivityInstanceEntity[id=15, activityId=end, activityName=null]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史活动=HistoricActivityInstanceEntity[id=8, activityId=start, activityName=null]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史活动=HistoricActivityInstanceEntity[id=9, activityId=someTask, activityName=Activiti is awesome!]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史活动数量=3
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量 = HistoricVariableInstanceEntity[id=13, name=formKey2, revision=0, type=string, textValue=formValue2]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量 = HistoricVariableInstanceEntity[id=14, name=formKey1, revision=0, type=string, textValue=formValue1]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量 = HistoricVariableInstanceEntity[id=5, name=keyStart2, revision=0, type=string, textValue=value2]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量 = HistoricVariableInstanceEntity[id=6, name=keyStart1, revision=1, type=string, textValue=updateKey1]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量数量=4
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史表单 = org.activiti.engine.impl.persistence.entity.HistoricFormPropertyEntityImpl@320e400
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史表单 = org.activiti.engine.impl.persistence.entity.HistoricFormPropertyEntityImpl@5167268
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史表单数量=2
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情 = HistoricFormPropertyEntityImpl[propertyId=formKey2,propertyValue=formValue2,processInstanceId=4,activityInstanceId=9,taskId=10,executionId=7,time=Sat Aug 10 16:30:13 CST 2019,detailType=FormProperty,id=11,isInserted=false,isUpdated=false,isDeleted=false]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情 = HistoricFormPropertyEntityImpl[propertyId=formKey1,propertyValue=formValue1,processInstanceId=4,activityInstanceId=9,taskId=10,executionId=7,time=Sat Aug 10 16:30:13 CST 2019,detailType=FormProperty,id=12,isInserted=false,isUpdated=false,isDeleted=false]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情数量=2
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史Task数量 = org.activiti.engine.impl.persistence.entity.HistoricTaskInstanceEntityImpl@3153ddfc
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史Task数量=1

通过流程配置文件修改日志级别
&amp;lt;?xml version=&amp;quot;1.0&amp;quot; encoding=&amp;quot;UTF-8&amp;quot;?&amp;gt;

&amp;lt;beans xmlns=&amp;quot;http://www.springframework.org/schema/beans&amp;quot;
       xmlns:xsi=&amp;quot;http://www.w3.org/2001/XMLSchema-instance&amp;quot;
       xsi:schemaLocation=&amp;quot;http://www.springframework.org/schema/beans   http://www.springframework.org/schema/beans/spring-beans.xsd&amp;quot;&amp;gt;

    &amp;lt;bean id=&amp;quot;processEngineConfiguration&amp;quot;
          class=&amp;quot;org.activiti.engine.impl.cfg.StandaloneInMemProcessEngineConfiguration&amp;quot;&amp;gt;
        &amp;lt;property name=&amp;quot;commandInvoker&amp;quot; ref=&amp;quot;commandInvoker&amp;quot;/&amp;gt;
        &amp;lt;!--历史记录级别--&amp;gt;
        &amp;lt;property name=&amp;quot;history&amp;quot; value=&amp;quot;none&amp;quot;/&amp;gt;
    &amp;lt;/bean&amp;gt;

    &amp;lt;bean id=&amp;quot;commandInvoker&amp;quot; class=&amp;quot;top.fjy8018.activiti.sample.config.interceptor.MDCCommandInvoker&amp;quot;/&amp;gt;
&amp;lt;/beans&amp;gt;

none历史记录级别输出
...
ProcessDefinitionId=my-process:1:3 executionId=7 mdcProcessInstanceID=4 mdcBusinessKey= 
4 (process instance)
└── 7 : end (EndEvent, parent id 4 (active)

ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史活动数量=0
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量数量=0
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史表单数量=0
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情数量=0
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史Task数量=0

audit历史记录级别输出
...
ProcessDefinitionId=my-process:1:3 executionId=7 mdcProcessInstanceID=4 mdcBusinessKey= 
4 (process instance)
└── 7 : end (EndEvent, parent id 4 (active)

ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史活动=HistoricActivityInstanceEntity[id=15, activityId=end, activityName=null]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史活动=HistoricActivityInstanceEntity[id=8, activityId=start, activityName=null]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史活动=HistoricActivityInstanceEntity[id=9, activityId=someTask, activityName=Activiti is awesome!]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史活动数量=3
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量 = HistoricVariableInstanceEntity[id=13, name=formKey2, revision=0, type=string, textValue=formValue2]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量 = HistoricVariableInstanceEntity[id=14, name=formKey1, revision=0, type=string, textValue=formValue1]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量 = HistoricVariableInstanceEntity[id=5, name=keyStart2, revision=0, type=string, textValue=value2]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量 = HistoricVariableInstanceEntity[id=6, name=keyStart1, revision=1, type=string, textValue=updateKey1]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量数量=4
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史表单 = org.activiti.engine.impl.persistence.entity.HistoricFormPropertyEntityImpl@6d1310f6
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史表单 = org.activiti.engine.impl.persistence.entity.HistoricFormPropertyEntityImpl@3228d990
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史表单数量=2
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情 = HistoricFormPropertyEntityImpl[propertyId=formKey2,propertyValue=formValue2,processInstanceId=4,activityInstanceId=9,taskId=10,executionId=7,time=Sat Aug 10 16:33:28 CST 2019,detailType=FormProperty,id=11,isInserted=false,isUpdated=false,isDeleted=false]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情 = HistoricFormPropertyEntityImpl[propertyId=formKey1,propertyValue=formValue1,processInstanceId=4,activityInstanceId=9,taskId=10,executionId=7,time=Sat Aug 10 16:33:28 CST 2019,detailType=FormProperty,id=12,isInserted=false,isUpdated=false,isDeleted=false]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情数量=2
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史Task数量 = org.activiti.engine.impl.persistence.entity.HistoricTaskInstanceEntityImpl@3c321bdb
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史Task数量=1

full历史记录级别输出
full级别历史记录详情更加丰富
...
ProcessDefinitionId=my-process:1:3 executionId=9 mdcProcessInstanceID=4 mdcBusinessKey= 
4 (process instance)
└── 9 : end (EndEvent, parent id 4 (active)

ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史活动=HistoricActivityInstanceEntity[id=10, activityId=start, activityName=null]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史活动=HistoricActivityInstanceEntity[id=11, activityId=someTask, activityName=Activiti is awesome!]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史活动=HistoricActivityInstanceEntity[id=20, activityId=end, activityName=null]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史活动数量=3
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量 = HistoricVariableInstanceEntity[id=16, name=formKey2, revision=0, type=string, textValue=formValue2]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量 = HistoricVariableInstanceEntity[id=18, name=formKey1, revision=0, type=string, textValue=formValue1]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量 = HistoricVariableInstanceEntity[id=5, name=keyStart2, revision=0, type=string, textValue=value2]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量 = HistoricVariableInstanceEntity[id=7, name=keyStart1, revision=1, type=string, textValue=updateKey1]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史变量数量=4
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史表单 = org.activiti.engine.impl.persistence.entity.HistoricFormPropertyEntityImpl@6d1310f6
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史表单 = org.activiti.engine.impl.persistence.entity.HistoricFormPropertyEntityImpl@3228d990
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史表单数量=2
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情 = HistoricDetailVariableInstanceUpdateEntityImpl[revision=1,name=keyStart1,variableType=org.activiti.engine.impl.variable.StringType@24855019,longValue=&amp;lt;null&amp;gt;,doubleValue=&amp;lt;null&amp;gt;,textValue=updateKey1,textValue2=&amp;lt;null&amp;gt;,byteArrayRef=ByteArrayRef[id=null, name=null, entity=null],cachedValue=&amp;lt;null&amp;gt;,processInstanceId=4,activityInstanceId=&amp;lt;null&amp;gt;,taskId=&amp;lt;null&amp;gt;,executionId=4,time=Sat Aug 10 16:33:57 CST 2019,detailType=VariableUpdate,id=13,isInserted=false,isUpdated=false,isDeleted=false]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情 = HistoricFormPropertyEntityImpl[propertyId=formKey2,propertyValue=formValue2,processInstanceId=4,activityInstanceId=11,taskId=12,executionId=9,time=Sat Aug 10 16:33:57 CST 2019,detailType=FormProperty,id=14,isInserted=false,isUpdated=false,isDeleted=false]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情 = HistoricFormPropertyEntityImpl[propertyId=formKey1,propertyValue=formValue1,processInstanceId=4,activityInstanceId=11,taskId=12,executionId=9,time=Sat Aug 10 16:33:57 CST 2019,detailType=FormProperty,id=15,isInserted=false,isUpdated=false,isDeleted=false]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情 = HistoricDetailVariableInstanceUpdateEntityImpl[revision=0,name=formKey2,variableType=org.activiti.engine.impl.variable.StringType@24855019,longValue=&amp;lt;null&amp;gt;,doubleValue=&amp;lt;null&amp;gt;,textValue=formValue2,textValue2=&amp;lt;null&amp;gt;,byteArrayRef=ByteArrayRef[id=null, name=null, entity=null],cachedValue=&amp;lt;null&amp;gt;,processInstanceId=4,activityInstanceId=11,taskId=&amp;lt;null&amp;gt;,executionId=4,time=Sat Aug 10 16:33:57 CST 2019,detailType=VariableUpdate,id=17,isInserted=false,isUpdated=false,isDeleted=false]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情 = HistoricDetailVariableInstanceUpdateEntityImpl[revision=0,name=formKey1,variableType=org.activiti.engine.impl.variable.StringType@24855019,longValue=&amp;lt;null&amp;gt;,doubleValue=&amp;lt;null&amp;gt;,textValue=formValue1,textValue2=&amp;lt;null&amp;gt;,byteArrayRef=ByteArrayRef[id=null, name=null, entity=null],cachedValue=&amp;lt;null&amp;gt;,processInstanceId=4,activityInstanceId=11,taskId=&amp;lt;null&amp;gt;,executionId=4,time=Sat Aug 10 16:33:57 CST 2019,detailType=VariableUpdate,id=19,isInserted=false,isUpdated=false,isDeleted=false]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情 = HistoricDetailVariableInstanceUpdateEntityImpl[revision=0,name=keyStart2,variableType=org.activiti.engine.impl.variable.StringType@24855019,longValue=&amp;lt;null&amp;gt;,doubleValue=&amp;lt;null&amp;gt;,textValue=value2,textValue2=&amp;lt;null&amp;gt;,byteArrayRef=ByteArrayRef[id=null, name=null, entity=null],cachedValue=&amp;lt;null&amp;gt;,processInstanceId=4,activityInstanceId=&amp;lt;null&amp;gt;,taskId=&amp;lt;null&amp;gt;,executionId=4,time=Sat Aug 10 16:33:56 CST 2019,detailType=VariableUpdate,id=6,isInserted=false,isUpdated=false,isDeleted=false]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情 = HistoricDetailVariableInstanceUpdateEntityImpl[revision=0,name=keyStart1,variableType=org.activiti.engine.impl.variable.StringType@24855019,longValue=&amp;lt;null&amp;gt;,doubleValue=&amp;lt;null&amp;gt;,textValue=value1,textValue2=&amp;lt;null&amp;gt;,byteArrayRef=ByteArrayRef[id=null, name=null, entity=null],cachedValue=&amp;lt;null&amp;gt;,processInstanceId=4,activityInstanceId=&amp;lt;null&amp;gt;,taskId=&amp;lt;null&amp;gt;,executionId=4,time=Sat Aug 10 16:33:56 CST 2019,detailType=VariableUpdate,id=8,isInserted=false,isUpdated=false,isDeleted=false]
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史详情数量=7
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史Task数量 = org.activiti.engine.impl.persistence.entity.HistoricTaskInstanceEntityImpl@3aaf4f07
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 历史Task数量=1

事件及监听器配置
配置开启事件日志
&amp;lt;?xml version=&amp;quot;1.0&amp;quot; encoding=&amp;quot;UTF-8&amp;quot;?&amp;gt;

&amp;lt;beans xmlns=&amp;quot;http://www.springframework.org/schema/beans&amp;quot;
       xmlns:xsi=&amp;quot;http://www.w3.org/2001/XMLSchema-instance&amp;quot;
       xsi:schemaLocation=&amp;quot;http://www.springframework.org/schema/beans   http://www.springframework.org/schema/beans/spring-beans.xsd&amp;quot;&amp;gt;

    &amp;lt;bean id=&amp;quot;processEngineConfiguration&amp;quot;
          class=&amp;quot;org.activiti.engine.impl.cfg.StandaloneInMemProcessEngineConfiguration&amp;quot;&amp;gt;
        &amp;lt;property name=&amp;quot;commandInvoker&amp;quot; ref=&amp;quot;commandInvoker&amp;quot;/&amp;gt;
        &amp;lt;!--开启事件日志--&amp;gt;
        &amp;lt;property name=&amp;quot;enableDatabaseEventLogging&amp;quot; value=&amp;quot;true&amp;quot;/&amp;gt;
    &amp;lt;/bean&amp;gt;

    &amp;lt;bean id=&amp;quot;commandInvoker&amp;quot; class=&amp;quot;top.fjy8018.activiti.sample.config.interceptor.MDCCommandInvoker&amp;quot;/&amp;gt;
&amp;lt;/beans&amp;gt;

ManagementService接口提供了两方式查询事件日志
package org.activiti.engine;

public interface ManagementService {

	List&amp;lt;EventLogEntry&amp;gt; getEventLogEntries(Long startLogNr, Long pageSize);

	List&amp;lt;EventLogEntry&amp;gt; getEventLogEntriesByProcessInstanceId(String processInstanceId);
    
}

由于EventLogEntryEntityImpl默认的toString只打印时间戳，真实数据存储在data字段中，故需要从字节数组构造字符串对象
package org.activiti.engine.impl.persistence.entity;

public class EventLogEntryEntityImpl extends AbstractEntityNoRevision implements EventLogEntryEntity {
	
	public byte[] getData() {
	  return data;
	}

	@Override
	public String toString() {
	  return timeStamp.toString() + &amp;quot; : &amp;quot; + type;
	}
}

编写单元测试输出事件日志
@Slf4j
public class EventLogConfigTest {

    @Rule
    public ActivitiRule activitiRule = new ActivitiRule(&amp;quot;activiti_event_log.cfg.xml&amp;quot;);

    @Test
    @Deployment(resources = {&amp;quot;top/fjy8018.activiti.sample.config/my-process.bpmn20.xml&amp;quot;})
    public void testMDCError() {
        ProcessInstance processInstance = activitiRule.getRuntimeService().startProcessInstanceByKey(&amp;quot;my-process&amp;quot;);
        Task task = activitiRule.getTaskService().createTaskQuery().singleResult();
        activitiRule.getTaskService().complete(task.getId());

        // 遍历事件日志
        List&amp;lt;EventLogEntry&amp;gt; logEntries = activitiRule.getManagementService()
                .getEventLogEntriesByProcessInstanceId(processInstance.getProcessInstanceId());
        logEntries.forEach(l -&amp;gt; log.info(&amp;quot;事件日志 类型 = {} 数据 = {}&amp;quot;,l.getType(),new String(l.getData())));
        log.info(&amp;quot;事件日志数量 {}&amp;quot;,logEntries.size());
    }
}

输出结果
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 事件日志 类型 = PROCESSINSTANCE_START 数据 = {&amp;quot;timeStamp&amp;quot;:1565434004723,&amp;quot;processDefinitionId&amp;quot;:&amp;quot;my-process:1:3&amp;quot;,&amp;quot;createTime&amp;quot;:1565434004723,&amp;quot;id&amp;quot;:&amp;quot;4&amp;quot;}
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 事件日志 类型 = ACTIVITY_STARTED 数据 = {&amp;quot;timeStamp&amp;quot;:1565434004728,&amp;quot;activityId&amp;quot;:&amp;quot;start&amp;quot;,&amp;quot;processDefinitionId&amp;quot;:&amp;quot;my-process:1:3&amp;quot;,&amp;quot;processInstanceId&amp;quot;:&amp;quot;4&amp;quot;,&amp;quot;executionId&amp;quot;:&amp;quot;5&amp;quot;,&amp;quot;behaviorClass&amp;quot;:&amp;quot;org.activiti.engine.impl.bpmn.behavior.NoneStartEventActivityBehavior&amp;quot;,&amp;quot;activityType&amp;quot;:&amp;quot;startEvent&amp;quot;}
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 事件日志 类型 = ACTIVITY_COMPLETED 数据 = {&amp;quot;timeStamp&amp;quot;:1565434004731,&amp;quot;activityId&amp;quot;:&amp;quot;start&amp;quot;,&amp;quot;processDefinitionId&amp;quot;:&amp;quot;my-process:1:3&amp;quot;,&amp;quot;processInstanceId&amp;quot;:&amp;quot;4&amp;quot;,&amp;quot;executionId&amp;quot;:&amp;quot;5&amp;quot;,&amp;quot;behaviorClass&amp;quot;:&amp;quot;org.activiti.engine.impl.bpmn.behavior.NoneStartEventActivityBehavior&amp;quot;,&amp;quot;activityType&amp;quot;:&amp;quot;startEvent&amp;quot;}
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 事件日志 类型 = SEQUENCEFLOW_TAKEN 数据 = {&amp;quot;targetActivityId&amp;quot;:&amp;quot;someTask&amp;quot;,&amp;quot;timeStamp&amp;quot;:1565434004734,&amp;quot;targetActivityBehaviorClass&amp;quot;:&amp;quot;org.activiti.engine.impl.bpmn.behavior.UserTaskActivityBehavior&amp;quot;,&amp;quot;sourceActivityType&amp;quot;:&amp;quot;org.activiti.bpmn.model.StartEvent&amp;quot;,&amp;quot;targetActivityName&amp;quot;:&amp;quot;Activiti is awesome!&amp;quot;,&amp;quot;id&amp;quot;:&amp;quot;flow1&amp;quot;,&amp;quot;sourceActivityBehaviorClass&amp;quot;:&amp;quot;org.activiti.engine.impl.bpmn.behavior.NoneStartEventActivityBehavior&amp;quot;,&amp;quot;targetActivityType&amp;quot;:&amp;quot;org.activiti.bpmn.model.UserTask&amp;quot;,&amp;quot;sourceActivityId&amp;quot;:&amp;quot;start&amp;quot;}
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 事件日志 类型 = ACTIVITY_STARTED 数据 = {&amp;quot;timeStamp&amp;quot;:1565434004734,&amp;quot;activityId&amp;quot;:&amp;quot;someTask&amp;quot;,&amp;quot;processDefinitionId&amp;quot;:&amp;quot;my-process:1:3&amp;quot;,&amp;quot;processInstanceId&amp;quot;:&amp;quot;4&amp;quot;,&amp;quot;executionId&amp;quot;:&amp;quot;5&amp;quot;,&amp;quot;behaviorClass&amp;quot;:&amp;quot;org.activiti.engine.impl.bpmn.behavior.UserTaskActivityBehavior&amp;quot;,&amp;quot;activityName&amp;quot;:&amp;quot;Activiti is awesome!&amp;quot;,&amp;quot;activityType&amp;quot;:&amp;quot;userTask&amp;quot;}
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 事件日志 类型 = TASK_CREATED 数据 = {&amp;quot;timeStamp&amp;quot;:1565434004752,&amp;quot;taskDefinitionKey&amp;quot;:&amp;quot;someTask&amp;quot;,&amp;quot;processDefinitionId&amp;quot;:&amp;quot;my-process:1:3&amp;quot;,&amp;quot;processInstanceId&amp;quot;:&amp;quot;4&amp;quot;,&amp;quot;executionId&amp;quot;:&amp;quot;5&amp;quot;,&amp;quot;createTime&amp;quot;:1565434004735,&amp;quot;name&amp;quot;:&amp;quot;Activiti is awesome!&amp;quot;,&amp;quot;id&amp;quot;:&amp;quot;8&amp;quot;,&amp;quot;priority&amp;quot;:50}
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 事件日志 类型 = TASK_COMPLETED 数据 = {&amp;quot;duration&amp;quot;:141,&amp;quot;timeStamp&amp;quot;:1565434004876,&amp;quot;taskDefinitionKey&amp;quot;:&amp;quot;someTask&amp;quot;,&amp;quot;processDefinitionId&amp;quot;:&amp;quot;my-process:1:3&amp;quot;,&amp;quot;processInstanceId&amp;quot;:&amp;quot;4&amp;quot;,&amp;quot;executionId&amp;quot;:&amp;quot;5&amp;quot;,&amp;quot;createTime&amp;quot;:1565434004735,&amp;quot;name&amp;quot;:&amp;quot;Activiti is awesome!&amp;quot;,&amp;quot;id&amp;quot;:&amp;quot;8&amp;quot;,&amp;quot;priority&amp;quot;:50}
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 事件日志 类型 = ACTIVITY_COMPLETED 数据 = {&amp;quot;timeStamp&amp;quot;:1565434004886,&amp;quot;activityId&amp;quot;:&amp;quot;someTask&amp;quot;,&amp;quot;processDefinitionId&amp;quot;:&amp;quot;my-process:1:3&amp;quot;,&amp;quot;processInstanceId&amp;quot;:&amp;quot;4&amp;quot;,&amp;quot;executionId&amp;quot;:&amp;quot;5&amp;quot;,&amp;quot;behaviorClass&amp;quot;:&amp;quot;org.activiti.engine.impl.bpmn.behavior.UserTaskActivityBehavior&amp;quot;,&amp;quot;activityName&amp;quot;:&amp;quot;Activiti is awesome!&amp;quot;,&amp;quot;activityType&amp;quot;:&amp;quot;userTask&amp;quot;}
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 事件日志 类型 = SEQUENCEFLOW_TAKEN 数据 = {&amp;quot;targetActivityId&amp;quot;:&amp;quot;end&amp;quot;,&amp;quot;timeStamp&amp;quot;:1565434004886,&amp;quot;sourceActivityName&amp;quot;:&amp;quot;Activiti is awesome!&amp;quot;,&amp;quot;targetActivityBehaviorClass&amp;quot;:&amp;quot;org.activiti.engine.impl.bpmn.behavior.NoneEndEventActivityBehavior&amp;quot;,&amp;quot;sourceActivityType&amp;quot;:&amp;quot;org.activiti.bpmn.model.UserTask&amp;quot;,&amp;quot;id&amp;quot;:&amp;quot;flow2&amp;quot;,&amp;quot;sourceActivityBehaviorClass&amp;quot;:&amp;quot;org.activiti.engine.impl.bpmn.behavior.UserTaskActivityBehavior&amp;quot;,&amp;quot;targetActivityType&amp;quot;:&amp;quot;org.activiti.bpmn.model.EndEvent&amp;quot;,&amp;quot;sourceActivityId&amp;quot;:&amp;quot;someTask&amp;quot;}
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 事件日志 类型 = ACTIVITY_STARTED 数据 = {&amp;quot;timeStamp&amp;quot;:1565434004886,&amp;quot;activityId&amp;quot;:&amp;quot;end&amp;quot;,&amp;quot;processDefinitionId&amp;quot;:&amp;quot;my-process:1:3&amp;quot;,&amp;quot;processInstanceId&amp;quot;:&amp;quot;4&amp;quot;,&amp;quot;executionId&amp;quot;:&amp;quot;5&amp;quot;,&amp;quot;behaviorClass&amp;quot;:&amp;quot;org.activiti.engine.impl.bpmn.behavior.NoneEndEventActivityBehavior&amp;quot;,&amp;quot;activityType&amp;quot;:&amp;quot;endEvent&amp;quot;}
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 事件日志 类型 = ACTIVITY_COMPLETED 数据 = {&amp;quot;timeStamp&amp;quot;:1565434004887,&amp;quot;activityId&amp;quot;:&amp;quot;end&amp;quot;,&amp;quot;processDefinitionId&amp;quot;:&amp;quot;my-process:1:3&amp;quot;,&amp;quot;processInstanceId&amp;quot;:&amp;quot;4&amp;quot;,&amp;quot;executionId&amp;quot;:&amp;quot;5&amp;quot;,&amp;quot;behaviorClass&amp;quot;:&amp;quot;org.activiti.engine.impl.bpmn.behavior.NoneEndEventActivityBehavior&amp;quot;,&amp;quot;activityType&amp;quot;:&amp;quot;endEvent&amp;quot;}
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 事件日志 类型 = PROCESSINSTANCE_END 数据 = {&amp;quot;timeStamp&amp;quot;:1565434004894,&amp;quot;processDefinitionId&amp;quot;:&amp;quot;my-process:1:3&amp;quot;,&amp;quot;id&amp;quot;:&amp;quot;4&amp;quot;,&amp;quot;endTime&amp;quot;:1565434004894}
ProcessDefinitionId= executionId= mdcProcessInstanceID= mdcBusinessKey= 事件日志数量 12

核心信息
事件日志 类型 = PROCESSINSTANCE_START 
事件日志 类型 = ACTIVITY_STARTED 
事件日志 类型 = ACTIVITY_COMPLETED 
事件日志 类型 = SEQUENCEFLOW_TAKEN 
事件日志 类型 = ACTIVITY_STARTED 
事件日志 类型 = TASK_CREATED 
事件日志 类型 = TASK_COMPLETED 
事件日志 类型 = ACTIVITY_COMPLETED 
事件日志 类型 = SEQUENCEFLOW_TAKEN 
事件日志 类型 = ACTIVITY_STARTED 
事件日志 类型 = ACTIVITY_COMPLETED 
事件日志 类型 = PROCESSINSTANCE_END 
事件日志数量 12

解析


PROCESSINSTANCE_START 流程开始


ACTIVITY_STARTED 节点开始——开始节点


ACTIVITY_COMPLETED 节点完成


SEQUENCEFLOW_TAKEN 数据流


ACTIVITY_STARTED节点开始——处理节点


TASK_CREATED 任务开始


TASK_COMPLETED 任务完成


ACTIVITY_COMPLETED 节点完成


SEQUENCEFLOW_TAKEN数据流


ACTIVITY_STARTED节点开始——结束节点


ACTIVITY_COMPLETED节点完成


PROCESSINSTANCE_END流程完成


源码分析
配置入口在ProcessEngineConfigurationImpl类中
package org.activiti.engine.impl.cfg;

public abstract class ProcessEngineConfigurationImpl extends ProcessEngineConfiguration {
	public void initDatabaseEventLogging() {
	  if (enableDatabaseEventLogging) {
	  	// 启用则创建事件监听器
	    getEventDispatcher().addEventListener(new EventLogger(clock, objectMapper));
	  }
	}

	public ProcessEngineConfigurationImpl setEnableDatabaseEventLogging(boolean enableDatabaseEventLogging) {
	  this.enableDatabaseEventLogging = enableDatabaseEventLogging;
	  return this;
	}
}

事件日志中定义了输出常量和对应的处理器
package org.activiti.engine.impl.event.logger;

public class EventLogger implements ActivitiEventListener {
	protected void initializeDefaultHandlers() {
	  addEventHandler(ActivitiEventType.TASK_CREATED, TaskCreatedEventHandler.class);
		addEventHandler(ActivitiEventType.TASK_COMPLETED, TaskCompletedEventHandler.class);
		addEventHandler(ActivitiEventType.TASK_ASSIGNED, TaskAssignedEventHandler.class);
		
		addEventHandler(ActivitiEventType.SEQUENCEFLOW_TAKEN, SequenceFlowTakenEventHandler.class);
		
		addEventHandler(ActivitiEventType.ACTIVITY_COMPLETED, ActivityCompletedEventHandler.class);
		addEventHandler(ActivitiEventType.ACTIVITY_STARTED, ActivityStartedEventHandler.class);
		addEventHandler(ActivitiEventType.ACTIVITY_SIGNALED, ActivitySignaledEventHandler.class);
		addEventHandler(ActivitiEventType.ACTIVITY_MESSAGE_RECEIVED, ActivityMessageEventHandler.class);
		addEventHandler(ActivitiEventType.ACTIVITY_COMPENSATE, ActivityCompensatedEventHandler.class);
		addEventHandler(ActivitiEventType.ACTIVITY_ERROR_RECEIVED, ActivityErrorReceivedEventHandler.class);
		
		addEventHandler(ActivitiEventType.VARIABLE_CREATED, VariableCreatedEventHandler.class);
		addEventHandler(ActivitiEventType.VARIABLE_DELETED, VariableDeletedEventHandler.class);
		addEventHandler(ActivitiEventType.VARIABLE_UPDATED, VariableUpdatedEventHandler.class);
  	}
	
	@Override
	public void onEvent(ActivitiEvent event) {
		EventLoggerEventHandler eventHandler = getEventHandler(event);
		if (eventHandler != null) {

			// 当命令行上下文关闭时事件才刷新
			CommandContext currentCommandContext = Context.getCommandContext();
			EventFlusher eventFlusher = (EventFlusher) currentCommandContext.getAttribute(EVENT_FLUSHER_KEY);
			
			if (eventFlusher == null) {
				
				eventFlusher = createEventFlusher();
				if (eventFlusher == null) {
					// 默认写入数据库
					eventFlusher = new DatabaseEventFlusher(); 
				}
				currentCommandContext.addAttribute(EVENT_FLUSHER_KEY, eventFlusher);
				
				currentCommandContext.addCloseListener(eventFlusher);
				currentCommandContext
				    .addCloseListener(new CommandContextCloseListener() {

					    @Override
					    public void closing(CommandContext commandContext) {
					    }

					    @Override
					    public void closed(CommandContext commandContext) {
						    // 关闭时广播事件并记录日志
								if (listeners != null) {
									for (EventLoggerListener listener : listeners) {
										listener.eventsAdded(EventLogger.this);
									}
								}
					    }

              public void afterSessionsFlush(CommandContext commandContext) {
              }

              @Override
              public void closeFailure(CommandContext commandContext) {
              }
					    
				    });
			}

			eventFlusher.addEventHandler(eventHandler);
		}
	}
}

不同的事件监听的内容不同，以TaskCreatedEventHandler为例
package org.activiti.engine.impl.event.logger.handler;

public class TaskCreatedEventHandler extends AbstractTaskEventHandler {

	@Override
	public EventLogEntryEntity generateEventLogEntry(CommandContext commandContext) {
	  TaskEntity task = (TaskEntity) ((ActivitiEntityEvent) event).getEntity();
	  Map&amp;lt;String, Object&amp;gt; data = handleCommonTaskFields(task);
	  // 需要写入数据库的信息
	  return createEventLogEntry(task.getProcessDefinitionId(), task.getProcessInstanceId(), task.getExecutionId(), task.getId(), data);
	}

}


数据库写入逻辑
package org.activiti.engine.impl.event.logger;

public class DatabaseEventFlusher extends AbstractEventFlusher {

  private static final Logger logger = LoggerFactory.getLogger(DatabaseEventFlusher.class);

  @Override
  public void closing(CommandContext commandContext) {
    
    if (commandContext.getException() != null) {
      return;
    }
    
    EventLogEntryEntityManager eventLogEntryEntityManager = commandContext.getEventLogEntryEntityManager();
    for (EventLoggerEventHandler eventHandler : eventHandlers) {
      try {
        eventLogEntryEntityManager.insert(eventHandler.generateEventLogEntry(commandContext), false);
      } catch (Exception e) {
        logger.warn(&amp;quot;Could not create event log&amp;quot;, e);
      }
    }
  }
  public void afterSessionsFlush(CommandContext commandContext) {}
  public void closeFailure(CommandContext commandContext) {}
}


                                        </div>
                                        
                                            <a class="btn btn-text" href="https://fjiayang.github.io//post/activiti-xue-xi-bi-ji">Read More ~</a>
                            </div>
                </div>
            </article>
            
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://fjiayang.github.io//post/she-ji-mo-shi-yuan-ze">
                        设计模式——原则
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2020-01-22</time>
                    
                </div>
                <div class="post-article">
                    
                            <div class="post-content">
                                
                                    <div class="post-content-abstract">
                                        <h2 id="开闭原则">开闭原则</h2>
<h3 id="介绍">介绍</h3>
<p>定义：一个软件实体如类、模块和函数应该对扩展开放,对修改关闭</p>
<p>用抽象构建框架,用实现扩展细节</p>
<p>优点：提高软件系统的可复用性及可维护性</p>

                                    </div>
                                    
                                            <a class="btn btn-text" href="https://fjiayang.github.io//post/she-ji-mo-shi-yuan-ze">Read More ~</a>
                            </div>
                </div>
            </article>
            
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://fjiayang.github.io//post/k8s-huan-jing-xia-gitlabhelmgitlab-runner-java-xiang-mu-cicd-luo-di-shi-jian">
                        k8s环境下GitLab+Helm+GitLab Runner Java项目CICD落地实践
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2019-11-27</time>
                    
                        <a href="https://fjiayang.github.io//tag/XZTzL_2aJ" class="post-tag i-tag
                            i-tag-success">
            #CICD
        </a>
                        
                        <a href="https://fjiayang.github.io//tag/3x3ut1pT9" class="post-tag i-tag
                            i-tag-other_1">
            #GitLab
        </a>
                        
                        <a href="https://fjiayang.github.io//tag/yb4HlP89R" class="post-tag i-tag
                            i-tag-info">
            #Kubernetes
        </a>
                        
                        <a href="https://fjiayang.github.io//tag/kTPZcu1_NZ" class="post-tag i-tag
                            i-tag-error">
            #Docker
        </a>
                        
                </div>
                <div class="post-article">
                    
                        <a href="https://fjiayang.github.io//post/k8s-huan-jing-xia-gitlabhelmgitlab-runner-java-xiang-mu-cicd-luo-di-shi-jian" class="post-feature-image" style="background-image:url(https://s2.ax1x.com/2019/11/27/Qpybmn.png) ">
                        </a>
                        
                            <div class="post-content">
                                
                                    <div class="post-content-abstract">
                                        <h2 id="背景">背景</h2>
<p>目前使用5台服务器搭建了<code>Kubernetes</code>集群环境，监控、日志采集均已落地，业务也手工迁移到集群中顺利运行，故需要将原本基于原生<code>docker</code>环境的CICD流程迁移到<code>Kubernetes</code>集群中</p>

                                    </div>
                                    
                                            <a class="btn btn-text" href="https://fjiayang.github.io//post/k8s-huan-jing-xia-gitlabhelmgitlab-runner-java-xiang-mu-cicd-luo-di-shi-jian">Read More ~</a>
                            </div>
                </div>
            </article>
            
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://fjiayang.github.io//post/k8s-gong-xiang-cun-chu-yi-ji-redis-gao-ke-yong-ji-qun-kuai-su-da-jian">
                        k8s共享存储以及Redis高可用集群快速搭建
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2019-11-20</time>
                    
                        <a href="https://fjiayang.github.io//tag/4QCDLcnCA" class="post-tag i-tag
                            i-tag-banana">
            #Redis
        </a>
                        
                        <a href="https://fjiayang.github.io//tag/yb4HlP89R" class="post-tag i-tag
                            i-tag-success">
            #Kubernetes
        </a>
                        
                        <a href="https://fjiayang.github.io//tag/kTPZcu1_NZ" class="post-tag i-tag
                            i-tag-warning">
            #Docker
        </a>
                        
                </div>
                <div class="post-article">
                    
                        <a href="https://fjiayang.github.io//post/k8s-gong-xiang-cun-chu-yi-ji-redis-gao-ke-yong-ji-qun-kuai-su-da-jian" class="post-feature-image" style="background-image:url(https://s2.ax1x.com/2019/11/27/QC2YcT.png) ">
                        </a>
                        
                            <div class="post-content">
                                
                                    <div class="post-content-abstract">
                                        <h2 id="介绍">介绍</h2>
<p><code>StorageClass</code> 为管理员提供了描述存储 <code>&quot;类&quot;</code> 的方法。 不同的<code>类型</code>可能会映射到不同的服务质量等级或备份策略，通常由运维制定的任意策略</p>

                                    </div>
                                    
                                            <a class="btn btn-text" href="https://fjiayang.github.io//post/k8s-gong-xiang-cun-chu-yi-ji-redis-gao-ke-yong-ji-qun-kuai-su-da-jian">Read More ~</a>
                            </div>
                </div>
            </article>
            
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://fjiayang.github.io//post/k8s-jian-kong-ping-tai-da-jian">
                        k8s监控平台搭建
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2019-11-12</time>
                    
                        <a href="https://fjiayang.github.io//tag/fqFQhLkmu" class="post-tag i-tag
                            i-tag-banana">
            #Prometheus
        </a>
                        
                        <a href="https://fjiayang.github.io//tag/oND4YSSBh1" class="post-tag i-tag
                            i-tag-banana">
            #Grafana
        </a>
                        
                        <a href="https://fjiayang.github.io//tag/yb4HlP89R" class="post-tag i-tag
                            i-tag-other_2">
            #Kubernetes
        </a>
                        
                        <a href="https://fjiayang.github.io//tag/kTPZcu1_NZ" class="post-tag i-tag
                            i-tag-other_4">
            #Docker
        </a>
                        
                </div>
                <div class="post-article">
                    
                            <div class="post-content">
                                
                                    <div class="post-content-abstract">
                                        <h2 id="架构">架构</h2>
<p>目前主流容器化监控平台采用<code>Prometheus</code>+<code>Grafana</code>架构，下图为<code>Prometheus</code>架构图，可以主动发现各种指标和采集数据，实现</p>

                                    </div>
                                    
                                            <a class="btn btn-text" href="https://fjiayang.github.io//post/k8s-jian-kong-ping-tai-da-jian">Read More ~</a>
                            </div>
                </div>
            </article>
            
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://fjiayang.github.io//post/gitlab-api-shi-yong">
                        GitLab Api使用
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2019-11-06</time>
                    
                        <a href="https://fjiayang.github.io//tag/3x3ut1pT9" class="post-tag i-tag
                            i-tag-other_1">
            #GitLab
        </a>
                        
                </div>
                <div class="post-article">
                    
                            <div class="post-content">
                                
                                    <div class="post-content-abstract">
                                        <h2 id="使用场景">使用场景</h2>
<p>为了进行规范化配置管理工作，基于<code>gitlab</code>规范分支管理流程，经常需要新建分支、设置保护分支和操作分支封板等，若只有几个工程则直接在<code>gitlab</code> web界面上操作即可，一旦工程数量增多，则会消耗大量时间，故考虑可通过<code>gitlab</code>提供的web <code>api</code>编写脚本进行自动化操作</p>

                                    </div>
                                    
                                            <a class="btn btn-text" href="https://fjiayang.github.io//post/gitlab-api-shi-yong">Read More ~</a>
                            </div>
                </div>
            </article>
            
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://fjiayang.github.io//post/kubernetes-ji-chu-ming-ling-xue-xi">
                        Kubernetes基础命令学习
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2019-10-20</time>
                    
                        <a href="https://fjiayang.github.io//tag/VwGnvPo1M" class="post-tag i-tag
                            i-tag-">
            #学习
        </a>
                        
                        <a href="https://fjiayang.github.io//tag/yb4HlP89R" class="post-tag i-tag
                            i-tag-warning">
            #Kubernetes
        </a>
                        
                </div>
                <div class="post-article">
                    
                        <a href="https://fjiayang.github.io//post/kubernetes-ji-chu-ming-ling-xue-xi" class="post-feature-image" style="background-image:url(https://s2.ax1x.com/2019/11/27/QC2UuF.png) ">
                        </a>
                        
                            <div class="post-content">
                                
                                    <div class="post-content-abstract">
                                        <h2 id="配置命令语法提示">配置命令语法提示</h2>
<p>执行命令查看指南</p>

                                    </div>
                                    
                                            <a class="btn btn-text" href="https://fjiayang.github.io//post/kubernetes-ji-chu-ming-ling-xue-xi">Read More ~</a>
                            </div>
                </div>
            </article>
            
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://fjiayang.github.io//post/kubernetes-ji-qun-da-jian">
                        Kubernetes 集群搭建
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2019-10-20</time>
                    
                        <a href="https://fjiayang.github.io//tag/yb4HlP89R" class="post-tag i-tag
                            i-tag-other_3">
            #Kubernetes
        </a>
                        
                        <a href="https://fjiayang.github.io//tag/kTPZcu1_NZ" class="post-tag i-tag
                            i-tag-success">
            #Docker
        </a>
                        
                        <a href="https://fjiayang.github.io//tag/rjmWDGdyvm" class="post-tag i-tag
                            i-tag-other_2">
            #集群
        </a>
                        
                </div>
                <div class="post-article">
                    
                        <a href="https://fjiayang.github.io//post/kubernetes-ji-qun-da-jian" class="post-feature-image" style="background-image:url(https://s2.ax1x.com/2019/11/27/QCRTo9.jpg) ">
                        </a>
                        
                            <div class="post-content">
                                
                                    <div class="post-content-abstract">
                                        <h2 id="搭建方法分类">搭建方法分类</h2>
<p>如果是搭建<code>Kubernetes</code>的学习环境，则可以直接使用<code>minikube</code>快速搭建单节点的<code>Kubernetes</code>环境，官方推荐使用kubeadm搭建<code>Kubernetes</code>集群生产环境</p>

                                    </div>
                                    
                                            <a class="btn btn-text" href="https://fjiayang.github.io//post/kubernetes-ji-qun-da-jian">Read More ~</a>
                            </div>
                </div>
            </article>
            
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://fjiayang.github.io//post/elasticsearch-docker-gao-ke-yong-huan-jing-da-jian">
                        Elasticsearch Docker高可用环境搭建
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2019-09-10</time>
                    
                        <a href="https://fjiayang.github.io//tag/8HTQ1PMKf" class="post-tag i-tag
                            i-tag-other_4">
            #elasticsearch
        </a>
                        
                        <a href="https://fjiayang.github.io//tag/kTPZcu1_NZ" class="post-tag i-tag
                            i-tag-other_1">
            #Docker
        </a>
                        
                </div>
                <div class="post-article">
                    
                            <div class="post-content">
                                
                                    <div class="post-content-abstract">
                                        <h2 id="介绍">介绍</h2>
<p>作为Elastic Stack 的核心，Elasticsearch 是一个分布式、RESTful 风格的搜索和数据分析引擎，本次主要用于存储业务数据和基于业务日志进行数据统计分析。</p>

                                    </div>
                                    
                                            <a class="btn btn-text" href="https://fjiayang.github.io//post/elasticsearch-docker-gao-ke-yong-huan-jing-da-jian">Read More ~</a>
                            </div>
                </div>
            </article>
            
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://fjiayang.github.io//post/ji-yu-mesosmarathon-de-devops-fen-bu-shi-huan-jing-da-jian">
                        基于Mesos+Marathon的DevOps分布式环境搭建
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2019-08-18</time>
                    
                        <a href="https://fjiayang.github.io//tag/xTpEEjjmQ" class="post-tag i-tag
                            i-tag-banana">
            #mesos
        </a>
                        
                        <a href="https://fjiayang.github.io//tag/tAci1rZfHp" class="post-tag i-tag
                            i-tag-error">
            #DevOps
        </a>
                        
                        <a href="https://fjiayang.github.io//tag/FZ58cYbuWL" class="post-tag i-tag
                            i-tag-info">
            #marathon
        </a>
                        
                        <a href="https://fjiayang.github.io//tag/6peMWxmLrM" class="post-tag i-tag
                            i-tag-warning">
            #vmware
        </a>
                        
                        <a href="https://fjiayang.github.io//tag/DykPrKp3oQ" class="post-tag i-tag
                            i-tag-primary">
            #zookeeper
        </a>
                        
                        <a href="https://fjiayang.github.io//tag/kTPZcu1_NZ" class="post-tag i-tag
                            i-tag-other_3">
            #Docker
        </a>
                        
                </div>
                <div class="post-article">
                    
                            <div class="post-content">
                                
                                    <div class="post-content-abstract">
                                        <h2 id="基础环境">基础环境</h2>
<p>本地准备了4台虚拟机配置如下</p>

                                    </div>
                                    
                                            <a class="btn btn-text" href="https://fjiayang.github.io//post/ji-yu-mesosmarathon-de-devops-fen-bu-shi-huan-jing-da-jian">Read More ~</a>
                            </div>
                </div>
            </article>
            
                <!-- 翻页 -->
                
    <div class="pagination-container">
        
                
                    <a href="https://fjiayang.github.io//page/2/" class="page-btn btn">下一页</a>
                    
    </div>
    
                </div>
                <!--  -->
                <div class="main-container-middle"></div>
                <!--  -->
                <div id="sidebar" class="main-container-right">

                    <!-- 个人信息 -->
                    
    <div class="id_card i-card">
        <div class="id_card-avatar" style="background-image: url(https://fjiayang.github.io//images/avatar.png?v=1579679926111)">
        </div>
        <h1 class="id_card-title">
            F嘉阳
        </h1>
        <h2 class="id_card-description">
            愿你被世界温柔以待
        </h2>
        <!--  -->
        <div class="id_card-sns">
            <!-- github -->
            
                    <!-- twitter -->
                    
                            <!-- weibo -->
                            
                                <a href="https://weibo.com/2007780675" target="_blank" rel="noopener noreferrer"><i
                class="fa fa-weibo"></i></a>
                                
                                    <!-- facebook -->
                                    

        </div>
    </div>
    

                        <!-- 公告栏 -->
                        
    <div class="notice-card i-card ">
        <div class="notice-title i-card-title">公告</div>
        <div class="notice-content">
            主博客：https://blog.fjy8018.top/
        </div>
    </div>
    

                </div>
            </div>



            <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | <a href="https://blog.fjy8018.top/" target="_blank">F嘉阳 博客</a> | 
  <a class="rss" href="https://fjiayang.github.io//atom.xml" target="_blank">RSS</a>
</div>

<script>
  hljs.initHighlightingOnLoad()
</script>

    </div>
    <script>
        $('#sidebar').stickySidebar({
            topSpacing: 80,
            // bottomSpacing: 60
        });
    </script>
</body>

</html>